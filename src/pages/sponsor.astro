---
export const prerender = false;
import Markdown from "@/components/misc/Markdown.astro";
import Icon from "@/components/misc/Icon.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { fetchSiteSettings } from "@/services/siteSettings";
import { getApiUrl } from "@/utils/api-utils";
import { parseApiResponse } from "@/utils/api-response";
import { marked, Renderer } from "marked";

const API_URL = getApiUrl();

// 获取动态配置
let dynamicSettings: Record<string, any> = {};
try {
	dynamicSettings = await fetchSiteSettings();
} catch (error) {
	console.warn("无法获取动态配置，使用静态配置");
}

// 检查页面是否启用（动态配置优先）
const pageEnabled = dynamicSettings.page_sponsor ?? siteConfig.pages.sponsor;
if (!pageEnabled) {
	return Astro.redirect("/404");
}

const title = i18n(I18nKey.sponsorTitle);
const description = i18n(I18nKey.sponsorDescription);

// sponsor 文章内容，默认为提示信息
let sponsorContent =
	"# 赞助\n\n暂无内容，请在后台创建 slug 为 `sponsor` 的文章来自定义本页内容。";
let renderedContent = "";

try {
	const response = await fetch(`${API_URL}/posts/slug/sponsor`);
	if (response.ok) {
		const payload = await parseApiResponse(response);
		const post = payload.data;
		sponsorContent = post?.content || sponsorContent;
	}
} catch (error) {
	console.error("Failed to load sponsor page:", error);
}

// 与 about 页面一致的标题 slug 生成逻辑，确保锚点可用
const slugCount: Record<string, number> = {};
function generateSlug(text: string): string {
	let slug = text
		.toLowerCase()
		.replace(/[^\w\u4e00-\u9fa5\s-]/g, "")
		.replace(/\s+/g, "-")
		.replace(/-+/g, "-");

	if (slugCount[slug]) {
		slugCount[slug]++;
		slug = `${slug}-${slugCount[slug] - 1}`;
	} else {
		slugCount[slug] = 1;
	}

	return slug;
}

const renderer = new Renderer();
renderer.heading = function ({ tokens, depth }) {
	const text = this.parser.parseInline(tokens);
	const plainText = text.replace(/<[^>]*>/g, "");
	const slug = generateSlug(plainText);
	return `<h${depth} id="${slug}">${text}</h${depth}>\n`;
};

marked.use({ renderer });
renderedContent = await marked.parse(sponsorContent);
---

<MainGridLayout title={title} description={description}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题和描述 -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-3">
          <div class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70">
            <Icon icon="material-symbols:favorite" class="text-[1.5rem]"></Icon>
          </div>
          <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
            {title}
          </h1>
        </div>
        {description && (
          <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
            {description}
          </p>
        )}
      </div>

      <Markdown class="mt-2 markdown-content">
        <div set:html={renderedContent} />
      </Markdown>
    </div>
  </div>
</MainGridLayout>
