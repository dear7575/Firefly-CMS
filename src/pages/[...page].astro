---
import Pagination from "@/components/common/controls/Pagination.astro";
import PostPage from "@/components/layout/PostPage.astro";
import { siteConfig } from "@/config";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { getSortedPosts } from "@/utils/content-utils";
import { fetchSiteSettings } from "@/services/siteSettings";

export const prerender = false;

// 获取动态配置
let dynamicSettings: Record<string, any> = {};
try {
  dynamicSettings = await fetchSiteSettings();
} catch (error) {
  console.warn("无法获取动态配置，使用静态配置");
}

const { page: pageParam } = Astro.params;
const allBlogPosts = await getSortedPosts();
// 优先使用动态配置的分页数，否则使用静态配置
const pageSize = dynamicSettings.post_per_page || siteConfig.pagination.postsPerPage;
const totalPages = Math.ceil(allBlogPosts.length / pageSize);

// 文章列表布局配置（动态配置优先）
const defaultLayout = dynamicSettings.post_default_layout || siteConfig.postListLayout?.defaultMode || 'list';
const allowSwitchLayout = dynamicSettings.post_allow_switch_layout ?? siteConfig.postListLayout?.allowSwitch ?? true;
const gridMasonry = dynamicSettings.post_grid_masonry ?? siteConfig.postListLayout?.grid?.masonry ?? true;

// 验证页码参数
let currentPage = 1;
if (pageParam) {
  // 检查是否为纯数字
  if (!/^\d+$/.test(pageParam)) {
    // 非数字路径，返回 404
    return new Response(null, { status: 404, statusText: 'Not Found' });
  }
  currentPage = parseInt(pageParam);
  // 检查页码是否在有效范围内
  if (currentPage < 1 || currentPage > totalPages) {
    return new Response(null, { status: 404, statusText: 'Not Found' });
  }
  // 第一页应该访问根路径
  if (currentPage === 1) {
    return Astro.redirect("/", 301);
  }
}

const start = (currentPage - 1) * pageSize;
const end = start + pageSize;
const postsOnPage = allBlogPosts.slice(start, end);

const page = {
  data: postsOnPage,
  start: start,
  end: end - 1,
  total: allBlogPosts.length,
  currentPage: currentPage,
  size: pageSize,
  lastPage: totalPages,
  url: {
    current: Astro.url.pathname,
    prev:
      currentPage > 1
        ? currentPage === 2
          ? "/"
          : `/${currentPage - 1}`
        : undefined,
    next: currentPage < totalPages ? `/${currentPage + 1}` : undefined,
    first: "/",
    last: totalPages > 1 ? `/${totalPages}` : "/",
  },
};

const len = page.data.length;
---

<MainGridLayout>
  <PostPage page={page} defaultLayout={defaultLayout} allowSwitchLayout={allowSwitchLayout} gridMasonry={gridMasonry} />
  {
    page.total > page.size && (
      <Pagination
        class="mx-auto onload-animation"
        page={page}
        style={`animation-delay: calc(var(--content-delay) + ${len * 50}ms)`}
      />
    )
  }
</MainGridLayout>

<script>
  // 响应式分页处理脚本
  document.addEventListener("DOMContentLoaded", function () {
    // 如果启用了响应式分页，添加相应的CSS类
    const responsiveEnabled = true; // ${siteConfig.pagination.responsive}
    if (responsiveEnabled) {
      const deviceType = getDeviceType();
      document.body.classList.add(`device-${deviceType}`);

      // 监听窗口大小变化
      let resizeTimeout: any;
      window.addEventListener("resize", function () {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function () {
          const newDeviceType = getDeviceType();
          const currentDeviceType = document.body.className.match(
            /device-(mobile|tablet|desktop)/,
          )?.[1];

          if (currentDeviceType !== newDeviceType) {
            document.body.classList.remove(`device-${currentDeviceType}`);
            document.body.classList.add(`device-${newDeviceType}`);
          }
        }, 250);
      });
    }
  });

  function getDeviceType() {
    if (typeof window === "undefined") return "desktop";

    const width = window.innerWidth;
    if (width < 768) return "mobile";
    if (width < 1024) return "tablet";
    return "desktop";
  }
</script>
