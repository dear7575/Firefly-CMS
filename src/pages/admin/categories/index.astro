---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
const API_URL = import.meta.env.PUBLIC_API_URL;
---

<AdminLayout title={`${i18n(I18nKey.adminCategoryManagement)} - ${siteConfig.title}`} activeMenu="categories">
    <div class="p-6 lg:p-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">{i18n(I18nKey.adminCategoryManagement)}</h1>
                <p class="text-sm text-zinc-500 mt-1">{i18n(I18nKey.adminManageBlogCategories)}</p>
            </div>
            <button
                id="addCategoryBtn"
                class="bg-[var(--primary)] dark:bg-zinc-800 hover:opacity-90 dark:hover:bg-zinc-700 text-white dark:text-zinc-100 px-6 py-2.5 rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                {i18n(I18nKey.adminAdd)} {i18n(I18nKey.categories)}
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categoriesGrid">
            <div class="col-span-full text-center py-12 text-zinc-500">{i18n(I18nKey.adminLoading)}</div>
        </div>
    </div>

    <!-- Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-zinc-200 dark:border-zinc-800">
                <h2 id="modalTitle" class="text-xl font-bold text-zinc-900 dark:text-zinc-100">{i18n(I18nKey.adminAdd)} {i18n(I18nKey.categories)}</h2>
            </div>
            <form id="categoryForm" class="p-6 space-y-4">
                <input type="hidden" id="categoryId" />
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">{i18n(I18nKey.adminName)} *</label>
                    <input type="text" id="categoryName" required class="modal-input" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">{i18n(I18nKey.adminSlug)}</label>
                    <input type="text" id="categorySlug" class="modal-input" placeholder={i18n(I18nKey.adminAutoGenerated)} />
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">{i18n(I18nKey.adminDescription)}</label>
                    <textarea id="categoryDescription" rows="2" class="modal-input resize-none"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">{i18n(I18nKey.adminColor)}</label>
                        <input type="color" id="categoryColor" value="#6366f1" class="w-full h-10 rounded-xl border border-zinc-200 dark:border-zinc-700/50 cursor-pointer transition-all hover:border-zinc-300 dark:hover:border-zinc-600" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">{i18n(I18nKey.adminSortOrder)}</label>
                        <input type="number" id="categorySortOrder" value="0" class="modal-input" />
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="categoryEnabled" checked class="w-4 h-4 rounded" />
                    <label for="categoryEnabled" class="text-sm text-zinc-700 dark:text-zinc-300">{i18n(I18nKey.adminEnabled)}</label>
                </div>
            </form>
            <div class="p-6 border-t border-zinc-200 dark:border-zinc-800 flex justify-end gap-3">
                <button type="button" id="cancelBtn" class="px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors">{i18n(I18nKey.adminCancel)}</button>
                <button type="submit" form="categoryForm" class="px-6 py-2 bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 rounded-lg hover:opacity-90 dark:hover:bg-zinc-700 transition-colors dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]">{i18n(I18nKey.adminSave)}</button>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline>
(function() {
    var categories = [];

    var t = window.adminI18n || {};

    async function loadCategories() {
        var grid = document.getElementById('categoriesGrid');
        if (!grid) return; // 不在 categories 页面，直接返回

        try {
            var response = await fetch(`${API_URL}/categories`);
            if (!response.ok) throw new Error('Failed to load');
            categories = await response.json();

            if (categories.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-zinc-500">' + t.noCategoriesYet + '</div>';
                return;
            }

            grid.innerHTML = categories.map(function(cat) {
                var color = cat.color || '#6366f1';
                var statusClass = cat.enabled ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400' : 'bg-zinc-100 dark:bg-zinc-800 text-zinc-500';
                var statusText = cat.enabled ? t.active : t.disabled;
                var descHtml = cat.description ? '<p class="text-sm text-zinc-500 mb-3 line-clamp-2">' + cat.description + '</p>' : '';
                var nameEscaped = cat.name.replace(/'/g, "\\'");

                return '<div class="bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200 dark:border-zinc-800 p-5 hover:shadow-lg transition-all">' +
                    '<div class="flex items-start justify-between mb-3">' +
                        '<div class="flex items-center gap-3">' +
                            '<div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background-color: ' + color + '20">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" style="color: ' + color + '" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />' +
                                '</svg>' +
                            '</div>' +
                            '<div>' +
                                '<h3 class="font-semibold text-zinc-900 dark:text-zinc-100">' + cat.name + '</h3>' +
                                '<p class="text-xs text-zinc-500">' + (cat.slug || '') + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<span class="px-2 py-1 text-xs rounded-full ' + statusClass + '">' + statusText + '</span>' +
                    '</div>' +
                    descHtml +
                    '<div class="flex items-center justify-between pt-3 border-t border-zinc-100 dark:border-zinc-800">' +
                        '<span class="text-sm text-zinc-500">' + cat.post_count + ' ' + t.posts + '</span>' +
                        '<div class="flex gap-2">' +
                            '<button onclick="editCategory(\'' + cat.id + '\')" class="p-2 text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />' +
                                '</svg>' +
                            '</button>' +
                            '<button onclick="deleteCategory(\'' + cat.id + '\', \'' + nameEscaped + '\')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />' +
                                '</svg>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        } catch (err) {
            console.error(err);
            if (grid) grid.innerHTML = '<div class="col-span-full text-center py-12 text-red-500">' + t.categoryLoadFailed + '</div>';
        }
    }

    function showModal(isEdit) {
        var modalTitle = document.getElementById('modalTitle');
        var categoryModal = document.getElementById('categoryModal');
        if (modalTitle) {
            var addText = (t.add || 'Add') + ' ' + (t.categories || 'Category');
            var editText = (t.edit || 'Edit') + ' ' + (t.categories || 'Category');
            modalTitle.textContent = isEdit ? editText : addText;
        }
        if (categoryModal) {
            categoryModal.classList.remove('hidden');
            categoryModal.classList.add('flex');
        }
    }

    function hideModal() {
        var categoryModal = document.getElementById('categoryModal');
        var categoryForm = document.getElementById('categoryForm');
        var categoryId = document.getElementById('categoryId');
        if (categoryModal) {
            categoryModal.classList.add('hidden');
            categoryModal.classList.remove('flex');
        }
        if (categoryForm) categoryForm.reset();
        if (categoryId) categoryId.value = '';
    }

    window.editCategory = function(id) {
        var cat = categories.find(function(c) { return c.id === id; });
        if (!cat) return;

        var categoryIdEl = document.getElementById('categoryId');
        var categoryNameEl = document.getElementById('categoryName');
        var categorySlugEl = document.getElementById('categorySlug');
        var categoryDescriptionEl = document.getElementById('categoryDescription');
        var categoryColorEl = document.getElementById('categoryColor');
        var categorySortOrderEl = document.getElementById('categorySortOrder');
        var categoryEnabledEl = document.getElementById('categoryEnabled');

        if (categoryIdEl) categoryIdEl.value = cat.id;
        if (categoryNameEl) categoryNameEl.value = cat.name;
        if (categorySlugEl) categorySlugEl.value = cat.slug || '';
        if (categoryDescriptionEl) categoryDescriptionEl.value = cat.description || '';
        if (categoryColorEl) categoryColorEl.value = cat.color || '#6366f1';
        if (categorySortOrderEl) categorySortOrderEl.value = cat.sort_order || 0;
        if (categoryEnabledEl) categoryEnabledEl.checked = cat.enabled;

        showModal(true);
    };

    window.deleteCategory = async function(id, name) {
        var confirmMsg = (t.confirmDeleteCategory || 'Delete category "{name}"?').replace('{name}', name);
        if (!confirm(confirmMsg)) return;

        try {
            var response = await fetch(API_URL + '/categories/' + id, {
                method: 'DELETE',
                headers: { Authorization: 'Bearer ' + localStorage.getItem('adminToken') }
            });

            if (response.ok) {
                loadCategories();
            } else {
                var err = await response.json();
                alert(err.detail || t.deleteFailed || 'Delete failed');
            }
        } catch (err) {
            alert(t.deleteFailed || 'Delete failed');
        }
    };

    var addCategoryBtn = document.getElementById('addCategoryBtn');
    var cancelBtn = document.getElementById('cancelBtn');
    var categoryModal = document.getElementById('categoryModal');
    var categoryForm = document.getElementById('categoryForm');

    if (addCategoryBtn) addCategoryBtn.addEventListener('click', function() { showModal(false); });
    if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
    if (categoryModal) {
        categoryModal.addEventListener('click', function(e) {
            if (e.target === e.currentTarget) hideModal();
        });
    }

    if (categoryForm) {
        categoryForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            var categoryIdEl = document.getElementById('categoryId');
            var categoryNameEl = document.getElementById('categoryName');
            var categorySlugEl = document.getElementById('categorySlug');
            var categoryDescriptionEl = document.getElementById('categoryDescription');
            var categoryColorEl = document.getElementById('categoryColor');
            var categorySortOrderEl = document.getElementById('categorySortOrder');
            var categoryEnabledEl = document.getElementById('categoryEnabled');

            var id = categoryIdEl ? categoryIdEl.value : '';
            var data = {
                name: categoryNameEl ? categoryNameEl.value : '',
                slug: categorySlugEl ? categorySlugEl.value || undefined : undefined,
                description: categoryDescriptionEl ? categoryDescriptionEl.value || undefined : undefined,
                color: categoryColorEl ? categoryColorEl.value : '#6366f1',
                sort_order: categorySortOrderEl ? parseInt(categorySortOrderEl.value) || 0 : 0,
                enabled: categoryEnabledEl ? categoryEnabledEl.checked : true
            };

            try {
                var response = await fetch(API_URL + '/categories/' + (id || ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    hideModal();
                    loadCategories();
                } else {
                    var err = await response.json();
                    alert(err.detail || t.saveFailed || 'Save failed');
                }
            } catch (err) {
                alert(t.saveFailed || 'Save failed');
            }
        });
    }

    loadCategories();
})();
</script>

<style>
    .modal-input {
        @apply w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700/50 bg-white/80 dark:bg-zinc-800/80 text-zinc-900 dark:text-zinc-100 outline-none transition-all duration-300 placeholder:text-zinc-400 dark:placeholder:text-zinc-500;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
    }

    .modal-input:hover {
        @apply border-zinc-300 dark:border-zinc-600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .modal-input:focus {
        @apply border-indigo-400 dark:border-indigo-500/70 ring-4 ring-indigo-500/10 dark:ring-indigo-500/20;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    :global(.dark) .modal-input:focus {
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15), 0 0 20px rgba(99, 102, 241, 0.2);
    }

    input[type="number"].modal-input {
        -moz-appearance: textfield;
    }

    input[type="number"].modal-input::-webkit-outer-spin-button,
    input[type="number"].modal-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>
