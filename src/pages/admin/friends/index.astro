---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();
---

<AdminLayout
    title={`${i18n(I18nKey.adminFriendManagement)} - ${siteConfig.title}`}
    activeMenu="friends"
>
    <div class="p-6 lg:p-8">
        <div
            class="flex items-center justify-between gap-3 mb-6"
        >
            <div class="min-w-0">
                <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">
                    {i18n(I18nKey.adminFriendManagement)}
                </h1>
                <p class="text-sm text-zinc-500 mt-1">
                    {i18n(I18nKey.adminManageFriendLinks)}
                </p>
            </div>
            <button
                id="addFriendBtn"
                class="bg-[var(--primary)] dark:bg-zinc-800 hover:opacity-90 dark:hover:bg-zinc-700 text-white dark:text-zinc-100 px-6 py-2.5 rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)] flex-shrink-0"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                >
                    <path
                        fill-rule="evenodd"
                        d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                        clip-rule="evenodd"></path>
                </svg>
                {i18n(I18nKey.adminAdd)}
                {i18n(I18nKey.friends)}
            </button>
        </div>

        <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            id="friendsGrid"
        >
            <div class="col-span-full text-center py-12 text-zinc-500">
                {i18n(I18nKey.adminLoading)}
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div
        id="friendModal"
        class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    >
        <div
            class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-lg shadow-2xl max-h-[90vh] flex flex-col"
        >
            <div
                class="p-6 border-b border-zinc-200 dark:border-zinc-800 flex-shrink-0"
            >
                <h2
                    id="modalTitle"
                    class="text-xl font-bold text-zinc-900 dark:text-zinc-100"
                >
                    {i18n(I18nKey.adminAdd)}
                    {i18n(I18nKey.friends)}
                </h2>
            </div>
            <form
                id="friendForm"
                class="p-6 space-y-4 overflow-y-auto flex-1 custom-scrollbar"
            >
                <input type="hidden" id="friendId" />
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.adminName)}
                        <span class="text-red-500">*</span></label
                    >
                    <input
                        type="text"
                        id="friendTitle"
                        required
                        class="modal-input"
                    />
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.rssLink)}
                        <span class="text-red-500">*</span></label
                    >
                    <input
                        type="url"
                        id="friendUrl"
                        required
                        class="modal-input"
                        placeholder="https://"
                    />
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.adminPostImage)}</label
                    >
                    <div class="flex items-center gap-2">
                        <input
                            type="url"
                            id="friendAvatar"
                            class="modal-input flex-1"
                            placeholder="https://"
                        />
                        <button
                            type="button"
                            id="openFriendAvatarPicker"
                            class="h-[46px] px-3 rounded-xl bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 hover:shadow-sm text-zinc-700 dark:text-zinc-300 text-sm font-medium transition-all flex items-center justify-center"
                        >
                            从媒体库
                        </button>
                    </div>
                    <div id="friendAvatarPreview" class="hidden mt-3 w-full rounded-xl overflow-hidden border border-zinc-200 dark:border-zinc-700 bg-zinc-100 dark:bg-zinc-800">
                        <img id="friendAvatarPreviewImg" src="" alt="头像预览" class="w-full max-h-40 object-cover" />
                    </div>
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.adminDescription)}</label
                    >
                    <textarea
                        id="friendDescription"
                        rows="2"
                        class="modal-input resize-none"></textarea>
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.adminPostTags)}</label
                    >
                    <input
                        type="text"
                        id="friendTags"
                        class="modal-input"
                        placeholder={i18n(I18nKey.adminPostTagsPlaceholder)}
                    />
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.adminSortOrder)}</label
                    >
                    <input
                        type="number"
                        id="friendWeight"
                        value="0"
                        class="modal-input"
                    />
                </div>
<div class="flex items-center justify-between">                    <label                        class="text-sm font-medium text-zinc-700 dark:text-zinc-300"                        >{i18n(I18nKey.adminEnabled)}</label                    >                    <div id="friendEnabledToggle" class="toggle-switch active"></div>                    <input                        type="checkbox"                        id="friendEnabled"                        checked                        class="hidden"                    />                </div>
            </form>
            <div
                class="p-6 border-t border-zinc-200 dark:border-zinc-800 flex justify-end gap-3 flex-shrink-0"
            >
                <button
                    type="button"
                    id="cancelBtn"
                    class="px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    >{i18n(I18nKey.adminCancel)}</button
                >
                <button
                    type="submit"
                    form="friendForm"
                    class="px-6 py-2 bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 rounded-lg hover:opacity-90 dark:hover:bg-zinc-700 transition-colors dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]"
                    >{i18n(I18nKey.adminSave)}</button
                >
            </div>
        </div>
    </div>

    <!-- 媒体库选择器 -->
    <div id="mediaPickerModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-5xl border border-zinc-200 dark:border-zinc-800 shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-100">选择图片</h3>
                    <p class="text-xs text-zinc-500">从媒体库选择头像图片</p>
                </div>
                <button id="mediaPickerClose" class="w-9 h-9 rounded-xl bg-zinc-100 dark:bg-zinc-800 text-zinc-500 hover:bg-zinc-200 dark:hover:bg-zinc-700 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 flex flex-col gap-3">
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                    <div class="relative w-full sm:w-72">
                        <input id="mediaPickerSearch" type="text" placeholder="搜索图片..." class="w-full px-4 h-10 pl-10 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 text-sm focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent outline-none transition-all" />
                        <svg class="w-5 h-5 text-zinc-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <div class="text-xs text-zinc-500" id="mediaPickerCount">0</div>
                </div>
                <div id="mediaPickerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 min-h-[240px]">
                    <div class="col-span-full text-center text-sm text-zinc-500 py-10">加载中...</div>
                </div>
                <div class="flex items-center justify-between text-sm text-zinc-500">
                    <button id="mediaPickerPrev" class="px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">上一页</button>
                    <span id="mediaPickerPage">1/1</span>
                    <button id="mediaPickerNext" class="px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">下一页</button>
                </div>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline>
    (function () {
        var friends = [];
        var API_URL = window.API_URL;

        var t = window.adminI18n || {};
        var avatarPickerReady = false;

        setupMediaPicker();

        async function loadFriends() {
            var grid = document.getElementById("friendsGrid");
            if (!grid) return; // 不在 friends 页面，直接返回

            try {
                var result = await window.adminRequest(`${API_URL}/friends`);
                if (!result.ok) throw new Error(result.msg || "加载失败");
                friends = result.data || [];

                if (friends.length === 0) {
                    grid.innerHTML =
                        '<div class="col-span-full text-center py-12 text-zinc-500">' +
                        (t.noFriendsYet || t.empty || "No friend links yet") +
                        "</div>";
                    return;
                }

                grid.innerHTML = friends
                    .map(function (friend) {
                        var avatar =
                            friend.avatar || "/assets/images/avatar.webp";
                        var statusClass = friend.enabled
                            ? "bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400"
                            : "bg-zinc-100 dark:bg-zinc-800 text-zinc-500";
                        var statusText = friend.enabled ? t.active : t.disabled;
                        var descHtml = friend.description
                            ? '<p class="text-sm text-zinc-500 mb-3 line-clamp-2">' +
                              friend.description +
                              "</p>"
                            : "";
                        var tagsHtml = "";
                        if (friend.tags) {
                            var tagItems = friend.tags
                                .split(",")
                                .map(function (tag) {
                                    return (
                                        '<span class="px-2 py-0.5 text-xs bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 rounded">' +
                                        tag.trim() +
                                        "</span>"
                                    );
                                })
                                .join("");
                            tagsHtml =
                                '<div class="flex flex-wrap gap-1 mb-3">' +
                                tagItems +
                                "</div>";
                        }
                        var titleEscaped = friend.title.replace(/'/g, "\\'");

                        return (
                            '<div class="bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200 dark:border-zinc-800 p-5 hover:shadow-lg transition-all">' +
                            '<div class="flex items-start gap-4 mb-3">' +
                            '<img src="' +
                            avatar +
                            '" alt="' +
                            friend.title +
                            '" class="w-12 h-12 rounded-xl object-cover bg-zinc-100 dark:bg-zinc-800" onerror="this.src=\'/assets/images/avatar.webp\'" />' +
                            '<div class="flex-1 min-w-0">' +
                            '<div class="flex items-center gap-2">' +
                            '<h3 class="font-semibold text-zinc-900 dark:text-zinc-100 truncate">' +
                            friend.title +
                            "</h3>" +
                            '<span class="px-2 py-0.5 text-[10px] rounded-full ' +
                            statusClass +
                            '">' +
                            statusText +
                            "</span>" +
                            "</div>" +
                            '<a href="' +
                            friend.url +
                            '" target="_blank" class="text-xs text-zinc-500 hover:text-[var(--primary)] truncate block">' +
                            friend.url +
                            "</a>" +
                            "</div>" +
                            "</div>" +
                            descHtml +
                            tagsHtml +
                            '<div class="flex items-center justify-between pt-3 border-t border-zinc-100 dark:border-zinc-800">' +
                            '<span class="text-xs text-zinc-400">' +
                            (t.sortOrder || "Sort Order") +
                            ": " +
                            friend.weight +
                            "</span>" +
                            '<div class="flex gap-2">' +
                            "<button onclick=\"editFriend('" +
                            friend.id +
                            '\')" class="p-2 text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />' +
                            "</svg>" +
                            "</button>" +
                            "<button onclick=\"deleteFriend('" +
                            friend.id +
                            "', '" +
                            titleEscaped +
                            '\')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />' +
                            "</svg>" +
                            "</button>" +
                            "</div>" +
                            "</div>" +
                            "</div>"
                        );
                    })
                    .join("");
            } catch (err) {
                console.error(err);
                if (grid)
                    grid.innerHTML =
                        '<div class="col-span-full text-center py-12 text-red-500">' +
                        (t.friendLoadFailed ||
                            t.loadFailed ||
                            "Failed to load friend links") +
                        "</div>";
            }
        }

        function showModal(isEdit) {
            var modalTitle = document.getElementById("modalTitle");
            var friendModal = document.getElementById("friendModal");
            if (modalTitle)
                modalTitle.textContent = isEdit
                    ? (t.edit || "Edit") + " " + (t.friends || "Friend")
                    : (t.add || "Add") + " " + (t.friends || "Friend");
            if (friendModal) {
                friendModal.classList.remove("hidden");
                friendModal.classList.add("flex");
            }
            updateAvatarPreview();
        }

        function hideModal() {
            var friendModal = document.getElementById("friendModal");
            var friendForm = document.getElementById("friendForm");
            var friendId = document.getElementById("friendId");
            if (friendModal) {
                friendModal.classList.add("hidden");
                friendModal.classList.remove("flex");
            }
            if (friendForm) friendForm.reset();
            if (friendId) friendId.value = "";
            updateAvatarPreview();
        }

        function updateAvatarPreview() {
            var previewWrap = document.getElementById("friendAvatarPreview");
            var previewImg = document.getElementById("friendAvatarPreviewImg");
            var avatarInput = document.getElementById("friendAvatar");
            if (!previewWrap || !previewImg || !avatarInput) return;

            var value = avatarInput.value || "";
            if (!value) {
                previewWrap.classList.add("hidden");
                previewImg.src = "";
                return;
            }
            previewWrap.classList.remove("hidden");
            previewImg.onerror = function () {
                previewWrap.classList.add("hidden");
            };
            previewImg.src = value;
        }

        function setupMediaPicker() {
            var modal = document.getElementById("mediaPickerModal");
            if (!modal || avatarPickerReady) return;
            avatarPickerReady = true;

            var openBtn = document.getElementById("openFriendAvatarPicker");
            var closeBtn = document.getElementById("mediaPickerClose");
            var searchInput = document.getElementById("mediaPickerSearch");
            var grid = document.getElementById("mediaPickerGrid");
            var countEl = document.getElementById("mediaPickerCount");
            var prevBtn = document.getElementById("mediaPickerPrev");
            var nextBtn = document.getElementById("mediaPickerNext");
            var pageEl = document.getElementById("mediaPickerPage");

            var currentPage = 1;
            var totalPages = 1;
            var keyword = "";
            var searchTimer = null;

            function isImageItem(item) {
                if (item.mime_type && item.mime_type.indexOf("image/") === 0) {
                    return true;
                }
                var name = item.filename || "";
                var ext = name.toLowerCase().split(".").pop();
                return ["jpg", "jpeg", "png", "gif", "webp", "svg"].includes(ext);
            }

            function openPicker() {
                currentPage = 1;
                keyword = "";
                if (searchInput) searchInput.value = "";
                modal.classList.remove("hidden");
                modal.classList.add("flex");
                loadMedia();
            }

            function closePicker() {
                modal.classList.add("hidden");
                modal.classList.remove("flex");
            }

            async function loadMedia() {
                if (!grid) return;
                grid.innerHTML = '<div class="col-span-full text-center text-sm text-zinc-500 py-10">加载中...</div>';

                try {
                    var query = "page=" + currentPage + "&page_size=40";
                    if (keyword) {
                        query += "&keyword=" + encodeURIComponent(keyword);
                    }
                    var result = await window.adminRequest(API_URL + "/upload/media?" + query, {
                        headers: {
                            "Authorization": "Bearer " + localStorage.getItem("adminToken")
                        }
                    });

                    if (!result.ok) {
                        throw new Error(result.msg || "加载失败");
                    }

                    var data = result.data || {};
                    var items = (data.items || []).filter(isImageItem);
                    var total = data.pagination ? data.pagination.total : items.length;
                    totalPages = data.pagination ? data.pagination.total_pages : 1;

                    if (countEl) {
                        countEl.textContent = "共 " + total + " 张图片";
                    }
                    if (pageEl) {
                        pageEl.textContent = currentPage + "/" + (totalPages || 1);
                    }
                    if (prevBtn) prevBtn.disabled = currentPage <= 1;
                    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;

                    if (items.length === 0) {
                        grid.innerHTML = '<div class="col-span-full text-center text-sm text-zinc-500 py-10">暂无图片</div>';
                        return;
                    }

                    grid.innerHTML = items.map(function(item) {
                        var name = item.original_name || item.filename || "image";
                        return '' +
                            '<button type="button" class="group text-left rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden bg-white dark:bg-zinc-900 hover:border-[var(--primary)]/50 transition-all" data-url="' + item.url + '" data-name="' + name + '">' +
                                '<div class="aspect-square bg-zinc-100 dark:bg-zinc-800 overflow-hidden">' +
                                    '<img src="' + item.url + '" alt="' + name + '" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition-transform" />' +
                                '</div>' +
                                '<div class="px-2 py-1.5 text-xs text-zinc-600 dark:text-zinc-300 truncate">' + name + '</div>' +
                            '</button>';
                    }).join("");

                    grid.querySelectorAll("button[data-url]").forEach(function(btn) {
                        btn.addEventListener("click", function() {
                            var url = this.dataset.url;
                            var avatarInput = document.getElementById("friendAvatar");
                            if (avatarInput) {
                                avatarInput.value = url;
                                avatarInput.dispatchEvent(new Event("input"));
                            }
                            updateAvatarPreview();
                            closePicker();
                        });
                    });
                } catch (err) {
                    console.error("加载媒体失败:", err);
                    grid.innerHTML = '<div class="col-span-full text-center text-sm text-red-500 py-10">加载失败</div>';
                }
            }

            openBtn?.addEventListener("click", openPicker);
            closeBtn?.addEventListener("click", closePicker);
            modal?.addEventListener("click", function(e) {
                if (e.target === modal) {
                    closePicker();
                }
            });

            searchInput?.addEventListener("input", function() {
                keyword = this.value.trim();
                clearTimeout(searchTimer);
                searchTimer = setTimeout(function() {
                    currentPage = 1;
                    loadMedia();
                }, 300);
            });

            prevBtn?.addEventListener("click", function() {
                if (currentPage > 1) {
                    currentPage -= 1;
                    loadMedia();
                }
            });

            nextBtn?.addEventListener("click", function() {
                if (currentPage < totalPages) {
                    currentPage += 1;
                    loadMedia();
                }
            });

            var avatarInput = document.getElementById("friendAvatar");
            if (avatarInput) {
                avatarInput.addEventListener("input", updateAvatarPreview);
            }
        }

        window.editFriend = function (id) {
            var friend = friends.find(function (f) {
                return f.id === id;
            });
            if (!friend) return;

            var friendIdEl = document.getElementById("friendId");
            var friendTitleEl = document.getElementById("friendTitle");
            var friendUrlEl = document.getElementById("friendUrl");
            var friendAvatarEl = document.getElementById("friendAvatar");
            var friendDescriptionEl =
                document.getElementById("friendDescription");
            var friendTagsEl = document.getElementById("friendTags");
            var friendWeightEl = document.getElementById("friendWeight");
            var friendEnabledEl = document.getElementById("friendEnabled");

            if (friendIdEl) friendIdEl.value = friend.id;
            if (friendTitleEl) friendTitleEl.value = friend.title;
            if (friendUrlEl) friendUrlEl.value = friend.url;
            if (friendAvatarEl) friendAvatarEl.value = friend.avatar || "";
            if (friendDescriptionEl)
                friendDescriptionEl.value = friend.description || "";
            if (friendTagsEl) friendTagsEl.value = friend.tags || "";
            if (friendWeightEl) friendWeightEl.value = friend.weight || 0;
            if (friendEnabledEl) friendEnabledEl.checked = friend.enabled;

            // 同步开关状态
            var toggle = document.getElementById("friendEnabledToggle");
            if (toggle) {
                if (friend.enabled) {
                    toggle.classList.add("active");
                } else {
                    toggle.classList.remove("active");
                }
            }

            updateAvatarPreview();
            showModal(true);
        };

        window.deleteFriend = async function (id, name) {
            var confirmMsg = (
                t.confirmDeleteFriend || 'Delete friend "{name}"?'
            ).replace("{name}", name);
            var confirmed = await window.showAdminConfirm(confirmMsg);
            if (!confirmed) return;

            try {
                var result = await window.adminRequest(API_URL + "/friends/" + id, {
                    method: "DELETE",
                    headers: {
                        Authorization:
                            "Bearer " + localStorage.getItem("adminToken"),
                    },
                });

                if (result.ok) {
                    loadFriends();
                } else {
                    window.showAdminAlert(result.msg || t.deleteFailed || "Delete failed", "error");
                }
            } catch (err) {
                window.showAdminAlert(t.deleteFailed || "Delete failed", "error");
            }
        };

        var addFriendBtn = document.getElementById("addFriendBtn");
        var cancelBtn = document.getElementById("cancelBtn");
        var friendModal = document.getElementById("friendModal");
        var friendForm = document.getElementById("friendForm");

        // 开关组件交互
        var enabledToggle = document.getElementById("friendEnabledToggle");
        var enabledCheckbox = document.getElementById("friendEnabled");
        if (enabledToggle && enabledCheckbox) {
            enabledToggle.addEventListener("click", function() {
                enabledCheckbox.checked = !enabledCheckbox.checked;
                if (enabledCheckbox.checked) {
                    enabledToggle.classList.add("active");
                } else {
                    enabledToggle.classList.remove("active");
                }
            });
        }

        // 同步开关状态的辅助函数
        function syncToggleState() {
            if (enabledToggle && enabledCheckbox) {
                if (enabledCheckbox.checked) {
                    enabledToggle.classList.add("active");
                } else {
                    enabledToggle.classList.remove("active");
                }
            }
        }

        if (addFriendBtn)
            addFriendBtn.addEventListener("click", function () {
                // 重置开关状态为启用
                if (enabledCheckbox) enabledCheckbox.checked = true;
                syncToggleState();
                showModal(false);
            });
        if (cancelBtn) cancelBtn.addEventListener("click", hideModal);
        if (friendModal) {
            friendModal.addEventListener("click", function (e) {
                if (e.target === e.currentTarget) hideModal();
            });
        }

        if (friendForm) {
            friendForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                var friendIdEl = document.getElementById("friendId");
                var friendTitleEl = document.getElementById("friendTitle");
                var friendUrlEl = document.getElementById("friendUrl");
                var friendAvatarEl = document.getElementById("friendAvatar");
                var friendDescriptionEl =
                    document.getElementById("friendDescription");
                var friendTagsEl = document.getElementById("friendTags");
                var friendWeightEl = document.getElementById("friendWeight");
                var friendEnabledEl = document.getElementById("friendEnabled");

                var id = friendIdEl ? friendIdEl.value : "";
                var data = {
                    title: friendTitleEl ? friendTitleEl.value : "",
                    url: friendUrlEl ? friendUrlEl.value : "",
                    avatar: friendAvatarEl
                        ? friendAvatarEl.value || undefined
                        : undefined,
                    description: friendDescriptionEl
                        ? friendDescriptionEl.value || undefined
                        : undefined,
                    tags: friendTagsEl
                        ? friendTagsEl.value || undefined
                        : undefined,
                    weight: friendWeightEl
                        ? parseInt(friendWeightEl.value) || 0
                        : 0,
                    enabled: friendEnabledEl ? friendEnabledEl.checked : true,
                };

                try {
                    var result = await window.adminRequest(
                        API_URL + "/friends/" + (id || ""),
                        {
                            method: id ? "PUT" : "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization:
                                    "Bearer " +
                                    localStorage.getItem("adminToken"),
                            },
                            body: JSON.stringify(data),
                        },
                    );

                    if (result.ok) {
                        hideModal();
                        loadFriends();
                    } else {
                        window.showAdminAlert(result.msg || t.saveFailed || "Save failed", "error");
                    }
                } catch (err) {
                    window.showAdminAlert(t.saveFailed || "Save failed", "error");
                }
            });
        }

        function initFriendsPage() {
            // 检查是否在友链管理页面
            if (!document.getElementById('friendsGrid')) return;
            loadFriends();
        }

        // 监听 SPA 导航
        document.addEventListener('astro:page-load', initFriendsPage);

        // 首次加载
        initFriendsPage();
    })();
</script>

<style>
    .modal-input {
        @apply w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700/50 bg-white/80 dark:bg-zinc-800/80 text-zinc-900 dark:text-zinc-100 outline-none transition-all duration-300 placeholder:text-zinc-400 dark:placeholder:text-zinc-500;
        box-shadow:
            0 1px 3px rgba(0, 0, 0, 0.04),
            0 1px 2px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
    }

    .modal-input:hover {
        @apply border-zinc-300 dark:border-zinc-600;
        box-shadow:
            0 2px 8px rgba(0, 0, 0, 0.06),
            0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .modal-input:focus {
        border-color: var(--primary);
        box-shadow:
            0 0 0 4px color-mix(in oklch, var(--primary) 18%, transparent),
            0 2px 8px color-mix(in oklch, var(--primary) 30%, transparent);
    }

    :global(.dark) .modal-input:focus {
        box-shadow:
            0 0 0 4px color-mix(in oklch, var(--primary) 22%, transparent),
            0 0 20px color-mix(in oklch, var(--primary) 30%, transparent);
    }

    input[type="number"].modal-input {
        -moz-appearance: textfield;
    }

    input[type="number"].modal-input::-webkit-outer-spin-button,
    input[type="number"].modal-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* 自定义滚动条样式 */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        @apply bg-transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        @apply bg-zinc-200 dark:bg-zinc-700 rounded-full;
        transition: background-color 0.2s ease;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        @apply bg-zinc-300 dark:bg-zinc-600;
    }

    /* Firefox 滚动条样式 */
    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: rgb(228 228 231) transparent;
    }

    :global(.dark) .custom-scrollbar {
        scrollbar-color: rgb(63 63 70) transparent;
    }
</style>
