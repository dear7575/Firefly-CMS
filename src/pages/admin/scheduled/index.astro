---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
---

<AdminLayout title={`定时发布 - ${siteConfig.title}`} activeMenu="scheduled">
    <div class="p-6 lg:p-8 space-y-6">
        <div>
            <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">定时发布</h1>
            <p class="text-sm text-zinc-500 mt-1">查看待发布队列与发布日志</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">待发布队列</h2>
                        <p class="text-xs text-zinc-500">显示当前未发布的定时文章</p>
                    </div>
                    <button id="refreshQueue" class="px-4 py-2 rounded-xl bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 text-zinc-600 dark:text-zinc-300 text-sm hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 transition-all">
                        刷新
                    </button>
                </div>
                <div id="scheduledQueueList" class="space-y-3 text-sm text-zinc-600 dark:text-zinc-300">
                    加载中...
                </div>
                <div id="scheduledQueuePagination" class="flex items-center justify-between text-xs text-zinc-500 mt-4"></div>
            </div>

            <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">发布日志</h2>
                        <p class="text-xs text-zinc-500">记录定时发布的成功与失败</p>
                    </div>
                    <button id="refreshLogs" class="px-4 py-2 rounded-xl bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 text-zinc-600 dark:text-zinc-300 text-sm hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 transition-all">
                        刷新
                    </button>
                </div>
                <div id="scheduledLogList" class="space-y-3 text-sm text-zinc-600 dark:text-zinc-300">
                    加载中...
                </div>
                <div id="scheduledLogPagination" class="flex items-center justify-between text-xs text-zinc-500 mt-4"></div>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline>
    (function () {
        var API_URL = window.API_URL;

        function getAuthHeader() {
            var token = localStorage.getItem("adminToken");
            return token ? { Authorization: "Bearer " + token } : {};
        }

        function formatTime(value) {
            if (!value) return "-";
            return new Date(value).toLocaleString();
        }

        function renderQueue(items) {
            var list = document.getElementById("scheduledQueueList");
            if (!list) return;
            if (!items || !items.length) {
                list.innerHTML = '<div class="text-center text-sm text-zinc-500 py-6">暂无待发布文章</div>';
                return;
            }
            list.innerHTML = items
                .map(function (item) {
                    var statusLabel = item.status === "failed" ? "发布失败" : "等待发布";
                    var statusClass = item.status === "failed" ? "text-red-500 bg-red-50" : "text-amber-600 bg-amber-50";
                    var errorHtml = item.last_error
                        ? '<div class="text-xs text-red-500 mt-1 line-clamp-2">错误：' + item.last_error + "</div>"
                        : "";
                    return (
                        '<div class="p-3 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/60 flex flex-col gap-2" data-post-id="' +
                        item.id +
                        '">' +
                        '<div class="flex items-start justify-between gap-3">' +
                        '<div class="min-w-0">' +
                        '<div class="font-semibold text-zinc-900 dark:text-zinc-100 truncate">' +
                        item.title +
                        "</div>" +
                        '<div class="text-xs text-zinc-500 dark:text-zinc-400 mt-1">计划：' +
                        formatTime(item.scheduled_at) +
                        " · 尝试：" +
                        (item.attempts || 0) +
                        " · 最近：" +
                        formatTime(item.last_attempt_at) +
                        "</div>" +
                        errorHtml +
                        "</div>" +
                        '<span class="px-2 py-1 rounded-full text-[11px] font-medium ' +
                        statusClass +
                        '">' +
                        statusLabel +
                        "</span>" +
                        "</div>" +
                        '<div class="flex justify-end">' +
                        '<button class="retry-btn px-3 py-1.5 rounded-lg border border-zinc-200 dark:border-zinc-700 text-sm text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors" data-post-id="' +
                        item.id +
                        '">立即重试</button>' +
                        "</div>" +
                        "</div>"
                    );
                })
                .join("");

            list.querySelectorAll(".retry-btn").forEach(function (btn) {
                btn.addEventListener("click", async function () {
                    var postId = btn.getAttribute("data-post-id");
                    if (!postId) return;
                    var confirmed = await window.showAdminConfirm("确定要立即重试发布吗？");
                    if (!confirmed) return;
                    btn.disabled = true;
                    try {
                        var result = await window.adminRequest(API_URL + "/posts/" + postId + "/scheduled/retry", {
                            method: "POST",
                            headers: getAuthHeader(),
                        });
                        if (result.ok) {
                            window.showAdminAlert("已加入发布队列", "success");
                            loadQueue(1);
                        } else {
                            window.showAdminAlert(result.msg || "重试失败", "error");
                        }
                    } catch (err) {
                        window.showAdminAlert("重试失败", "error");
                    } finally {
                        btn.disabled = false;
                    }
                });
            });
        }

        function renderLogs(items) {
            var list = document.getElementById("scheduledLogList");
            if (!list) return;
            if (!items || !items.length) {
                list.innerHTML = '<div class="text-center text-sm text-zinc-500 py-6">暂无发布日志</div>';
                return;
            }
            list.innerHTML = items
                .map(function (item) {
                    var statusLabel = item.status === "success" ? "发布成功" : "发布失败";
                    var statusClass = item.status === "success" ? "text-green-600 bg-green-50" : "text-red-500 bg-red-50";
                    var message = item.message ? item.message : "-";
                    return (
                        '<div class="p-3 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/60 flex flex-col gap-2">' +
                        '<div class="flex items-start justify-between gap-3">' +
                        '<div class="min-w-0">' +
                        '<div class="font-semibold text-zinc-900 dark:text-zinc-100 truncate">' +
                        (item.post_title || "未知文章") +
                        "</div>" +
                        '<div class="text-xs text-zinc-500 dark:text-zinc-400 mt-1">计划：' +
                        formatTime(item.scheduled_at) +
                        " · 时间：" +
                        formatTime(item.created_at) +
                        "</div>" +
                        '<div class="text-xs text-zinc-500 dark:text-zinc-400 mt-1">原因：' +
                        message +
                        "</div>" +
                        "</div>" +
                        '<span class="px-2 py-1 rounded-full text-[11px] font-medium ' +
                        statusClass +
                        '">' +
                        statusLabel +
                        "</span>" +
                        "</div>" +
                        "</div>"
                    );
                })
                .join("");
        }

        function renderPagination(containerId, pagination, onChange) {
            var container = document.getElementById(containerId);
            if (!container) return;
            if (!pagination || pagination.total_pages <= 1) {
                container.innerHTML = "";
                return;
            }
            var prevDisabled = pagination.page <= 1 ? "disabled opacity-40 cursor-not-allowed" : "";
            var nextDisabled = pagination.page >= pagination.total_pages ? "disabled opacity-40 cursor-not-allowed" : "";
            container.innerHTML =
                "<div>第 " +
                pagination.page +
                " / " +
                pagination.total_pages +
                " 页，共 " +
                pagination.total +
                " 条</div>" +
                '<div class="flex gap-2">' +
                '<button class="page-btn px-3 py-1 rounded-lg border border-zinc-200 dark:border-zinc-700 ' +
                prevDisabled +
                '" data-page="' +
                (pagination.page - 1) +
                '">上一页</button>' +
                '<button class="page-btn px-3 py-1 rounded-lg border border-zinc-200 dark:border-zinc-700 ' +
                nextDisabled +
                '" data-page="' +
                (pagination.page + 1) +
                '">下一页</button>' +
                "</div>";

            container.querySelectorAll(".page-btn").forEach(function (btn) {
                btn.addEventListener("click", function () {
                    var page = Number(btn.getAttribute("data-page"));
                    if (!page || btn.disabled) return;
                    onChange(page);
                });
            });
        }

        async function loadQueue(page) {
            var list = document.getElementById("scheduledQueueList");
            if (!list) return;
            list.innerHTML = '<div class="text-center text-sm text-zinc-500 py-6">加载中...</div>';
            try {
                var url = new URL(API_URL + "/posts/scheduled/queue", window.location.origin);
                url.searchParams.set("page", page || 1);
                url.searchParams.set("page_size", 8);
                var result = await window.adminRequest(url.toString(), {
                    headers: getAuthHeader(),
                });
                if (!result.ok) {
                    list.innerHTML = '<div class="text-center text-sm text-red-400 py-6">队列加载失败</div>';
                    return;
                }
                var data = result.data || {};
                renderQueue(data.items || []);
                renderPagination("scheduledQueuePagination", data.pagination, loadQueue);
            } catch (err) {
                list.innerHTML = '<div class="text-center text-sm text-red-400 py-6">队列加载失败</div>';
            }
        }

        async function loadLogs(page) {
            var list = document.getElementById("scheduledLogList");
            if (!list) return;
            list.innerHTML = '<div class="text-center text-sm text-zinc-500 py-6">加载中...</div>';
            try {
                var url = new URL(API_URL + "/posts/scheduled/logs", window.location.origin);
                url.searchParams.set("page", page || 1);
                url.searchParams.set("page_size", 8);
                var result = await window.adminRequest(url.toString(), {
                    headers: getAuthHeader(),
                });
                if (!result.ok) {
                    list.innerHTML = '<div class="text-center text-sm text-red-400 py-6">日志加载失败</div>';
                    return;
                }
                var data = result.data || {};
                renderLogs(data.items || []);
                renderPagination("scheduledLogPagination", data.pagination, loadLogs);
            } catch (err) {
                list.innerHTML = '<div class="text-center text-sm text-red-400 py-6">日志加载失败</div>';
            }
        }

        document.getElementById("refreshQueue")?.addEventListener("click", function () {
            loadQueue(1);
        });
        document.getElementById("refreshLogs")?.addEventListener("click", function () {
            loadLogs(1);
        });

        document.addEventListener("astro:page-load", function () {
            loadQueue(1);
            loadLogs(1);
        });
        loadQueue(1);
        loadLogs(1);
    })();
</script>
