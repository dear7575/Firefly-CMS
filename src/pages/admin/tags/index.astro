---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
---

<AdminLayout title={`${i18n(I18nKey.adminTagManagement)} - ${siteConfig.title}`} activeMenu="tags">
    <div class="p-6 lg:p-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">{i18n(I18nKey.adminTagManagement)}</h1>
                <p class="text-sm text-zinc-500 mt-1">{i18n(I18nKey.adminManageBlogTags)}</p>
            </div>
            <button
                id="addTagBtn"
                class="bg-[var(--primary)] hover:opacity-90 text-white px-6 py-2.5 rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                {i18n(I18nKey.adminAdd)} {i18n(I18nKey.tags)}
            </button>
        </div>

        <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm p-6">
            <div class="flex flex-wrap gap-3" id="tagsContainer">
                <div class="text-zinc-500">{i18n(I18nKey.adminLoading)}</div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="tagModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-zinc-200 dark:border-zinc-800">
                <h2 id="modalTitle" class="text-xl font-bold text-zinc-900 dark:text-zinc-100">{i18n(I18nKey.adminAdd)} {i18n(I18nKey.tags)}</h2>
            </div>
            <form id="tagForm" class="p-6 space-y-4">
                <input type="hidden" id="tagId" />
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">{i18n(I18nKey.adminName)} *</label>
                    <input type="text" id="tagName" required class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">{i18n(I18nKey.adminSlug)}</label>
                    <input type="text" id="tagSlug" class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none" placeholder={i18n(I18nKey.adminAutoGenerated)} />
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">{i18n(I18nKey.adminColor)}</label>
                    <input type="color" id="tagColor" value="#6366f1" class="w-full h-10 rounded-xl border border-zinc-200 dark:border-zinc-700 cursor-pointer" />
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="tagEnabled" checked class="w-4 h-4 rounded" />
                    <label for="tagEnabled" class="text-sm text-zinc-700 dark:text-zinc-300">{i18n(I18nKey.adminEnabled)}</label>
                </div>
            </form>
            <div class="p-6 border-t border-zinc-200 dark:border-zinc-800 flex justify-end gap-3">
                <button type="button" id="cancelBtn" class="px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors">{i18n(I18nKey.adminCancel)}</button>
                <button type="submit" form="tagForm" class="px-6 py-2 bg-[var(--primary)] text-white rounded-lg hover:opacity-90 transition-colors">{i18n(I18nKey.adminSave)}</button>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline>
(function() {
    var API_URL = 'http://localhost:8000';
    var tags = [];
    var t = window.adminI18n || {};

    async function loadTags() {
        var container = document.getElementById('tagsContainer');
        if (!container) return; // 不在 tags 页面，直接返回

        try {
            var response = await fetch(API_URL + '/tags');
            if (!response.ok) throw new Error('Failed to load');
            tags = await response.json();

            if (tags.length === 0) {
                container.innerHTML = '<div class="text-zinc-500">' + (t.noTagsYet || t.empty || 'No tags yet') + '</div>';
                return;
            }

            container.innerHTML = tags.map(function(tag) {
                var color = tag.color || '#6366f1';
                return '<div class="group flex items-center gap-2 px-4 py-2 rounded-xl border border-zinc-200 dark:border-zinc-700 hover:shadow-md transition-all" style="background-color: ' + color + '10">' +
                    '<span class="w-3 h-3 rounded-full" style="background-color: ' + color + '"></span>' +
                    '<span class="font-medium text-zinc-800 dark:text-zinc-200">' + tag.name + '</span>' +
                    '<span class="text-xs text-zinc-500">(' + tag.post_count + ')</span>' +
                    '<div class="hidden group-hover:flex items-center gap-1 ml-2">' +
                        '<button onclick="editTag(\'' + tag.id + '\')" class="p-1 text-indigo-500 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 rounded transition-colors">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />' +
                            '</svg>' +
                        '</button>' +
                        '<button onclick="deleteTag(\'' + tag.id + '\', \'' + tag.name.replace(/'/g, "\\'") + '\')" class="p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />' +
                            '</svg>' +
                        '</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        } catch (err) {
            console.error(err);
            if (container) container.innerHTML = '<div class="text-red-500">' + (t.tagLoadFailed || t.loadFailed || 'Failed to load tags') + '</div>';
        }
    }

    function showModal(isEdit) {
        var modalTitle = document.getElementById('modalTitle');
        var tagModal = document.getElementById('tagModal');
        if (modalTitle) modalTitle.textContent = isEdit ? (t.edit || 'Edit') + ' ' + (t.tags || 'Tag') : (t.add || 'Add') + ' ' + (t.tags || 'Tag');
        if (tagModal) {
            tagModal.classList.remove('hidden');
            tagModal.classList.add('flex');
        }
    }

    function hideModal() {
        var tagModal = document.getElementById('tagModal');
        var tagForm = document.getElementById('tagForm');
        var tagId = document.getElementById('tagId');
        if (tagModal) {
            tagModal.classList.add('hidden');
            tagModal.classList.remove('flex');
        }
        if (tagForm) tagForm.reset();
        if (tagId) tagId.value = '';
    }

    window.editTag = function(id) {
        var tag = tags.find(function(t) { return t.id === id; });
        if (!tag) return;

        var tagIdEl = document.getElementById('tagId');
        var tagNameEl = document.getElementById('tagName');
        var tagSlugEl = document.getElementById('tagSlug');
        var tagColorEl = document.getElementById('tagColor');
        var tagEnabledEl = document.getElementById('tagEnabled');

        if (tagIdEl) tagIdEl.value = tag.id;
        if (tagNameEl) tagNameEl.value = tag.name;
        if (tagSlugEl) tagSlugEl.value = tag.slug || '';
        if (tagColorEl) tagColorEl.value = tag.color || '#6366f1';
        if (tagEnabledEl) tagEnabledEl.checked = tag.enabled;

        showModal(true);
    };

    window.deleteTag = async function(id, name) {
        if (!confirm((t.confirmDeleteTag || 'Delete tag "{name}"?').replace('{name}', name))) return;

        try {
            var response = await fetch(API_URL + '/tags/' + id, {
                method: 'DELETE',
                headers: { Authorization: 'Bearer ' + localStorage.getItem('adminToken') }
            });

            if (response.ok) {
                loadTags();
            } else {
                var err = await response.json();
                alert(err.detail || t.deleteFailed || 'Delete failed');
            }
        } catch (err) {
            alert(t.deleteFailed || 'Delete failed');
        }
    };

    var addTagBtn = document.getElementById('addTagBtn');
    var cancelBtn = document.getElementById('cancelBtn');
    var tagModal = document.getElementById('tagModal');
    var tagForm = document.getElementById('tagForm');

    if (addTagBtn) addTagBtn.addEventListener('click', function() { showModal(false); });
    if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
    if (tagModal) {
        tagModal.addEventListener('click', function(e) {
            if (e.target === e.currentTarget) hideModal();
        });
    }

    if (tagForm) {
        tagForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            var tagIdEl = document.getElementById('tagId');
            var tagNameEl = document.getElementById('tagName');
            var tagSlugEl = document.getElementById('tagSlug');
            var tagColorEl = document.getElementById('tagColor');
            var tagEnabledEl = document.getElementById('tagEnabled');

            var id = tagIdEl ? tagIdEl.value : '';
            var data = {
                name: tagNameEl ? tagNameEl.value : '',
                slug: tagSlugEl ? tagSlugEl.value || undefined : undefined,
                color: tagColorEl ? tagColorEl.value : '#6366f1',
                enabled: tagEnabledEl ? tagEnabledEl.checked : true
            };

            try {
                var response = await fetch(API_URL + '/tags/' + (id || ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    hideModal();
                    loadTags();
                } else {
                    var err = await response.json();
                    alert(err.detail || 'Save failed');
                }
            } catch (err) {
                alert('Save failed');
            }
        });
    }

    loadTags();
})();
</script>
