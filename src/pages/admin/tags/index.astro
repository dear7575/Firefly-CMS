---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();
---

<AdminLayout
    title={`${i18n(I18nKey.adminTagManagement)} - ${siteConfig.title}`}
    activeMenu="tags"
>
    <div class="p-6 lg:p-8">
        <div
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6"
        >
            <div>
                <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">
                    {i18n(I18nKey.adminTagManagement)}
                </h1>
                <p class="text-sm text-zinc-500 mt-1">
                    {i18n(I18nKey.adminManageBlogTags)}
                </p>
            </div>
            <button
                id="addTagBtn"
                class="bg-[var(--primary)] dark:bg-zinc-800 hover:opacity-90 dark:hover:bg-zinc-700 text-white dark:text-zinc-100 px-6 py-2.5 rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                >
                    <path
                        fill-rule="evenodd"
                        d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                        clip-rule="evenodd"></path>
                </svg>
                {i18n(I18nKey.adminAdd)}
                {i18n(I18nKey.tags)}
            </button>
        </div>

        <div
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"
            id="tagsContainer"
        >
            <div class="col-span-full text-center py-12 text-zinc-500">
                {i18n(I18nKey.adminLoading)}
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div
        id="tagModal"
        class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    >
        <div
            class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-md shadow-2xl"
        >
            <div class="p-6 border-b border-zinc-200 dark:border-zinc-800">
                <h2
                    id="modalTitle"
                    class="text-xl font-bold text-zinc-900 dark:text-zinc-100"
                >
                    {i18n(I18nKey.adminAdd)}
                    {i18n(I18nKey.tags)}
                </h2>
            </div>
            <form id="tagForm" class="p-6 space-y-4">
                <input type="hidden" id="tagId" />
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.adminName)} <span class="text-red-500">*</span></label
                    >
                    <input
                        type="text"
                        id="tagName"
                        required
                        class="modal-input"
                    />
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.adminSlug)}</label
                    >
                    <input
                        type="text"
                        id="tagSlug"
                        class="modal-input"
                        placeholder={i18n(I18nKey.adminAutoGenerated)}
                    />
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >{i18n(I18nKey.adminColor)}</label
                    >
                    <input
                        type="color"
                        id="tagColor"
                        value="#6366f1"
                        class="w-full h-10 rounded-xl border border-zinc-200 dark:border-zinc-700/50 cursor-pointer transition-all hover:border-zinc-300 dark:hover:border-zinc-600"
                    />
                </div>
                <div class="flex items-center justify-between">
                    <label
                        class="text-sm font-medium text-zinc-700 dark:text-zinc-300"
                        >{i18n(I18nKey.adminEnabled)}</label
                    >
                    <div id="tagEnabledToggle" class="toggle-switch active"></div>
                    <input
                        type="checkbox"
                        id="tagEnabled"
                        checked
                        class="hidden"
                    />
                </div>
            </form>
            <div
                class="p-6 border-t border-zinc-200 dark:border-zinc-800 flex justify-end gap-3"
            >
                <button
                    type="button"
                    id="cancelBtn"
                    class="px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    >{i18n(I18nKey.adminCancel)}</button
                >
                <button
                    type="submit"
                    form="tagForm"
                    class="px-6 py-2 bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 rounded-lg hover:opacity-90 dark:hover:bg-zinc-700 transition-colors dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]"
                    >{i18n(I18nKey.adminSave)}</button
                >
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline>
    (function () {
        var tags = [];
        var t = window.adminI18n || {};
        var API_URL = window.API_URL;

        async function loadTags() {
            var container = document.getElementById("tagsContainer");
            if (!container) return; // 不在 tags 页面，直接返回

            try {
                var result = await window.adminRequest(`${API_URL}/tags`);
                if (!result.ok) throw new Error(result.msg || "加载失败");
                tags = result.data || [];

                if (tags.length === 0) {
                    container.innerHTML =
                        '<div class="col-span-full text-center py-12 text-zinc-500">' +
                        (t.noTagsYet || t.empty || "No tags yet") +
                        "</div>";
                    return;
                }

                container.innerHTML = tags
                    .map(function (tag) {
                        var color = tag.color || "#6366f1";
                        var statusClass = tag.enabled
                            ? "bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400"
                            : "bg-zinc-100 dark:bg-zinc-800 text-zinc-500";
                        var statusText = tag.enabled ? t.active : t.disabled;
                        var nameEscaped = tag.name.replace(/'/g, "\\'");

                        return (
                            '<div class="group bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200 dark:border-zinc-800 p-4 hover:shadow-lg hover:border-zinc-300 dark:hover:border-zinc-600 transition-all">' +
                            '<div class="flex items-center justify-between mb-3">' +
                            '<div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: ' +
                            color +
                            '20">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" style="color: ' +
                            color +
                            '" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />' +
                            "</svg>" +
                            "</div>" +
                            '<span class="px-1.5 py-0.5 text-[10px] rounded-full ' +
                            statusClass +
                            '">' +
                            statusText +
                            "</span>" +
                            "</div>" +
                            '<h3 class="font-semibold text-zinc-900 dark:text-zinc-100 truncate mb-1" title="' +
                            tag.name +
                            '">' +
                            tag.name +
                            "</h3>" +
                            '<p class="text-xs text-zinc-500 mb-3">' +
                            tag.post_count +
                            " " +
                            (t.posts || "posts") +
                            "</p>" +
                            '<div class="flex items-center justify-between pt-2 border-t border-zinc-100 dark:border-zinc-800">' +
                            '<span class="w-2.5 h-2.5 rounded-full" style="background-color: ' +
                            color +
                            '"></span>' +
                            '<div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">' +
                            "<button onclick=\"editTag('" +
                            tag.id +
                            '\')" class="p-1.5 text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />' +
                            "</svg>" +
                            "</button>" +
                            "<button onclick=\"deleteTag('" +
                            tag.id +
                            "', '" +
                            nameEscaped +
                            '\')" class="p-1.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />' +
                            "</svg>" +
                            "</button>" +
                            "</div>" +
                            "</div>" +
                            "</div>"
                        );
                    })
                    .join("");
            } catch (err) {
                console.error(err);
                if (container)
                    container.innerHTML =
                        '<div class="text-red-500">' +
                        (t.tagLoadFailed ||
                            t.loadFailed ||
                            "Failed to load tags") +
                        "</div>";
            }
        }

        function showModal(isEdit) {
            var modalTitle = document.getElementById("modalTitle");
            var tagModal = document.getElementById("tagModal");
            if (modalTitle)
                modalTitle.textContent = isEdit
                    ? (t.edit || "Edit") + " " + (t.tags || "Tag")
                    : (t.add || "Add") + " " + (t.tags || "Tag");
            if (tagModal) {
                tagModal.classList.remove("hidden");
                tagModal.classList.add("flex");
            }
        }

        function hideModal() {
            var tagModal = document.getElementById("tagModal");
            var tagForm = document.getElementById("tagForm");
            var tagId = document.getElementById("tagId");
            if (tagModal) {
                tagModal.classList.add("hidden");
                tagModal.classList.remove("flex");
            }
            if (tagForm) tagForm.reset();
            if (tagId) tagId.value = "";
        }

        window.editTag = function (id) {
            var tag = tags.find(function (t) {
                return t.id === id;
            });
            if (!tag) return;

            var tagIdEl = document.getElementById("tagId");
            var tagNameEl = document.getElementById("tagName");
            var tagSlugEl = document.getElementById("tagSlug");
            var tagColorEl = document.getElementById("tagColor");
            var tagEnabledEl = document.getElementById("tagEnabled");

            if (tagIdEl) tagIdEl.value = tag.id;
            if (tagNameEl) tagNameEl.value = tag.name;
            if (tagSlugEl) tagSlugEl.value = tag.slug || "";
            if (tagColorEl) tagColorEl.value = tag.color || "#6366f1";
            if (tagEnabledEl) tagEnabledEl.checked = tag.enabled;

            // 同步开关状态
            var toggle = document.getElementById("tagEnabledToggle");
            if (toggle) {
                if (tag.enabled) {
                    toggle.classList.add("active");
                } else {
                    toggle.classList.remove("active");
                }
            }

            showModal(true);
        };

        window.deleteTag = async function (id, name) {
            var confirmMsg = (t.confirmDeleteTag || 'Delete tag "{name}"?').replace(
                "{name}",
                name,
            );
            var confirmed = await window.showAdminConfirm(confirmMsg);
            if (!confirmed) return;

            try {
                var result = await window.adminRequest(API_URL + "/tags/" + id, {
                    method: "DELETE",
                    headers: {
                        Authorization:
                            "Bearer " + localStorage.getItem("adminToken"),
                    },
                });

                if (result.ok) {
                    loadTags();
                } else {
                    window.showAdminAlert(result.msg || t.deleteFailed || "Delete failed", "error");
                }
            } catch (err) {
                window.showAdminAlert(t.deleteFailed || "Delete failed", "error");
            }
        };

        var addTagBtn = document.getElementById("addTagBtn");
        var cancelBtn = document.getElementById("cancelBtn");
        var tagModal = document.getElementById("tagModal");
        var tagForm = document.getElementById("tagForm");

        // 开关组件交互
        var enabledToggle = document.getElementById("tagEnabledToggle");
        var enabledCheckbox = document.getElementById("tagEnabled");
        if (enabledToggle && enabledCheckbox) {
            enabledToggle.addEventListener("click", function() {
                enabledCheckbox.checked = !enabledCheckbox.checked;
                if (enabledCheckbox.checked) {
                    enabledToggle.classList.add("active");
                } else {
                    enabledToggle.classList.remove("active");
                }
            });
        }

        // 同步开关状态的辅助函数
        function syncToggleState() {
            if (enabledToggle && enabledCheckbox) {
                if (enabledCheckbox.checked) {
                    enabledToggle.classList.add("active");
                } else {
                    enabledToggle.classList.remove("active");
                }
            }
        }

        if (addTagBtn)
            addTagBtn.addEventListener("click", function () {
                // 重置开关状态为启用
                if (enabledCheckbox) enabledCheckbox.checked = true;
                syncToggleState();
                showModal(false);
            });
        if (cancelBtn) cancelBtn.addEventListener("click", hideModal);
        if (tagModal) {
            tagModal.addEventListener("click", function (e) {
                if (e.target === e.currentTarget) hideModal();
            });
        }

        if (tagForm) {
            tagForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                var tagIdEl = document.getElementById("tagId");
                var tagNameEl = document.getElementById("tagName");
                var tagSlugEl = document.getElementById("tagSlug");
                var tagColorEl = document.getElementById("tagColor");
                var tagEnabledEl = document.getElementById("tagEnabled");

                var id = tagIdEl ? tagIdEl.value : "";
                var data = {
                    name: tagNameEl ? tagNameEl.value : "",
                    slug: tagSlugEl ? tagSlugEl.value || undefined : undefined,
                    color: tagColorEl ? tagColorEl.value : "#6366f1",
                    enabled: tagEnabledEl ? tagEnabledEl.checked : true,
                };

                try {
                    var result = await window.adminRequest(
                        API_URL + "/tags/" + (id || ""),
                        {
                            method: id ? "PUT" : "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization:
                                    "Bearer " +
                                    localStorage.getItem("adminToken"),
                            },
                            body: JSON.stringify(data),
                        },
                    );

                    if (result.ok) {
                        hideModal();
                        loadTags();
                    } else {
                        window.showAdminAlert(result.msg || "Save failed", "error");
                    }
                } catch (err) {
                    window.showAdminAlert("Save failed", "error");
                }
            });
        }

        function initTagsPage() {
            // 检查是否在标签管理页面
            if (!document.getElementById('tagsContainer')) return;
            loadTags();
        }

        // 监听 SPA 导航
        document.addEventListener('astro:page-load', initTagsPage);

        // 首次加载
        initTagsPage();
    })();
</script>

<style>
    .modal-input {
        @apply w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700/50 bg-white/80 dark:bg-zinc-800/80 text-zinc-900 dark:text-zinc-100 outline-none transition-all duration-300 placeholder:text-zinc-400 dark:placeholder:text-zinc-500;
        box-shadow:
            0 1px 3px rgba(0, 0, 0, 0.04),
            0 1px 2px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
    }

    .modal-input:hover {
        @apply border-zinc-300 dark:border-zinc-600;
        box-shadow:
            0 2px 8px rgba(0, 0, 0, 0.06),
            0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .modal-input:focus {
        @apply border-indigo-400 dark:border-indigo-500/70 ring-4 ring-indigo-500/10 dark:ring-indigo-500/20;
        box-shadow:
            0 0 0 4px rgba(99, 102, 241, 0.1),
            0 2px 8px rgba(99, 102, 241, 0.15);
    }

    :global(.dark) .modal-input:focus {
        box-shadow:
            0 0 0 4px rgba(99, 102, 241, 0.15),
            0 0 20px rgba(99, 102, 241, 0.2);
    }
</style>
