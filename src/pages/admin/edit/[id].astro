---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "../../../config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

const { id } = Astro.params;
const isEdit = true;

// i18n translations for inline script
const editI18n = {
    requiredFields: i18n(I18nKey.adminRequiredFields),
    contentEmpty: i18n(I18nKey.adminContentEmpty),
    saveFailed: i18n(I18nKey.adminSaveFailed),
    updating: i18n(I18nKey.adminPostUpdating),
    update: i18n(I18nKey.adminPostUpdate),
    loadFailed: i18n(I18nKey.adminPostLoadFailed),
};
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();
---

<AdminLayout title={`${i18n(I18nKey.adminEditPost)} - ${siteConfig.title}`}>
    <div
        id="editorContainer"
        data-post-id={id}
        class="h-[calc(100vh-64px)] flex flex-col overflow-y-auto lg:overflow-hidden"
    >
        <!-- Header -->
        <div
            class="px-4 sm:px-6 lg:px-8 py-3 sm:py-4 bg-white dark:bg-zinc-900 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between shadow-sm z-10"
        >
            <div class="flex items-center gap-4">
                <a
                    href="/admin/posts"
                    data-admin-back="posts"
                    class="p-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors text-zinc-500"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-lg sm:text-xl font-bold text-zinc-900 dark:text-zinc-100">
                    {i18n(I18nKey.adminEditPost)}
                </h1>
            </div>
            <div class="flex items-center gap-3">
                <button
                    type="button"
                    id="openEditorImagePicker"
                    class="px-4 py-2 rounded-xl bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-700 dark:text-zinc-300 font-medium transition-all"
                >
                    插入 图片
                </button>
                <button
                    id="saveBtn"
                    class="bg-[var(--primary)] dark:bg-zinc-800 hover:opacity-90 dark:hover:bg-zinc-700 text-white dark:text-zinc-100 px-4 sm:px-6 py-2 rounded-xl font-bold transition-all shadow-md hover:shadow-lg active:scale-95 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]"
                    data-update-text={i18n(I18nKey.adminPostUpdate)}
                    data-updating-text={i18n(I18nKey.adminPostUpdating)}
                >
                    {i18n(I18nKey.adminPostUpdate)}
                </button>
            </div>
        </div>

        <div class="flex-none lg:flex-1 flex flex-col lg:flex-row lg:overflow-hidden">
            <!-- Left Side: Editor -->
            <div
                class="flex-none lg:flex-1 flex flex-col p-4 sm:p-6 lg:p-8 lg:overflow-y-auto custom-scrollbar bg-white dark:bg-zinc-900 border-b border-zinc-200 dark:border-zinc-800 lg:border-b-0 lg:border-r"
            >
                <input
                    type="text"
                    id="title"
                    placeholder={i18n(I18nKey.adminPostTitlePlaceholder)}
                    class="text-2xl sm:text-3xl lg:text-4xl font-bold bg-transparent border-none outline-none mb-6 placeholder:text-zinc-300 dark:placeholder:text-zinc-700 text-zinc-900 dark:text-zinc-100"
                />
                <div id="vditor" class="flex-1 h-[60vh] lg:h-auto border-none shadow-none"></div>
            </div>

            <!-- Right Side: Settings -->
            <div
                class="w-full lg:w-80 bg-zinc-50/50 dark:bg-zinc-950/50 p-4 sm:p-6 lg:p-6 lg:overflow-y-auto custom-scrollbar backdrop-blur-sm border-t border-zinc-200 dark:border-zinc-800 lg:border-t-0"
            >
                <div class="space-y-8">
                    <!-- Basic Info Section -->
                    <section>
                        <h3
                            class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-4 flex items-center gap-2"
                        >
                            <svg
                                class="w-1 h-1 rounded-full bg-zinc-400"
                                fill="currentColor"
                                viewBox="0 0 4 4"
                                ><circle cx="2" cy="2" r="2"></circle></svg
                            >
                            {i18n(I18nKey.adminSectionBasicInfo)}
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                    >{i18n(I18nKey.adminPostSlug)}</label
                                >
                                <input
                                    id="slug"
                                    type="text"
                                    placeholder={i18n(I18nKey.adminPostSlugPlaceholder)}
                                    class="admin-input"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                    >{i18n(I18nKey.adminPostCategoryLabel)}</label
                                >
                                <select
                                    id="category"
                                    class="admin-input"
                                >
                                    <option value="">{i18n(I18nKey.adminPostCategoryPlaceholder)}</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                    >{i18n(I18nKey.adminPostTags)}</label
                                >
                                <div id="tagsContainer" class="tags-selector">
                                    <span class="text-sm text-zinc-400 italic">{i18n(I18nKey.adminLoading)}</span>
                                </div>
                                <p class="text-xs text-zinc-400 mt-2">{i18n(I18nKey.adminPostTagsHint)}</p>
                                <input type="hidden" id="selectedTags" value="" />
                            </div>
                        </div>
                    </section>

                    <!-- Media Section -->
                    <section>
                        <h3
                            class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-4 flex items-center gap-2"
                        >
                            <svg
                                class="w-1 h-1 rounded-full bg-zinc-400"
                                fill="currentColor"
                                viewBox="0 0 4 4"
                                ><circle cx="2" cy="2" r="2"></circle></svg
                            >
                            {i18n(I18nKey.adminSectionAppearance)}
                        </h3>
                        <div>
                            <label
                                class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                >{i18n(I18nKey.adminPostImage)}</label
                            >
                            <div class="flex items-center gap-2">
                                <input
                                    id="image"
                                    type="text"
                                    placeholder={i18n(I18nKey.adminPostImagePlaceholder)}
                                    class="admin-input flex-1"
                                />
                                <button
                                    type="button"
                                    id="openCoverPicker"
                                    class="px-3 py-2 rounded-xl bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-700 dark:text-zinc-300 text-sm font-medium transition-all"
                                >
                                    从媒体库
                                </button>
                            </div>
                            <div
                                id="imagePreview"
                                class="mt-2 w-full aspect-video rounded-lg overflow-hidden border border-zinc-200 dark:border-zinc-800 bg-zinc-100 dark:bg-zinc-900 hidden"
                            >
                                <img
                                    src=""
                                    alt="Preview"
                                    class="w-full h-full object-cover"
                                />
                            </div>
                        </div>
                    </section>

                    <!-- Advanced Section -->
                    <section>
                        <h3
                            class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-4 flex items-center gap-2"
                        >
                            <svg
                                class="w-1 h-1 rounded-full bg-zinc-400"
                                fill="currentColor"
                                viewBox="0 0 4 4"
                                ><circle cx="2" cy="2" r="2"></circle></svg
                            >
                            {i18n(I18nKey.adminSectionAdvanced)}
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                    >{i18n(I18nKey.adminPostPassword)}</label
                                >
                                <div class="relative">
                                    <input
                                        id="password"
                                        type="password"
                                        placeholder={i18n(I18nKey.adminPostPasswordPlaceholder)}
                                        class="admin-input pr-12"
                                    />
                                    <button
                                        type="button"
                                        id="password-toggle"
                                        class="admin-password-toggle"
                                        aria-label="显示密码"
                                        title="显示密码"
                                    >
                                        <svg data-eye="show" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M2.5 12s3.5-6.5 9.5-6.5 9.5 6.5 9.5 6.5-3.5 6.5-9.5 6.5S2.5 12 2.5 12z"></path>
                                            <circle cx="12" cy="12" r="3.5"></circle>
                                        </svg>
                                        <svg data-eye="hide" class="w-5 h-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M3 3l18 18"></path>
                                            <path d="M10.5 5.2A9.9 9.9 0 0 1 12 5c6 0 9.5 7 9.5 7a18.2 18.2 0 0 1-4 4.8"></path>
                                            <path d="M6.4 6.4A18.4 18.4 0 0 0 2.5 12s3.5 6.5 9.5 6.5c1.6 0 3-.4 4.2-1"></path>
                                            <path d="M9.9 9.9a3.5 3.5 0 0 0 4.2 4.2"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <!-- 置顶开关 -->
                            <div
                                class="flex items-center gap-3 cursor-pointer group"
                                id="pinnedToggle"
                            >
                                <div
                                    class="w-10 h-6 bg-zinc-200 dark:bg-zinc-800 rounded-full relative transition-colors duration-300"
                                    id="pinnedToggleTrack"
                                >
                                    <div
                                        class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 shadow-sm"
                                        id="pinnedToggleHandle"
                                    >
                                    </div>
                                </div>
                                <span
                                    class="text-sm font-medium text-zinc-600 dark:text-zinc-400 group-hover:text-zinc-900 dark:group-hover:text-zinc-100 transition-colors"
                                    >{i18n(I18nKey.pinned)}</span
                                >
                            </div>
                            <!-- 置顶排序 -->
                            <div id="pinOrderContainer" class="hidden">
                                <label
                                    class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                    >{i18n(I18nKey.adminPostPinOrder)}</label
                                >
                                <input
                                    id="pinOrder"
                                    type="number"
                                    min="0"
                                    value="0"
                                    placeholder={i18n(I18nKey.adminPostPinOrderPlaceholder)}
                                    class="admin-input"
                                />
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight">发布状态</label>
                                <select id="statusSelect" class="admin-input">
                                    <option value="published">{i18n(I18nKey.adminPostPublish)}</option>
                                    <option value="draft">保存草稿</option>
                                    <option value="scheduled">定时发布</option>
                                </select>
                                <p class="text-xs text-zinc-400 mt-2">选择文章发布方式，定时发布需要设置具体时间。</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight">自定义发布时间</label>
                                <input type="datetime-local" id="publishedAt" class="admin-input" />
                                <p class="text-xs text-zinc-400 mt-2">可选：用于回填历史文章或调整发布时间。</p>
                            </div>
                            <div id="scheduledWrapper" class="hidden">
                                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight">定时发布时间</label>
                                <input type="datetime-local" id="scheduledAt" class="admin-input" />
                                <p class="text-xs text-amber-500 mt-2">启用定时发布后系统将在指定时间自动发布。</p>
                            </div>
                            <div id="autosaveNotice" class="hidden rounded-xl border border-amber-300 bg-amber-50 dark:bg-amber-900/20 p-3 space-y-2 text-xs text-amber-700 dark:text-amber-200">
                                <div class="font-semibold">检测到未发布的自动保存内容</div>
                                <div class="flex gap-2">
                                    <button id="loadAutosaveBtn" type="button" class="px-3 py-1 rounded-lg bg-amber-600 text-white text-xs hover:bg-amber-500 transition">
                                        恢复内容
                                    </button>
                                    <button id="discardAutosaveBtn" type="button" class="px-3 py-1 rounded-lg border border-amber-400 text-amber-600 dark:text-amber-200 text-xs hover:bg-amber-100/50 transition">
                                        忽略
                                    </button>
                                </div>
                                <p id="autosaveStatus" class="text-[11px] text-amber-600/80"></p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight">历史版本</label>
                                <div id="revisionList" class="space-y-3 text-sm text-zinc-500">
                                    加载中...
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="mb-4">
                        <label
                            class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                            >{i18n(I18nKey.adminPostDescription)}</label
                        >
                        <textarea
                            id="description"
                            rows="3"
                            placeholder={i18n(I18nKey.adminPostDescriptionPlaceholder)}
                            class="admin-input resize-none"></textarea>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script is:inline define:vars={{ editI18n }}>
        window.editI18n = editI18n;
    </script>

    <script
        is:inline
        src="/assets/vendor/vditor/index.min.js"
    ></script>

    <script is:inline>
    (function() {
        // 使用页面特定的标识符来检测重复初始化
        var pageId = document.getElementById("editorContainer")?.dataset.postId;
        var initKey = '_editPage_' + pageId + '_initialized';
        var backButton = document.querySelector('[data-admin-back="posts"]');

        function bindBackButton() {
            if (!backButton || backButton.dataset.bound === "true") {
                return;
            }
            backButton.dataset.bound = "true";
            backButton.addEventListener("click", function (event) {
                event.preventDefault();
                if (window.__adminTabManager && typeof window.__adminTabManager.closeCurrentAndNavigate === "function") {
                    window.__adminTabManager.closeCurrentAndNavigate("/admin/posts");
                    return;
                }
                if (window.__adminTabManager && typeof window.__adminTabManager.close === "function") {
                    window.__adminTabManager.close(window.location.pathname);
                }
                if (window.__adminTabManager && typeof window.__adminTabManager.navigate === "function") {
                    window.__adminTabManager.navigate("/admin/posts");
                } else {
                    window.location.href = "/admin/posts";
                }
            });
        }

        bindBackButton();

        // Prevent duplicate initialization for the same post
        if (window[initKey]) {
            console.log("Edit page already initialized for post " + pageId + ", skipping...");
            return;
        }
        window[initKey] = true;

        // Get i18n translations
        const t = window.editI18n || {};
        const API_URL = window.API_URL;

        let vditor = null;
        let postStatus = "draft";
        let isPinned = false;
        let initTimer = null;
        let selectedTagIds = []; // 存储选中的标签ID
        let allTags = []; // 存储所有标签数据
        let currentPostCategory = ''; // 存储当前文章的分类
        let currentPostTags = []; // 存储当前文章的标签
        const statusSelect = document.getElementById("statusSelect");
        const scheduledAtInput = document.getElementById("scheduledAt");
        const scheduledWrapper = document.getElementById("scheduledWrapper");
        const publishedAtInput = document.getElementById("publishedAt");
        const passwordInput = document.getElementById("password");
        const passwordToggle = document.getElementById("password-toggle");
        const autosaveNotice = document.getElementById("autosaveNotice");
        const loadAutosaveBtn = document.getElementById("loadAutosaveBtn");
        const discardAutosaveBtn = document.getElementById("discardAutosaveBtn");
        const autosaveStatus = document.getElementById("autosaveStatus");
        const revisionList = document.getElementById("revisionList");
        let autosaveTimer = null;
        const AUTOSAVE_INTERVAL = 30000;
        let lastAutosaveSignature = "";
        let cachedAutosavePayload = null;
        let cachedAutosaveTime = null;

        function convertLocalToISO(value) {
            if (!value) return null;
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return null;
            return date.toISOString();
        }

        function formatDatetimeForInput(value) {
            if (!value) return "";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return "";
            const tzOffset = date.getTimezoneOffset() * 60000;
            const localISO = new Date(date.getTime() - tzOffset).toISOString();
            return localISO.slice(0, 16);
        }

        function updateStatusUI(value) {
            postStatus = value;
            if (scheduledWrapper) {
                if (value === "scheduled") {
                    scheduledWrapper.classList.remove("hidden");
                } else {
                    scheduledWrapper.classList.add("hidden");
                }
            }
        }

        statusSelect?.addEventListener("change", function(event) {
            updateStatusUI(event.target.value);
        });
        if (statusSelect) {
            statusSelect.value = postStatus;
        }
        updateStatusUI(postStatus);
        setupMediaPicker();

        function setupMediaPicker() {
            var modal = document.getElementById("mediaPickerModal");
            if (!modal || modal.dataset.bound === "true") {
                return;
            }
            modal.dataset.bound = "true";

            var openCoverBtn = document.getElementById("openCoverPicker");
            var openEditorBtn = document.getElementById("openEditorImagePicker");
            var closeBtn = document.getElementById("mediaPickerClose");
            var searchInput = document.getElementById("mediaPickerSearch");
            var grid = document.getElementById("mediaPickerGrid");
            var countEl = document.getElementById("mediaPickerCount");
            var prevBtn = document.getElementById("mediaPickerPrev");
            var nextBtn = document.getElementById("mediaPickerNext");
            var pageEl = document.getElementById("mediaPickerPage");

            var pickerMode = "cover";
            var currentPage = 1;
            var totalPages = 1;
            var keyword = "";
            var searchTimer = null;

            function getEditorInstance() {
                return window._editPageVditor || vditor;
            }

            function sanitizeAlt(text) {
                return (text || "image").replace(/\]/g, "\\]");
            }

            function isImageItem(item) {
                if (item.mime_type && item.mime_type.indexOf("image/") === 0) {
                    return true;
                }
                var name = item.filename || "";
                var ext = name.toLowerCase().split(".").pop();
                return ["jpg", "jpeg", "png", "gif", "webp", "svg"].includes(ext);
            }

            function setCoverImage(url) {
                var imageInput = document.getElementById("image");
                if (!imageInput) return;
                imageInput.value = url;
                imageInput.dispatchEvent(new Event("input"));
            }

            function insertImageToEditor(url, name) {
                var editor = getEditorInstance();
                if (!editor || typeof editor.insertValue !== "function") {
                    window.showAdminAlert("编辑器尚未就绪，请稍后重试", "warning");
                    return;
                }
                var alt = sanitizeAlt(name || "image");
                editor.insertValue("![" + alt + "](" + url + ")");
            }

            function openPicker(mode) {
                pickerMode = mode;
                currentPage = 1;
                keyword = "";
                if (searchInput) searchInput.value = "";
                modal.classList.remove("hidden");
                modal.classList.add("flex");
                loadMedia();
            }

            function closePicker() {
                modal.classList.add("hidden");
                modal.classList.remove("flex");
            }

            async function loadMedia() {
                if (!grid) return;
                grid.innerHTML = '<div class="col-span-full text-center text-sm text-zinc-500 py-10">加载中...</div>';

                try {
                    var query = "page=" + currentPage + "&page_size=40";
                    if (keyword) {
                        query += "&keyword=" + encodeURIComponent(keyword);
                    }
                    var result = await window.adminRequest(API_URL + "/upload/media?" + query, {
                        headers: {
                            "Authorization": "Bearer " + localStorage.getItem("adminToken")
                        }
                    });

                    if (!result.ok) {
                        throw new Error(result.msg || "加载失败");
                    }

                    var data = result.data || {};
                    var items = (data.items || []).filter(isImageItem);
                    var total = data.pagination ? data.pagination.total : items.length;
                    totalPages = data.pagination ? data.pagination.total_pages : 1;

                    if (countEl) {
                        countEl.textContent = "共 " + total + " 张图片";
                    }
                    if (pageEl) {
                        pageEl.textContent = currentPage + "/" + (totalPages || 1);
                    }
                    if (prevBtn) prevBtn.disabled = currentPage <= 1;
                    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;

                    if (items.length === 0) {
                        grid.innerHTML = '<div class="col-span-full text-center text-sm text-zinc-500 py-10">暂无图片</div>';
                        return;
                    }

                    grid.innerHTML = items.map(function(item) {
                        var name = item.original_name || item.filename || "image";
                        return '' +
                            '<button type="button" class="group text-left rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden bg-white dark:bg-zinc-900 hover:border-[var(--primary)]/50 transition-all" data-url="' + item.url + '" data-name="' + name + '">' +
                                '<div class="aspect-square bg-zinc-100 dark:bg-zinc-800 overflow-hidden">' +
                                    '<img src="' + item.url + '" alt="' + name + '" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition-transform" />' +
                                '</div>' +
                                '<div class="px-2 py-1.5 text-xs text-zinc-600 dark:text-zinc-300 truncate">' + name + '</div>' +
                            '</button>';
                    }).join("");

                    grid.querySelectorAll("button[data-url]").forEach(function(btn) {
                        btn.addEventListener("click", function() {
                            var url = this.dataset.url;
                            var name = this.dataset.name || "image";
                            if (pickerMode === "cover") {
                                setCoverImage(url);
                            } else {
                                insertImageToEditor(url, name);
                            }
                            closePicker();
                        });
                    });
                } catch (err) {
                    console.error("加载媒体失败:", err);
                    grid.innerHTML = '<div class="col-span-full text-center text-sm text-red-500 py-10">加载失败</div>';
                }
            }

            openCoverBtn?.addEventListener("click", function() {
                openPicker("cover");
            });

            openEditorBtn?.addEventListener("click", function() {
                openPicker("editor");
            });

            closeBtn?.addEventListener("click", closePicker);
            modal?.addEventListener("click", function(e) {
                if (e.target === modal) {
                    closePicker();
                }
            });

            searchInput?.addEventListener("input", function() {
                keyword = this.value.trim();
                clearTimeout(searchTimer);
                searchTimer = setTimeout(function() {
                    currentPage = 1;
                    loadMedia();
                }, 300);
            });

            prevBtn?.addEventListener("click", function() {
                if (currentPage > 1) {
                    currentPage -= 1;
                    loadMedia();
                }
            });

            nextBtn?.addEventListener("click", function() {
                if (currentPage < totalPages) {
                    currentPage += 1;
                    loadMedia();
                }
            });
        }

        function initPasswordToggle() {
            if (!passwordInput || !passwordToggle) {
                return;
            }
            if (passwordToggle.dataset.bound === "true") {
                return;
            }
            passwordToggle.dataset.bound = "true";

            const showIcon = passwordToggle.querySelector('[data-eye="show"]');
            const hideIcon = passwordToggle.querySelector('[data-eye="hide"]');

            function updatePasswordVisibility(isVisible) {
                passwordInput.type = isVisible ? "text" : "password";
                passwordToggle.setAttribute("aria-label", isVisible ? "隐藏密码" : "显示密码");
                passwordToggle.setAttribute("title", isVisible ? "隐藏密码" : "显示密码");
                if (showIcon) showIcon.classList.toggle("hidden", isVisible);
                if (hideIcon) hideIcon.classList.toggle("hidden", !isVisible);
            }

            let isVisible = false;
            updatePasswordVisibility(isVisible);

            passwordToggle.addEventListener("click", function () {
                isVisible = !isVisible;
                updatePasswordVisibility(isVisible);
                passwordInput.focus();
            });
        }

        function updateAutosaveStatus(savedAt) {
            if (!autosaveStatus) return;
            if (!savedAt) {
                autosaveStatus.textContent = "";
                return;
            }
            const date = new Date(savedAt);
            autosaveStatus.textContent = "最后自动保存：" + date.toLocaleString();
        }

        function showAutosaveNotice(savedAt) {
            autosaveNotice?.classList.remove("hidden");
            updateAutosaveStatus(savedAt || cachedAutosaveTime);
        }

        function hideAutosaveNotice() {
            autosaveNotice?.classList.add("hidden");
            updateAutosaveStatus(null);
            cachedAutosavePayload = null;
            cachedAutosaveTime = null;
        }

        async function fetchAutosaveData(postId) {
            try {
                const token = localStorage.getItem("adminToken");
                if (!token) return;
                const result = await window.adminRequest(`${API_URL}/posts/${postId}/autosave`, {
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });
                if (result.ok && result.data && result.data.data) {
                    cachedAutosavePayload = result.data.data;
                    cachedAutosaveTime = result.data.saved_at;
                    showAutosaveNotice(result.data.saved_at);
                } else {
                    hideAutosaveNotice();
                }
            } catch (err) {
                console.error("加载自动保存内容失败:", err);
            }
        }

        function applyAutosavePayload(payload) {
            if (!payload) return;
            const titleEl = document.getElementById("title");
            const slugEl = document.getElementById("slug");
            const descriptionEl = document.getElementById("description");
            const imageEl = document.getElementById("image");
            const passwordEl = document.getElementById("password");

            if (titleEl) titleEl.value = payload.title || "";
            if (slugEl) slugEl.value = payload.slug || "";
            if (descriptionEl) descriptionEl.value = payload.description || "";
            if (imageEl) imageEl.value = payload.image || "";
            if (passwordEl) passwordEl.value = payload.password || "";

            if (payload.category_name) {
                const categorySelect = document.getElementById("category");
                if (categorySelect) {
                    categorySelect.value = payload.category_name;
                }
            }
            if (payload.tags && payload.tags.length) {
                currentPostTags = payload.tags;
                loadTags(payload.tags);
            }
            if (payload.content && vditor) {
                vditor.setValue(payload.content);
            }
        }

        loadAutosaveBtn?.addEventListener("click", async function() {
            if (!pageId) return;
            if (!cachedAutosavePayload) {
                await fetchAutosaveData(pageId);
            }
            if (cachedAutosavePayload) {
                applyAutosavePayload(cachedAutosavePayload);
                hideAutosaveNotice();
                window.showAdminAlert("已恢复自动保存内容", "success");
            }
        });

        discardAutosaveBtn?.addEventListener("click", async function() {
            if (!pageId) return;
            const token = localStorage.getItem("adminToken");
            if (!token) return;
            try {
                await window.adminRequest(`${API_URL}/posts/${pageId}/autosave`, {
                    method: "DELETE",
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });
            } catch (err) {
                console.error("清除自动保存失败:", err);
            } finally {
                hideAutosaveNotice();
            }
        });

        function startAutosaveLoop(postId) {
            stopAutosaveLoop();
            if (!postId) return;
            autosaveTimer = setInterval(function() {
                autosaveDraft(postId);
            }, AUTOSAVE_INTERVAL);
        }

        function stopAutosaveLoop() {
            if (autosaveTimer) {
                clearInterval(autosaveTimer);
                autosaveTimer = null;
            }
        }

        async function autosaveDraft(postId) {
            if (!postId || !vditor) return;
            const titleEl = document.getElementById("title");
            const slugEl = document.getElementById("slug");
            const categoryEl = document.getElementById("category");
            const selectedTagsEl = document.getElementById("selectedTags");
            const descriptionEl = document.getElementById("description");
            const imageEl = document.getElementById("image");
            const passwordEl = document.getElementById("password");
            const pinOrderEl = document.getElementById("pinOrder");

            const content = vditor.getValue();
            if (!content) return;

            const tagsValue = selectedTagsEl ? selectedTagsEl.value : '';
            const tagsArray = tagsValue ? tagsValue.split(',').map(function(t) { return t.trim(); }).filter(function(t) { return t; }) : [];

            const payload = {
                title: titleEl ? titleEl.value : "",
                slug: slugEl ? slugEl.value : "",
                category_name: categoryEl ? categoryEl.value || "General" : "General",
                tags: tagsArray,
                description: descriptionEl ? descriptionEl.value : "",
                content: content,
                image: imageEl ? imageEl.value || "" : "",
                password: passwordEl ? passwordEl.value || "" : "",
                pinned: isPinned,
                pin_order: pinOrderEl ? parseInt(pinOrderEl.value) || 0 : 0,
            };

            const signature = JSON.stringify({
                title: payload.title,
                slug: payload.slug,
                description: payload.description,
                content: payload.content,
                category: payload.category_name,
                tags: payload.tags.join(",")
            });

            if (signature === lastAutosaveSignature) {
                return;
            }

            const token = localStorage.getItem("adminToken");
            if (!token) return;

            try {
                const result = await window.adminRequest(`${API_URL}/posts/${postId}/autosave`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token
                    },
                    body: JSON.stringify(payload)
                });
                if (result.ok && result.data) {
                    lastAutosaveSignature = signature;
                    cachedAutosaveTime = result.data.saved_at;
                    showAutosaveNotice(result.data.saved_at);
                }
            } catch (err) {
                console.error("自动保存失败:", err);
            }
        }

        async function loadRevisions(postId) {
            if (!revisionList || !postId) return;
            try {
                const token = localStorage.getItem("adminToken");
                if (!token) return;
                const result = await window.adminRequest(`${API_URL}/posts/${postId}/revisions`, {
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });
                if (result.ok) {
                    const revisions = result.data || [];
                    if (!revisions.length) {
                        revisionList.innerHTML = '<p class="text-xs text-zinc-400">暂无历史版本</p>';
                        return;
                    }
                    revisionList.innerHTML = revisions.map(function(rev) {
                        const date = new Date(rev.created_at).toLocaleString();
                        return '<div class="p-3 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white/70 dark:bg-zinc-900/40 flex items-center justify-between gap-3">' +
                            '<div>' +
                                '<p class="font-medium text-zinc-800 dark:text-zinc-100 text-sm">' + rev.title + '</p>' +
                                '<p class="text-[11px] text-zinc-400">' + date + (rev.editor ? ' · ' + rev.editor : '') + '</p>' +
                            '</div>' +
                            '<div class="flex items-center gap-2">' +
                                '<button type="button" class="px-3 py-1 text-xs rounded-lg border border-zinc-300 text-zinc-600 hover:bg-zinc-50 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800" data-revision-restore="' + rev.id + '">恢复</button>' +
                                '<button type="button" class="px-3 py-1 text-xs rounded-lg border border-rose-300 text-rose-600 hover:bg-rose-50 dark:border-rose-400/40 dark:text-rose-300 dark:hover:bg-rose-900/20" data-revision-delete="' + rev.id + '">删除</button>' +
                            '</div>' +
                        '</div>';
                    }).join('');

                    revisionList.querySelectorAll("[data-revision-restore]").forEach(function(btn) {
                        btn.addEventListener("click", function() {
                            restoreRevision(postId, btn.dataset.revisionRestore);
                        });
                    });
                    revisionList.querySelectorAll("[data-revision-delete]").forEach(function(btn) {
                        btn.addEventListener("click", function() {
                            deleteRevision(postId, btn.dataset.revisionDelete);
                        });
                    });
                } else {
                    revisionList.innerHTML = '<p class="text-xs text-red-400">加载版本记录失败</p>';
                }
            } catch (err) {
                console.error("加载版本记录失败:", err);
                revisionList.innerHTML = '<p class="text-xs text-red-400">加载版本记录失败</p>';
            }
        }

        async function restoreRevision(postId, revisionId) {
            if (!postId || !revisionId) return;
            const token = localStorage.getItem("adminToken");
            if (!token) return;

            try {
                const result = await window.adminRequest(`${API_URL}/posts/${postId}/revisions/${revisionId}/restore`, {
                    method: "POST",
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });
                if (result.ok) {
                    window.showAdminAlert("文章已恢复到选定版本", "success");
                    loadPostData(postId);
                } else {
                    window.showAdminAlert("恢复失败: " + (result.msg || "未知错误"), "error");
                }
            } catch (err) {
                console.error("恢复版本失败:", err);
                window.showAdminAlert("恢复失败: " + err.message, "error");
            }
        }

        async function deleteRevision(postId, revisionId) {
            if (!postId || !revisionId) return;
            const token = localStorage.getItem("adminToken");
            if (!token) return;

            var confirmed = true;
            if (window.showAdminConfirm) {
                confirmed = await window.showAdminConfirm("确定删除该历史版本吗？");
            } else {
                confirmed = window.confirm("确定删除该历史版本吗？");
            }
            if (!confirmed) {
                return;
            }

            try {
                const result = await window.adminRequest(`${API_URL}/posts/${postId}/revisions/${revisionId}`, {
                    method: "DELETE",
                    headers: {
                        Authorization: "Bearer " + token
                    }
                });
                if (result.ok) {
                    window.showAdminAlert("历史版本已删除", "success");
                    loadRevisions(postId);
                } else {
                    window.showAdminAlert("删除失败: " + (result.msg || "未知错误"), "error");
                }
            } catch (err) {
                console.error("删除版本失败:", err);
                window.showAdminAlert("删除失败: " + err.message, "error");
            }
        }

        // 加载分类列表
        async function loadCategories(selectedCategory) {
            const categorySelect = document.getElementById('category');
            if (!categorySelect) return;

            try {
                const result = await window.adminRequest(API_URL + '/categories');
                if (result.ok) {
                    const categories = result.data || [];
                    // 保留第一个占位选项
                    const placeholder = categorySelect.querySelector('option');
                    categorySelect.innerHTML = '';
                    if (placeholder) categorySelect.appendChild(placeholder);

                    categories.forEach(function(cat) {
                        if (cat.enabled) {
                            const option = document.createElement('option');
                            option.value = cat.name;
                            option.textContent = cat.name;
                            if (cat.color) {
                                option.style.color = cat.color;
                            }
                            // 如果是当前文章的分类，设置为选中
                            if (selectedCategory && cat.name === selectedCategory) {
                                option.selected = true;
                            }
                            categorySelect.appendChild(option);
                        }
                    });
                }
            } catch (err) {
                console.error('加载分类失败:', err);
            }
        }

        // 加载标签列表
        async function loadTags(selectedTagNames) {
            const tagsContainer = document.getElementById('tagsContainer');
            if (!tagsContainer) return;

            try {
                const result = await window.adminRequest(API_URL + '/tags');
                if (result.ok) {
                    allTags = result.data || [];
                    // 根据标签名称找到对应的ID
                    if (selectedTagNames && selectedTagNames.length > 0) {
                        selectedTagIds = allTags
                            .filter(function(tag) {
                                return selectedTagNames.indexOf(tag.name) !== -1;
                            })
                            .map(function(tag) {
                                return tag.id;
                            });
                    }
                    renderTags();
                } else {
                    tagsContainer.innerHTML = '<span class="text-sm text-red-500">加载标签失败</span>';
                }
            } catch (err) {
                console.error('加载标签失败:', err);
                tagsContainer.innerHTML = '<span class="text-sm text-red-500">加载标签失败</span>';
            }
        }

        // 渲染标签选择器
        function renderTags() {
            const tagsContainer = document.getElementById('tagsContainer');
            if (!tagsContainer || !allTags.length) {
                if (tagsContainer) {
                    tagsContainer.innerHTML = '<span class="text-sm text-zinc-400">暂无可用标签</span>';
                }
                return;
            }

            tagsContainer.innerHTML = allTags.filter(function(tag) {
                return tag.enabled;
            }).map(function(tag) {
                const isSelected = selectedTagIds.indexOf(tag.id) !== -1;
                const bgColor = isSelected ? (tag.color || '#6366f1') : 'transparent';
                const textColor = isSelected ? '#fff' : (tag.color || '#71717a');
                const borderColor = tag.color || '#d4d4d8';

                return '<button type="button" ' +
                    'class="tag-btn px-3 py-1.5 text-xs font-medium rounded-full border transition-all hover:opacity-80" ' +
                    'data-tag-id="' + tag.id + '" ' +
                    'data-tag-name="' + tag.name + '" ' +
                    'data-tag-color="' + (tag.color || '#6366f1') + '" ' +
                    'style="background-color: ' + bgColor + '; color: ' + textColor + '; border-color: ' + borderColor + ';">' +
                    tag.name +
                '</button>';
            }).join('');

            // 绑定点击事件
            tagsContainer.querySelectorAll('.tag-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const tagId = this.getAttribute('data-tag-id');
                    const tagColor = this.getAttribute('data-tag-color');
                    const idx = selectedTagIds.indexOf(tagId);

                    if (idx === -1) {
                        // 选中
                        selectedTagIds.push(tagId);
                        this.style.backgroundColor = tagColor;
                        this.style.color = '#fff';
                    } else {
                        // 取消选中
                        selectedTagIds.splice(idx, 1);
                        this.style.backgroundColor = 'transparent';
                        this.style.color = tagColor;
                    }

                    // 更新隐藏字段
                    updateSelectedTagsInput();
                });
            });

            // 初始化时也更新隐藏字段
            updateSelectedTagsInput();
        }

        // 更新隐藏的标签输入字段
        function updateSelectedTagsInput() {
            const input = document.getElementById('selectedTags');
            if (input) {
                // 获取选中标签的名称
                const selectedNames = selectedTagIds.map(function(id) {
                    const tag = allTags.find(function(t) { return t.id === id; });
                    return tag ? tag.name : '';
                }).filter(function(name) { return name; });
                input.value = selectedNames.join(',');
            }
        }

        // Initialize function
        function init() {
            // Clear previous timer
            if (initTimer) {
                clearTimeout(initTimer);
                initTimer = null;
            }

            // Check if Vditor is available
            if (typeof Vditor === "undefined") {
                console.log("Vditor is not loaded, retrying in 300ms...");
                initTimer = setTimeout(init, 300);
                return;
            }

            // Skip if already initialized
            if (vditor) {
                console.log("Vditor already initialized, skipping...");
                return;
            }

            const container = document.getElementById("editorContainer");
            const postId = container?.dataset.postId;

            if (!postId) {
                console.error("No post ID found!");
                return;
            }

            console.log("Initializing Vditor for post:", postId);

            // Initialize Vditor - 使用本地资源
            vditor = new Vditor("vditor", {
                height: "100%",
                mode: "ir",
                placeholder: "Loading content...",
                cdn: "/assets/vendor/vditor",
                cache: { enable: false },
                theme: document.documentElement.classList.contains("dark")
                    ? "dark"
                    : "classic",
                preview: {
                    theme: {
                        current: document.documentElement.classList.contains("dark")
                            ? "dark"
                            : "light",
                    },
                },
                toolbarConfig: { pin: true },
                after: function () {
                    console.log("Vditor ready, loading post data...");
                    loadPostData(postId);
                },
            });

            // 保存到全局以便清理
            window._editPageVditor = vditor;
        }

        function loadPostData(postId) {
            window.adminRequest(`${API_URL}/posts/` + postId)
                .then(function(result) {
                    if (!result.ok) throw new Error(result.msg || ("HTTP " + result.code));
                    return result.data;
                })
                .then(function(data) {
                    // Fill form fields
                    var titleEl = document.getElementById("title");
                    var slugEl = document.getElementById("slug");
                    var descriptionEl = document.getElementById("description");
                    var imageEl = document.getElementById("image");
                    var passwordEl = document.getElementById("password");

                    if (titleEl) titleEl.value = data.title || "";
                    if (slugEl) slugEl.value = data.slug || "";
                    if (descriptionEl) descriptionEl.value = data.description || "";
                    if (imageEl) imageEl.value = data.image || "";
                    if (passwordEl) passwordEl.value = data.password || "";

                    // 加载分类列表并选中当前分类
                    loadCategories(data.category || "");

                    // 加载标签列表并选中当前标签
                    loadTags(data.tags || []);

                    // Set content
                    if (vditor && data.content) {
                        vditor.setValue(data.content);
                    }

                    postStatus = data.status || (data.is_draft ? "draft" : "published");
                    if (statusSelect) {
                        statusSelect.value = postStatus;
                    }
                    if (publishedAtInput) {
                        publishedAtInput.value = formatDatetimeForInput(data.published_at);
                    }
                    if (scheduledAtInput) {
                        scheduledAtInput.value = formatDatetimeForInput(data.scheduled_at);
                    }
                    updateStatusUI(postStatus);

                    // Handle pinned status
                    if (data.pinned) {
                        isPinned = true;
                        updatePinnedUI();
                    }

                    // Handle pin_order
                    var pinOrderEl = document.getElementById("pinOrder");
                    if (pinOrderEl && data.pin_order !== undefined) {
                        pinOrderEl.value = data.pin_order || 0;
                    }

                    // Handle image preview
                    if (data.image) {
                        var preview = document.getElementById("imagePreview");
                        var img = preview ? preview.querySelector("img") : null;
                        if (preview && img) {
                            img.src = data.image;
                            preview.classList.remove("hidden");
                        }
                    }

                    if (data.autosave_available) {
                        showAutosaveNotice();
                        fetchAutosaveData(postId);
                    } else {
                        hideAutosaveNotice();
                    }

                    loadRevisions(postId);
                    startAutosaveLoop(postId);
                    console.log("Data loaded successfully");
                })
                .catch(function(err) {
                    console.error("Error loading data:", err);
                    window.showAdminAlert((t.loadFailed || 'Load failed') + ": " + err.message, "error");
                });
        }

        function updatePinnedUI() {
            var track = document.getElementById("pinnedToggleTrack");
            var handle = document.getElementById("pinnedToggleHandle");
            var pinOrderContainer = document.getElementById("pinOrderContainer");
            if (isPinned) {
                if (track) {
                    track.classList.add("bg-indigo-500");
                    track.classList.remove("bg-zinc-200", "dark:bg-zinc-800");
                }
                if (handle) handle.classList.add("translate-x-4");
                if (pinOrderContainer) pinOrderContainer.classList.remove("hidden");
            } else {
                if (track) {
                    track.classList.remove("bg-indigo-500");
                    track.classList.add("bg-zinc-200", "dark:bg-zinc-800");
                }
                if (handle) handle.classList.remove("translate-x-4");
                if (pinOrderContainer) pinOrderContainer.classList.add("hidden");
            }
        }

        // Event listeners
        var titleInput = document.getElementById("title");
        if (titleInput) {
            titleInput.addEventListener("input", function(e) {
                var title = e.target.value;
                var slugInput = document.getElementById("slug");
                if (slugInput && !slugInput.dataset.manual) {
                    slugInput.value = title
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, "-")
                        .replace(/(^-|-$)/g, "");
                }
            });
        }

        var slugInput = document.getElementById("slug");
        if (slugInput) {
            slugInput.addEventListener("input", function(e) {
                e.target.dataset.manual = "true";
            });
        }

        var imageInput = document.getElementById("image");
        if (imageInput) {
            imageInput.addEventListener("input", function(e) {
                var url = e.target.value;
                var preview = document.getElementById("imagePreview");
                var img = preview ? preview.querySelector("img") : null;
                if (url && preview && img) {
                    img.src = url;
                    preview.classList.remove("hidden");
                } else if (preview) {
                    preview.classList.add("hidden");
                }
            });
        }

        var pinnedToggle = document.getElementById("pinnedToggle");
        if (pinnedToggle) {
            pinnedToggle.addEventListener("click", function() {
                isPinned = !isPinned;
                updatePinnedUI();
            });
        }

        var saveBtn = document.getElementById("saveBtn");
        if (saveBtn) {
            saveBtn.addEventListener("click", async function() {
                var container = document.getElementById("editorContainer");
                var postId = container ? container.dataset.postId : null;

                var titleEl = document.getElementById("title");
                var slugEl = document.getElementById("slug");
                var title = titleEl ? titleEl.value : '';
                var slug = slugEl ? slugEl.value : '';

                if (!title || !slug) {
                    window.showAdminAlert(t.requiredFields || "Title and slug are required", "warning");
                    return;
                }

                if (!vditor) {
                    window.showAdminAlert("Editor not initialized", "error");
                    return;
                }

                var content = vditor.getValue();
                if (!content) {
                    window.showAdminAlert(t.contentEmpty || "Content cannot be empty", "warning");
                    return;
                }

                var categoryEl = document.getElementById("category");
                var selectedTagsEl = document.getElementById("selectedTags");
                var descriptionEl = document.getElementById("description");
                var imageEl = document.getElementById("image");
                var passwordEl = document.getElementById("password");
                var pinOrderEl = document.getElementById("pinOrder");

                var statusValue = statusSelect ? statusSelect.value : postStatus;
                updateStatusUI(statusValue);
                var scheduledISO = convertLocalToISO(scheduledAtInput ? scheduledAtInput.value : "");
                var publishedISO = convertLocalToISO(publishedAtInput ? publishedAtInput.value : "");

                if (statusValue === "scheduled" && !scheduledISO) {
                    window.showAdminAlert("请设置定时发布时间", "warning");
                    return;
                }

                // 获取选中的标签名称
                var tagsValue = selectedTagsEl ? selectedTagsEl.value : '';
                var tagsArray = tagsValue ? tagsValue.split(',').map(function(t) { return t.trim(); }).filter(function(t) { return t; }) : [];

                var postData = {
                    title: title,
                    slug: slug,
                    category_name: categoryEl ? categoryEl.value || "General" : "General",
                    tags: tagsArray,
                    description: descriptionEl ? descriptionEl.value : "",
                    content: content,
                    image: imageEl ? imageEl.value || "" : "",
                    password: passwordEl ? passwordEl.value || "" : "",
                    is_draft: statusValue !== "published",
                    status: statusValue,
                    pinned: isPinned,
                    pin_order: pinOrderEl ? parseInt(pinOrderEl.value) || 0 : 0,
                    scheduled_at: scheduledISO,
                    published_at: publishedISO,
                };

                var token = localStorage.getItem("adminToken");
                if (!token) {
                    window.location.href = "/admin/login";
                    return;
                }

                try {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML =
                        '<span class="animate-spin inline-block mr-2">◌</span> ' + (saveBtn.dataset.updatingText || 'Updating...');

                    var result = await window.adminRequest(
                        `${API_URL}/posts/` + postId,
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: "Bearer " + token,
                            },
                            body: JSON.stringify(postData),
                        }
                    );

                    if (result.ok) {
                        // Clear initialization flag for next visit
                        window._editPageInitialized = false;
                        window.location.href = "/admin/posts";
                    } else {
                        var errorMsg = result.msg || "Unknown error";
                        window.showAdminAlert((t.saveFailed || 'Update failed') + ": " + errorMsg, "error");
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = saveBtn.dataset.updateText || "Update Post";
                    }
                } catch (err) {
                    console.error(err);
                    window.showAdminAlert(t.saveFailed || "An error occurred while updating", "error");
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = saveBtn.dataset.updateText || "Update Post";
                }
            });
        }

        // Clear initialization flag when leaving page
        window.addEventListener("beforeunload", function() {
            window._editPageInitialized = false;
            stopAutosaveLoop();
            // 销毁 Vditor，防止报错
            if (window._editPageVditor) {
                try {
                    window._editPageVditor.destroy();
                } catch (e) {
                    console.log("Vditor destroy error:", e);
                }
                window._editPageVditor = null;
            }
        });

        // Start initialization
        initPasswordToggle();
        setTimeout(init, 100);
    })();
    </script>

    <!-- 媒体库选择器 -->
    <div id="mediaPickerModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-5xl border border-zinc-200 dark:border-zinc-800 shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-100">选择图片</h3>
                    <p class="text-xs text-zinc-500">从媒体库选择插入或作为封面</p>
                </div>
                <button id="mediaPickerClose" class="w-9 h-9 rounded-xl bg-zinc-100 dark:bg-zinc-800 text-zinc-500 hover:bg-zinc-200 dark:hover:bg-zinc-700 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 flex flex-col gap-3">
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                    <div class="relative w-full sm:w-72">
                        <input id="mediaPickerSearch" type="text" placeholder="搜索图片..." class="w-full px-4 h-10 pl-10 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 text-sm focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent outline-none transition-all" />
                        <svg class="w-5 h-5 text-zinc-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <div class="text-xs text-zinc-500" id="mediaPickerCount">0</div>
                </div>
                <div id="mediaPickerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 min-h-[240px]">
                    <div class="col-span-full text-center text-sm text-zinc-500 py-10">加载中...</div>
                </div>
                <div class="flex items-center justify-between text-sm text-zinc-500">
                    <button id="mediaPickerPrev" class="px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">上一页</button>
                    <span id="mediaPickerPage">1/1</span>
                    <button id="mediaPickerNext" class="px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">下一页</button>
                </div>
            </div>
        </div>
    </div>

    <style is:global>
        .admin-input {
            @apply w-full px-4 py-3 bg-white dark:bg-zinc-900/80 border border-zinc-200 dark:border-zinc-700/50 rounded-xl text-sm text-zinc-900 dark:text-zinc-100 outline-none transition-all duration-300 placeholder:text-zinc-400 dark:placeholder:text-zinc-500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(8px);
        }

        .admin-input:hover {
            @apply border-zinc-300 dark:border-zinc-600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .admin-input:focus {
            border-color: var(--primary);
            box-shadow:
                0 0 0 4px color-mix(in oklch, var(--primary) 18%, transparent),
                0 2px 8px color-mix(in oklch, var(--primary) 30%, transparent);
        }

        /* 暗色模式下的炫光效果 */
        .dark .admin-input:focus {
            box-shadow:
                0 0 0 4px color-mix(in oklch, var(--primary) 22%, transparent),
                0 0 20px color-mix(in oklch, var(--primary) 30%, transparent);
        }

        /* 输入框有内容时的样式 */
        .admin-input:not(:placeholder-shown) {
            @apply border-zinc-300 dark:border-zinc-600;
        }

        /* 密码输入框特殊样式 */
        input[type="password"].admin-input {
            letter-spacing: 0.1em;
        }

        /* 数字输入框样式 */
        input[type="number"].admin-input {
            -moz-appearance: textfield;
        }

        input[type="number"].admin-input::-webkit-outer-spin-button,
        input[type="number"].admin-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 文本域样式增强 */
        textarea.admin-input {
            @apply resize-none;
            min-height: 80px;
        }

        textarea.admin-input:focus {
            min-height: 100px;
        }

        /* 下拉选择框样式 */
        select.admin-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        select.admin-input option {
            @apply py-2 px-4 bg-white dark:bg-zinc-900;
        }

        /* 标签选择器容器样式 */
        .tags-selector {
            @apply flex flex-wrap gap-2 p-4 bg-white/80 dark:bg-zinc-900/80 border border-zinc-200 dark:border-zinc-700/50 rounded-xl min-h-[60px] transition-all duration-300;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(8px);
        }

        .tags-selector:hover {
            @apply border-zinc-300 dark:border-zinc-600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .tags-selector:focus-within {
            border-color: var(--primary);
            box-shadow:
                0 0 0 4px color-mix(in oklch, var(--primary) 18%, transparent),
                0 2px 8px color-mix(in oklch, var(--primary) 30%, transparent);
        }

        .dark .tags-selector:focus-within {
            box-shadow:
                0 0 0 4px color-mix(in oklch, var(--primary) 22%, transparent),
                0 0 20px color-mix(in oklch, var(--primary) 30%, transparent);
        }

        /* 标签按钮样式 */
        .tag-btn {
            @apply px-3 py-1.5 text-xs font-medium rounded-full border-2 transition-all duration-200 cursor-pointer select-none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .tag-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tag-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            @apply bg-transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            @apply bg-zinc-200 dark:bg-zinc-800 rounded-full;
        }

        .vditor {
            border: none !important;
        }
        .vditor-toolbar {
            @apply transition-colors !important;
            background-color: transparent !important;
            border-bottom: 1px solid theme("colors.zinc.100") !important;
        }
        .dark .vditor-toolbar {
            border-bottom: 1px solid theme("colors.zinc.800") !important;
        }
        .vditor-content {
            background-color: transparent !important;
        }
        .dark .vditor-reset {
            color: theme("colors.zinc.100") !important;
        }
    </style>
</AdminLayout>
