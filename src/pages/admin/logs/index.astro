---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();
---

<AdminLayout
    title={`${i18n(I18nKey.adminLogManagement)} - ${siteConfig.title}`}
    activeMenu="logs"
>
    <div class="p-6 lg:p-8 animate-fade-in-up">
        <div
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6"
        >
            <div>
                <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">
                    {i18n(I18nKey.adminLogManagement)}
                </h1>
                <p class="text-sm text-zinc-500 mt-1">
                    {i18n(I18nKey.adminManageAccessLogs)}
                </p>
            </div>
            <div class="flex gap-3">
                <select
                    id="logTypeFilter"
                    class="px-4 py-2 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100 focus:ring-2 focus:ring-[var(--primary)] outline-none transition-all hover:border-[var(--primary)]"
                >
                    <option value="">{i18n(I18nKey.adminLogTypeAll)}</option>
                    <option value="login_success"
                        >{i18n(I18nKey.adminLogTypeLoginSuccess)}</option
                    >
                    <option value="login_failed"
                        >{i18n(I18nKey.adminLogTypeLoginFailed)}</option
                    >
                    <option value="api_access"
                        >{i18n(I18nKey.adminLogTypeApiAccess)}</option
                    >
                </select>
                <button
                    id="cleanupBtn"
                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2 shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0"
                    title="清理30天前的日志"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                            clip-rule="evenodd"></path>
                    </svg>
                    {i18n(I18nKey.adminLogCleanup)}
                </button>
                <button
                    id="clearAllBtn"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2 shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0"
                    title="清空所有日志"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    清空全部
                </button>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div
            class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"
            id="statsContainer"
        >
            <div
                class="bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200 dark:border-zinc-800 p-4 shadow-sm hover:shadow-md transition-all hover:-translate-y-1"
            >
                <div class="text-sm text-zinc-500">
                    {i18n(I18nKey.adminLogTotalLogs)}
                </div>
                <div
                    class="text-2xl font-bold text-zinc-900 dark:text-zinc-100"
                    id="statTotal"
                >
                    -
                </div>
            </div>
            <div
                class="bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200 dark:border-zinc-800 p-4 shadow-sm hover:shadow-md transition-all hover:-translate-y-1"
            >
                <div class="text-sm text-zinc-500">
                    {i18n(I18nKey.adminLogTodayLogs)}
                </div>
                <div
                    class="text-2xl font-bold text-zinc-900 dark:text-zinc-100"
                    id="statToday"
                >
                    -
                </div>
            </div>
            <div
                class="bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200 dark:border-zinc-800 p-4 shadow-sm hover:shadow-md transition-all hover:-translate-y-1"
            >
                <div class="text-sm text-zinc-500">
                    {i18n(I18nKey.adminLogTypeLoginSuccess)}
                </div>
                <div
                    class="text-2xl font-bold text-green-600"
                    id="statLoginSuccess"
                >
                    -
                </div>
            </div>
            <div
                class="bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200 dark:border-zinc-800 p-4 shadow-sm hover:shadow-md transition-all hover:-translate-y-1"
            >
                <div class="text-sm text-zinc-500">
                    {i18n(I18nKey.adminLogTypeLoginFailed)}
                </div>
                <div
                    class="text-2xl font-bold text-red-600"
                    id="statLoginFailed"
                >
                    -
                </div>
            </div>
        </div>

        <!-- 日志表格 -->
        <div
            class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden"
        >
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead
                        class="bg-zinc-50/80 dark:bg-zinc-800/50 border-b border-zinc-200 dark:border-zinc-700/50"
                    >
                        <tr>
                            <th
                                class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider text-center"
                                >{i18n(I18nKey.adminLogTime)}</th
                            >
                            <th
                                class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider text-center"
                                >{i18n(I18nKey.adminLogType)}</th
                            >
                            <th
                                class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider text-center"
                                >{i18n(I18nKey.adminUsername)}</th
                            >
                            <th
                                class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider text-center"
                                >{i18n(I18nKey.adminLogIpAddress)}</th
                            >
                            <th
                                class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider text-center"
                                >{i18n(I18nKey.adminLogRequestPath)}</th
                            >
                            <th
                                class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider text-center"
                                >{i18n(I18nKey.adminLogStatusCode)}</th
                            >
                            <th
                                class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider text-center"
                                >{i18n(I18nKey.adminLogUserAgent)}</th
                            >
                        </tr>
                    </thead>
                    <tbody
                        id="logsTableBody"
                        class="divide-y divide-zinc-100 dark:divide-zinc-800/50"
                    >
                        <tr>
                            <td
                                colspan="7"
                                class="px-6 py-12 text-center text-zinc-500"
                                >{i18n(I18nKey.adminLoading)}</td
                            >
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            <div id="paginationContainer"></div>
        </div>
    </div>
</AdminLayout>

<script is:inline>
    document.addEventListener('astro:page-load', () => {
    (function () {
        var currentPage = 1;
        var pageSize = 20;
        var totalPages = 1;
        var totalLogs = 0;
        var t = window.adminI18n || {};
        var API_URL = window.API_URL;

        // 日志类型映射
        var logTypeLabels = {
            login_success:
                '<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400">登录成功</span>',
            login_failed:
                '<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400">登录失败</span>',
            api_access:
                '<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">API访问</span>',
        };

        // 格式化时间
        function formatTime(dateStr) {
            var date = new Date(dateStr);
            return date.toLocaleString("zh-CN", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
            });
        }

        // 截断文本
        function truncate(str, len) {
            if (!str) return "-";
            return str.length > len ? str.substring(0, len) + "..." : str;
        }

        // 加载统计数据
        async function loadStats() {
            try {
                var response = await fetch(`${API_URL}/logs/stats`, {
                    headers: {
                        Authorization:
                            "Bearer " + localStorage.getItem("adminToken"),
                    },
                });
                // 401 由全局拦截器处理，这里直接返回
                if (!response.ok) return;

                var stats = await response.json();
                var statTotal = document.getElementById("statTotal");
                var statToday = document.getElementById("statToday");
                var statLoginSuccess = document.getElementById("statLoginSuccess");
                var statLoginFailed = document.getElementById("statLoginFailed");

                // 检查元素是否存在（页面可能已跳转）
                if (statTotal) statTotal.textContent = stats.total_logs;
                if (statToday) statToday.textContent = stats.today_logs;
                if (statLoginSuccess) statLoginSuccess.textContent = stats.login_success_count;
                if (statLoginFailed) statLoginFailed.textContent = stats.login_failed_count;
                totalLogs = stats.total_logs;
            } catch (err) {
                // 忽略网络错误（可能是页面跳转导致）
            }
        }

        // 加载日志列表
        async function loadLogs() {
            var tbody = document.getElementById("logsTableBody");
            if (!tbody) return;

            var logType = document.getElementById("logTypeFilter").value;
            var url =
                API_URL +
                "/logs?page=" +
                currentPage +
                "&page_size=" +
                pageSize;
            if (logType) {
                url += "&log_type=" + logType;
            }

            try {
                var response = await fetch(url, {
                    headers: {
                        Authorization:
                            "Bearer " + localStorage.getItem("adminToken"),
                    },
                });

                if (!response.ok) {
                    if (response.status !== 401) {
                        // 401 由全局拦截器处理
                        throw new Error("Failed to load");
                    }
                    return;
                }

                var logs = await response.json();

                if (logs.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="7" class="px-6 py-12 text-center text-zinc-500">' +
                        (t.noLogs || "暂无日志记录") +
                        "</td></tr>";
                    renderPagination(0);
                    return;
                }

                // 从第一条数据提取分页信息
                if (logs.length > 0 && logs[0]._pagination) {
                    var pagination = logs[0]._pagination;
                    totalPages = pagination.total_pages;
                    totalLogs = pagination.total;
                } else {
                    totalPages = Math.ceil(totalLogs / pageSize) || 1;
                }

                tbody.innerHTML = logs
                    .map(function (log) {
                        var typeLabel =
                            logTypeLabels[log.log_type] || log.log_type;
                        var statusClass = "";
                        if (log.status_code >= 200 && log.status_code < 300) {
                            statusClass = "text-green-600";
                        } else if (log.status_code >= 400) {
                            statusClass = "text-red-600";
                        }

                        return (
                            '<tr class="hover:bg-zinc-50 dark:hover:bg-zinc-800/50">' +
                            '<td class="px-4 py-3 text-sm text-zinc-600 dark:text-zinc-400 whitespace-nowrap text-center">' +
                            formatTime(log.created_at) +
                            "</td>" +
                            '<td class="px-4 py-3 text-center">' +
                            typeLabel +
                            "</td>" +
                            '<td class="px-4 py-3 text-sm text-zinc-900 dark:text-zinc-100 text-center">' +
                            (log.username || "-") +
                            "</td>" +
                            '<td class="px-4 py-3 text-sm text-zinc-600 dark:text-zinc-400 font-mono text-center">' +
                            (log.ip_address || "-") +
                            "</td>" +
                            '<td class="px-4 py-3 text-sm text-zinc-600 dark:text-zinc-400 font-mono text-center" title="' +
                            (log.request_path || "") +
                            '">' +
                            truncate(log.request_path, 30) +
                            "</td>" +
                            '<td class="px-4 py-3 text-sm font-medium text-center ' +
                            statusClass +
                            '">' +
                            (log.status_code || "-") +
                            "</td>" +
                            '<td class="px-4 py-3 text-sm text-zinc-500 max-w-[200px] truncate text-center" title="' +
                            (log.user_agent || "") +
                            '">' +
                            truncate(log.user_agent, 40) +
                            "</td>" +
                            "</tr>"
                        );
                    })
                    .join("");

                renderPagination(logs.length);
            } catch (err) {
                console.error(err);
                tbody.innerHTML =
                    '<tr><td colspan="7" class="px-6 py-12 text-center text-red-500">' +
                    (t.loadFailed || "加载失败") +
                    "</td></tr>";
            }
        }

        // 渲染分页控件
        function renderPagination(count) {
            var container = document.getElementById("paginationContainer");
            if (!container) return;

            var pageInfo = (t.paginationInfo || "第 {page} 页 / 共 {total} 页")
                .replace("{page}", currentPage)
                .replace("{total}", totalPages);

            container.innerHTML =
                '<div class="flex items-center justify-between px-6 py-4 bg-zinc-50 dark:bg-zinc-800/50 border-t border-zinc-200 dark:border-zinc-800">' +
                '<div class="text-sm text-zinc-500">' +
                pageInfo +
                " (" +
                totalLogs +
                " 条记录)</div>" +
                '<div class="flex items-center gap-2">' +
                '<button onclick="goToLogPage(' +
                (currentPage - 1) +
                ')" ' +
                (currentPage <= 1 ? "disabled" : "") +
                ' class="px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ' +
                (currentPage <= 1
                    ? "text-zinc-300 dark:text-zinc-600 cursor-not-allowed"
                    : "text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-700") +
                '">' +
                (t.paginationPrev || "上一页") +
                "</button>" +
                '<div class="flex items-center gap-1">' +
                generatePageButtons() +
                "</div>" +
                '<button onclick="goToLogPage(' +
                (currentPage + 1) +
                ')" ' +
                (currentPage >= totalPages ? "disabled" : "") +
                ' class="px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ' +
                (currentPage >= totalPages
                    ? "text-zinc-300 dark:text-zinc-600 cursor-not-allowed"
                    : "text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-700") +
                '">' +
                (t.paginationNext || "下一页") +
                "</button>" +
                "</div>" +
                "</div>";
        }

        // 生成页码按钮
        function generatePageButtons() {
            if (totalPages <= 1) return "";

            var buttons = [];
            var maxVisible = 5;
            var start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            var end = Math.min(totalPages, start + maxVisible - 1);

            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }

            // 首页
            if (start > 1) {
                buttons.push(
                    '<button onclick="goToLogPage(1)" class="w-8 h-8 text-sm font-medium rounded-lg text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-700">1</button>',
                );
                if (start > 2) {
                    buttons.push('<span class="px-1 text-zinc-400">...</span>');
                }
            }

            // 中间页码
            for (var i = start; i <= end; i++) {
                if (i === currentPage) {
                    buttons.push(
                        '<button class="w-8 h-8 text-sm font-medium rounded-lg bg-[var(--primary)] text-white">' +
                            i +
                            "</button>",
                    );
                } else {
                    buttons.push(
                        '<button onclick="goToLogPage(' +
                            i +
                            ')" class="w-8 h-8 text-sm font-medium rounded-lg text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-700">' +
                            i +
                            "</button>",
                    );
                }
            }

            // 尾页
            if (end < totalPages) {
                if (end < totalPages - 1) {
                    buttons.push('<span class="px-1 text-zinc-400">...</span>');
                }
                buttons.push(
                    '<button onclick="goToLogPage(' +
                        totalPages +
                        ')" class="w-8 h-8 text-sm font-medium rounded-lg text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-700">' +
                        totalPages +
                        "</button>",
                );
            }

            return buttons.join("");
        }

        // 跳转到指定页
        window.goToLogPage = function (page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            loadLogs();
        };

        // 清理日志
        async function cleanupLogs() {
            var confirmed = await window.adminConfirm(
                "确定要清理30天前的日志吗？",
                "清理旧日志",
            );
            if (!confirmed) return;

            try {
                var response = await fetch(API_URL + "/logs/cleanup?days=30", {
                    method: "DELETE",
                    headers: {
                        Authorization:
                            "Bearer " + localStorage.getItem("adminToken"),
                    },
                });

                if (response.ok) {
                    var result = await response.json();
                    await window.adminAlert(
                        result.message || "清理成功",
                        "success",
                        "操作成功",
                    );
                    loadLogs();
                    loadStats();
                } else {
                    await window.adminAlert(
                        t.deleteFailed || "清理失败",
                        "error",
                        "操作失败",
                    );
                }
            } catch (err) {
                await window.adminAlert(
                    t.deleteFailed || "清理失败",
                    "error",
                    "操作失败",
                );
            }
        }

        // 清空所有日志
        async function clearAllLogs() {
            var confirmed = await window.adminConfirm(
                "确定要清空所有日志吗？此操作不可恢复！",
                "清空全部日志",
            );
            if (!confirmed) return;

            try {
                var response = await fetch(API_URL + "/logs/clear-all", {
                    method: "DELETE",
                    headers: {
                        Authorization:
                            "Bearer " + localStorage.getItem("adminToken"),
                    },
                });

                if (response.ok) {
                    var result = await response.json();
                    await window.adminAlert(
                        result.message || "清空成功",
                        "success",
                        "操作成功",
                    );
                    currentPage = 1;
                    loadLogs();
                    loadStats();
                } else {
                    await window.adminAlert(
                        t.deleteFailed || "清空失败",
                        "error",
                        "操作失败",
                    );
                }
            } catch (err) {
                await window.adminAlert(
                    t.deleteFailed || "清空失败",
                    "error",
                    "操作失败",
                );
            }
        }

        // 事件绑定
        var logTypeFilter = document.getElementById("logTypeFilter");
        var cleanupBtn = document.getElementById("cleanupBtn");
        var clearAllBtn = document.getElementById("clearAllBtn");

        if (logTypeFilter) {
            logTypeFilter.addEventListener("change", function () {
                currentPage = 1;
                loadLogs();
            });
        }

        if (cleanupBtn) {
            cleanupBtn.addEventListener("click", cleanupLogs);
        }

        if (clearAllBtn) {
            clearAllBtn.addEventListener("click", clearAllLogs);
        }

        // 初始化
        loadStats();
        loadLogs();
    })();
    });
</script>
