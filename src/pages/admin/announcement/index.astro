---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();
---

<AdminLayout title={`公告管理 - ${siteConfig.title}`} activeMenu="announcement">
    <div class="p-6 lg:p-8">
        <!-- 页面标题 -->
        <div
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6"
        >
            <div>
                <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">
                    公告管理
                </h1>
                <p class="text-sm text-zinc-500 mt-1">
                    配置站点公告内容和显示样式
                </p>
            </div>
        </div>

        <!-- 公告配置表单 -->
        <div
            class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden"
        >
            <div
                class="p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50 flex items-center gap-3"
            >
                <div
                    class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/40 flex items-center justify-center"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 text-indigo-600 dark:text-indigo-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"
                        ></path>
                    </svg>
                </div>
                <div>
                    <h2 class="font-bold text-zinc-900 dark:text-zinc-100">
                        公告设置
                    </h2>
                    <p class="text-xs text-zinc-500">
                        配置公告内容、链接和显示选项
                    </p>
                </div>
            </div>
            <div class="p-6">
                <form id="announcementForm" class="space-y-6">
                    <div>
                        <label
                            class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                            >公告标题</label
                        >
                        <input
                            type="text"
                            id="announcementTitle"
                            class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none"
                            placeholder="例如: 公告"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                            >公告内容 <span class="text-red-500">*</span></label
                        >
                        <textarea
                            id="announcementContent"
                            required
                            rows="4"
                            class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none resize-none"
                            placeholder="输入公告内容..."></textarea>
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                            >公告图片</label
                        >
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                            <input
                                type="text"
                                id="announcementImage"
                                class="flex-1 min-w-0 px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none"
                                placeholder="https://"
                            />
                            <button
                                type="button"
                                id="openAnnouncementImagePicker"
                                class="h-[46px] px-3 rounded-xl bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 hover:shadow-sm text-zinc-700 dark:text-zinc-300 text-sm font-medium transition-all flex-shrink-0 whitespace-nowrap inline-flex items-center justify-center"
                            >
                                从媒体库
                            </button>
                        </div>
                        <div id="announcementImagePreview" class="hidden mt-3 w-full rounded-xl overflow-hidden border border-zinc-200 dark:border-zinc-700 bg-zinc-100 dark:bg-zinc-800">
                            <img id="announcementImagePreviewImg" src="" alt="公告图片预览" class="w-full max-h-56 object-cover" />
                        </div>
                    </div>

                    <div
                        class="flex items-center gap-3 p-4 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl"
                    >
                        <input
                            type="checkbox"
                            id="announcementClosable"
                            class="w-4 h-4 text-[var(--primary)] rounded focus:ring-2 focus:ring-[var(--primary)]"
                        />
                        <label
                            for="announcementClosable"
                            class="text-sm font-medium text-zinc-700 dark:text-zinc-300"
                        >
                            允许用户关闭公告
                        </label>
                    </div>

                    <div
                        class="border-t border-zinc-200 dark:border-zinc-800 pt-6"
                    >
                        <h3
                            class="text-lg font-semibold text-zinc-900 dark:text-zinc-100 mb-4"
                        >
                            链接设置
                        </h3>

                        <div class="space-y-4">
                            <div
                                class="flex items-center gap-3 p-4 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl"
                            >
                                <input
                                    type="checkbox"
                                    id="linkEnable"
                                    class="w-4 h-4 text-[var(--primary)] rounded focus:ring-2 focus:ring-[var(--primary)]"
                                />
                                <label
                                    for="linkEnable"
                                    class="text-sm font-medium text-zinc-700 dark:text-zinc-300"
                                >
                                    启用公告链接按钮
                                </label>
                            </div>

                            <div id="linkSettings" class="space-y-4 pl-4">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                                        >链接文本</label
                                    >
                                    <input
                                        type="text"
                                        id="linkText"
                                        class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none"
                                        placeholder="例如: 了解更多"
                                    />
                                </div>

                                <div>
                                    <label
                                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                                        >链接地址</label
                                    >
                                    <input
                                        type="text"
                                        id="linkUrl"
                                        class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none"
                                        placeholder="例如: /about"
                                    />
                                </div>

                                <div
                                    class="flex items-center gap-3 p-4 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl"
                                >
                                    <input
                                        type="checkbox"
                                        id="linkExternal"
                                        class="w-4 h-4 text-[var(--primary)] rounded focus:ring-2 focus:ring-[var(--primary)]"
                                    />
                                    <label
                                        for="linkExternal"
                                        class="text-sm font-medium text-zinc-700 dark:text-zinc-300"
                                    >
                                        在新窗口打开链接
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex justify-end gap-3 pt-4 border-t border-zinc-200 dark:border-zinc-800"
                    >
                        <button
                            type="submit"
                            class="px-6 py-2.5 bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 rounded-xl hover:opacity-90 dark:hover:bg-zinc-700 transition-all font-medium shadow-lg hover:shadow-xl active:scale-95 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]"
                        >
                            保存配置
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 预览区域 -->
        <div
            class="mt-6 bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden"
        >
            <div
                class="p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50"
            >
                <h2 class="font-bold text-zinc-900 dark:text-zinc-100">
                    实时预览
                </h2>
                <p class="text-xs text-zinc-500 mt-1">
                    查看公告在前端的显示效果
                </p>
            </div>
            <div class="p-6">
                <div
                    id="announcementPreview"
                    class="border border-zinc-200 dark:border-zinc-700 rounded-xl p-4 bg-zinc-50 dark:bg-zinc-800/30"
                >
                    <div class="text-zinc-500 text-center py-4">
                        配置公告后将在此显示预览
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 媒体库选择器 -->
    <div id="mediaPickerModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-5xl border border-zinc-200 dark:border-zinc-800 shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-100">选择图片</h3>
                    <p class="text-xs text-zinc-500">从媒体库选择公告图片</p>
                </div>
                <button id="mediaPickerClose" class="w-9 h-9 rounded-xl bg-zinc-100 dark:bg-zinc-800 text-zinc-500 hover:bg-zinc-200 dark:hover:bg-zinc-700 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 flex flex-col gap-3">
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                    <div class="relative w-full sm:w-72">
                        <input id="mediaPickerSearch" type="text" placeholder="搜索图片..." class="w-full px-4 h-10 pl-10 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 text-sm focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent outline-none transition-all" />
                        <svg class="w-5 h-5 text-zinc-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <div class="text-xs text-zinc-500" id="mediaPickerCount">0</div>
                </div>
                <div id="mediaPickerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 min-h-[240px]">
                    <div class="col-span-full text-center text-sm text-zinc-500 py-10">加载中...</div>
                </div>
                <div class="flex items-center justify-between text-sm text-zinc-500">
                    <button id="mediaPickerPrev" class="px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">上一页</button>
                    <span id="mediaPickerPage">1/1</span>
                    <button id="mediaPickerNext" class="px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">下一页</button>
                </div>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline>
    (function () {
        var API_URL = window.API_URL;
        var pickerReady = false;
        setupMediaPicker();
        // 加载当前公告配置
        async function loadAnnouncementConfig() {
            try {
                var result = await window.adminRequest(`${API_URL}/settings/announcement`);
                if (!result.ok) throw new Error(result.msg || "加载失败");

                var config = result.data || {};

                // 填充表单
                document.getElementById("announcementTitle").value =
                    config.title || "公告";
                document.getElementById("announcementContent").value =
                    config.content || "";
                document.getElementById("announcementClosable").checked =
                    config.closable !== false;
                document.getElementById("announcementImage").value =
                    config.image || "";
                document.getElementById("linkEnable").checked =
                    config.link && config.link.enable;
                document.getElementById("linkText").value =
                    (config.link && config.link.text) || "了解更多";
                document.getElementById("linkUrl").value =
                    (config.link && config.link.url) || "/about";
                document.getElementById("linkExternal").checked =
                    config.link && config.link.external;

                updateImagePreview();
                updatePreview();
                toggleLinkSettings();
            } catch (err) {
                console.error("加载公告配置失败:", err);
            }
        }

        // 切换链接设置显示
        function toggleLinkSettings() {
            var linkEnable = document.getElementById("linkEnable");
            var linkSettings = document.getElementById("linkSettings");
            if (linkSettings) {
                linkSettings.style.opacity = linkEnable.checked ? "1" : "0.5";
                linkSettings.style.pointerEvents = linkEnable.checked
                    ? "auto"
                    : "none";
            }
        }

        // 更新预览
        function updatePreview() {
            var title =
                document.getElementById("announcementTitle").value || "公告";
            var content =
                document.getElementById("announcementContent").value || "";
            var image =
                document.getElementById("announcementImage").value || "";
            var closable = document.getElementById(
                "announcementClosable",
            ).checked;
            var linkEnable = document.getElementById("linkEnable").checked;
            var linkText =
                document.getElementById("linkText").value || "了解更多";

            var preview = document.getElementById("announcementPreview");
            if (!preview || (!content && !image)) {
                if (preview)
                    preview.innerHTML =
                        '<div class="text-zinc-500 text-center py-4">配置公告后将在此显示预览</div>';
                return;
            }

            var html =
                '<div class="space-y-3">' +
                '<div class="text-sm font-medium text-zinc-600 dark:text-zinc-400">' +
                title +
                "</div>" +
                (image
                    ? '<div class="rounded-lg overflow-hidden border border-zinc-200 dark:border-zinc-700 bg-zinc-100 dark:bg-zinc-800">' +
                      '<img src="' + image + '" alt="公告图片" class="w-full h-auto" />' +
                      "</div>"
                    : "") +
                '<div class="text-zinc-700 dark:text-zinc-300 leading-relaxed">' +
                content +
                "</div>" +
                '<div class="flex items-center justify-between gap-3 pt-2">' +
                "<div>" +
                (linkEnable
                    ? '<button class="bg-[var(--primary)] text-white text-sm px-4 py-2 rounded-lg">' +
                      linkText +
                      "</button>"
                    : "") +
                "</div>" +
                (closable
                    ? '<button class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>'
                    : "") +
                "</div>" +
                "</div>";

            preview.innerHTML = html;
        }

        // 表单提交
        var form = document.getElementById("announcementForm");
        if (form) {
            form.addEventListener("submit", async function (e) {
                e.preventDefault();

                var data = {
                    title:
                        document.getElementById("announcementTitle").value ||
                        "公告",
                    content: document.getElementById("announcementContent")
                        .value,
                    closable: document.getElementById("announcementClosable")
                        .checked,
                    image: document.getElementById("announcementImage").value || "",
                    link_enable: document.getElementById("linkEnable").checked,
                    link_text:
                        document.getElementById("linkText").value || "了解更多",
                    link_url:
                        document.getElementById("linkUrl").value || "/about",
                    link_external:
                        document.getElementById("linkExternal").checked,
                };

                try {
                    var result = await window.adminRequest(
                        API_URL + "/settings/announcement",
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization:
                                    "Bearer " +
                                    localStorage.getItem("adminToken"),
                            },
                            body: JSON.stringify(data),
                        },
                    );

                    if (result.ok) {
                        await window.showAdminAlert(
                            result.msg || "公告配置已保存成功！",
                            "success",
                            "保存成功",
                        );
                    } else {
                        await window.showAdminAlert(
                            result.msg || "保存失败，请重试",
                            "error",
                            "保存失败",
                        );
                    }
                } catch (err) {
                    console.error(err);
                    await window.showAdminAlert(
                        "网络错误，请稍后重试",
                        "error",
                        "保存失败",
                    );
                }
            });
        }

        // 监听表单变化更新预览
        [
            "announcementTitle",
            "announcementContent",
            "announcementImage",
            "announcementClosable",
            "linkEnable",
            "linkText",
        ].forEach(function (id) {
            var el = document.getElementById(id);
            if (el) {
                el.addEventListener("input", updatePreview);
                el.addEventListener("change", updatePreview);
            }
        });

        // 监听链接启用状态
        var linkEnableEl = document.getElementById("linkEnable");
        if (linkEnableEl) {
            linkEnableEl.addEventListener("change", function () {
                toggleLinkSettings();
                updatePreview();
            });
        }

        function updateImagePreview() {
            var previewWrap = document.getElementById("announcementImagePreview");
            var previewImg = document.getElementById("announcementImagePreviewImg");
            var imageInput = document.getElementById("announcementImage");
            if (!previewWrap || !previewImg || !imageInput) return;

            var value = imageInput.value || "";
            if (!value) {
                previewWrap.classList.add("hidden");
                previewImg.src = "";
                return;
            }
            previewWrap.classList.remove("hidden");
            previewImg.onerror = function () {
                previewWrap.classList.add("hidden");
            };
            previewImg.src = value;
        }

        function setupMediaPicker() {
            var modal = document.getElementById("mediaPickerModal");
            if (!modal || pickerReady) return;
            pickerReady = true;

            var openBtn = document.getElementById("openAnnouncementImagePicker");
            var closeBtn = document.getElementById("mediaPickerClose");
            var searchInput = document.getElementById("mediaPickerSearch");
            var grid = document.getElementById("mediaPickerGrid");
            var countEl = document.getElementById("mediaPickerCount");
            var prevBtn = document.getElementById("mediaPickerPrev");
            var nextBtn = document.getElementById("mediaPickerNext");
            var pageEl = document.getElementById("mediaPickerPage");

            var currentPage = 1;
            var totalPages = 1;
            var keyword = "";
            var searchTimer = null;

            function isImageItem(item) {
                if (item.mime_type && item.mime_type.indexOf("image/") === 0) {
                    return true;
                }
                var name = item.filename || "";
                var ext = name.toLowerCase().split(".").pop();
                return ["jpg", "jpeg", "png", "gif", "webp", "svg"].includes(ext);
            }

            function openPicker() {
                currentPage = 1;
                keyword = "";
                if (searchInput) searchInput.value = "";
                modal.classList.remove("hidden");
                modal.classList.add("flex");
                loadMedia();
            }

            function closePicker() {
                modal.classList.add("hidden");
                modal.classList.remove("flex");
            }

            async function loadMedia() {
                if (!grid) return;
                grid.innerHTML = '<div class="col-span-full text-center text-sm text-zinc-500 py-10">加载中...</div>';

                try {
                    var query = "page=" + currentPage + "&page_size=40";
                    if (keyword) {
                        query += "&keyword=" + encodeURIComponent(keyword);
                    }
                    var result = await window.adminRequest(API_URL + "/upload/media?" + query, {
                        headers: {
                            "Authorization": "Bearer " + localStorage.getItem("adminToken")
                        }
                    });

                    if (!result.ok) {
                        throw new Error(result.msg || "加载失败");
                    }

                    var data = result.data || {};
                    var items = (data.items || []).filter(isImageItem);
                    var total = data.pagination ? data.pagination.total : items.length;
                    totalPages = data.pagination ? data.pagination.total_pages : 1;

                    if (countEl) {
                        countEl.textContent = "共 " + total + " 张图片";
                    }
                    if (pageEl) {
                        pageEl.textContent = currentPage + "/" + (totalPages || 1);
                    }
                    if (prevBtn) prevBtn.disabled = currentPage <= 1;
                    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;

                    if (items.length === 0) {
                        grid.innerHTML = '<div class="col-span-full text-center text-sm text-zinc-500 py-10">暂无图片</div>';
                        return;
                    }

                    grid.innerHTML = items.map(function(item) {
                        var name = item.original_name || item.filename || "image";
                        return '' +
                            '<button type="button" class="group text-left rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden bg-white dark:bg-zinc-900 hover:border-[var(--primary)]/50 transition-all" data-url="' + item.url + '" data-name="' + name + '">' +
                                '<div class="aspect-square bg-zinc-100 dark:bg-zinc-800 overflow-hidden">' +
                                    '<img src="' + item.url + '" alt="' + name + '" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition-transform" />' +
                                '</div>' +
                                '<div class="px-2 py-1.5 text-xs text-zinc-600 dark:text-zinc-300 truncate">' + name + '</div>' +
                            '</button>';
                    }).join("");

                    grid.querySelectorAll("button[data-url]").forEach(function(btn) {
                        btn.addEventListener("click", function() {
                            var url = this.dataset.url;
                            var imageInput = document.getElementById("announcementImage");
                            if (imageInput) {
                                imageInput.value = url;
                                imageInput.dispatchEvent(new Event("input"));
                            }
                            updateImagePreview();
                            updatePreview();
                            closePicker();
                        });
                    });
                } catch (err) {
                    console.error("加载媒体失败:", err);
                    grid.innerHTML = '<div class="col-span-full text-center text-sm text-red-500 py-10">加载失败</div>';
                }
            }

            openBtn?.addEventListener("click", openPicker);
            closeBtn?.addEventListener("click", closePicker);
            modal?.addEventListener("click", function(e) {
                if (e.target === modal) {
                    closePicker();
                }
            });

            searchInput?.addEventListener("input", function() {
                keyword = this.value.trim();
                clearTimeout(searchTimer);
                searchTimer = setTimeout(function() {
                    currentPage = 1;
                    loadMedia();
                }, 300);
            });

            prevBtn?.addEventListener("click", function() {
                if (currentPage > 1) {
                    currentPage -= 1;
                    loadMedia();
                }
            });

            nextBtn?.addEventListener("click", function() {
                if (currentPage < totalPages) {
                    currentPage += 1;
                    loadMedia();
                }
            });

            var imageInput = document.getElementById("announcementImage");
            if (imageInput) {
                imageInput.addEventListener("input", function() {
                    updateImagePreview();
                    updatePreview();
                });
            }
        }

        function initAnnouncementPage() {
            // 检查是否在公告管理页面
            if (!document.getElementById('announcementContent')) return;
            loadAnnouncementConfig();
        }

        // 监听 SPA 导航
        document.addEventListener('astro:page-load', initAnnouncementPage);

        // 首次加载
        initAnnouncementPage();
    })();
</script>
