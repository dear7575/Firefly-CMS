---
export const prerender = false;
import AdminLayout from "../../layouts/AdminLayout.astro";
import {siteConfig} from "../../config";
import I18nKey from "@/i18n/i18nKey";
import {i18n} from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();

// i18n translations for inline script
const loginI18n = {
    loginFailed: i18n(I18nKey.adminLoginFailed),
    connectionFailed: i18n(I18nKey.adminPostLoadFailed),
};
---

<AdminLayout title={`${i18n(I18nKey.adminLogin)} - ${siteConfig.title}`} hideNav={true}>
    <div class="flex items-center justify-center min-h-screen px-6">
        <div
                class="w-full max-w-md p-10 bg-white/90 dark:bg-zinc-900/90 rounded-3xl shadow-2xl border border-white/20 dark:border-zinc-700/50 backdrop-blur-xl onload-animation"
        >
            <div class="text-center mb-10">
                <div
                        class="w-16 h-16 bg-[var(--primary)] text-white flex items-center justify-center rounded-2xl mx-auto mb-4 text-2xl font-bold shadow-lg"
                >
                    F
                </div>
                <h1
                        class="text-3xl font-bold text-zinc-900 dark:text-zinc-100 mb-2"
                >
                    {i18n(I18nKey.adminLoginTitle)}
                </h1>
                <p class="text-zinc-500 dark:text-zinc-400">
                    {i18n(I18nKey.adminLoginSubtitle)}
                </p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label
                            class="block text-sm font-bold text-zinc-700 dark:text-zinc-300 mb-2 uppercase tracking-wider"
                    >{i18n(I18nKey.adminUsername)}</label
                    >
                    <input
                            type="text"
                            id="username"
                            required
                            placeholder="用户名"
                            class="login-input"
                    />
                </div>
                <div>
                    <label
                            class="block text-sm font-bold text-zinc-700 dark:text-zinc-300 mb-2 uppercase tracking-wider"
                    >{i18n(I18nKey.adminPassword)}</label
                    >
                    <input
                            type="password"
                            id="password"
                            required
                            placeholder="密码"
                            class="login-input"
                    />
                </div>
                <button
                        type="submit"
                        id="loginBtn"
                        class="w-full py-4 bg-[var(--primary)] dark:bg-indigo-600 hover:opacity-90 dark:hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all active:scale-[0.98] dark:shadow-[0_0_20px_rgba(99,102,241,0.3)]"
                        data-login-text={i18n(I18nKey.adminLoginButton)}
                        data-logging-in-text={i18n(I18nKey.adminLoggingIn)}
                >
                    {i18n(I18nKey.adminLoginButton)}
                </button>
                <p
                        id="errorMsg"
                        class="text-red-500 text-sm font-medium hidden text-center animate-bounce"
                >
                </p>
            </form>
        </div>
    </div>
</AdminLayout>

<script is:inline define:vars={{loginI18n}}>
    const form = document.getElementById("loginForm");
    const errorMsg = document.getElementById("errorMsg");
    const loginBtn = document.getElementById("loginBtn");

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        // Show loading state
        if (loginBtn) {
            loginBtn.textContent = loginBtn.dataset.loggingInText;
            loginBtn.disabled = true;
        }

        const formData = new FormData();
        formData.append("username", username);
        formData.append("password", password);

        try {
            const response = await fetch(`${API_URL}/token`, {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem("adminToken", data.access_token);
                window.location.href = "/admin/";
            } else {
                if (errorMsg) {
                    errorMsg.textContent = loginI18n.loginFailed;
                    errorMsg.classList.remove("hidden");
                }
                // Reset button
                if (loginBtn) {
                    loginBtn.textContent = loginBtn.dataset.loginText;
                    loginBtn.disabled = false;
                }
            }
        } catch (err) {
            console.error(err);
            if (errorMsg) {
                errorMsg.textContent = loginI18n.connectionFailed;
                errorMsg.classList.remove("hidden");
            }
            // Reset button
            if (loginBtn) {
                loginBtn.textContent = loginBtn.dataset.loginText;
                loginBtn.disabled = false;
            }
        }
    });
</script>

<style>
    .login-input {
        @apply w-full px-5 py-4 border rounded-xl bg-white/80 dark:bg-zinc-800/80 border-zinc-200 dark:border-zinc-700/50 text-zinc-900 dark:text-zinc-100 transition-all duration-300 outline-none placeholder:text-zinc-400 dark:placeholder:text-zinc-500;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
    }

    .login-input:hover {
        @apply border-zinc-300 dark:border-zinc-600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .login-input:focus {
        @apply border-indigo-400 dark:border-indigo-500/70 ring-4 ring-indigo-500/10 dark:ring-indigo-500/20;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    /* 暗色模式下的炫光效果 */
    :global(.dark) .login-input:focus {
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15), 0 0 20px rgba(99, 102, 241, 0.2);
    }

    /* 密码输入框特殊样式 */
    input[type="password"].login-input {
        letter-spacing: 0.15em;
    }
</style>
