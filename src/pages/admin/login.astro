---
export const prerender = false;
import AdminLayout from "../../layouts/AdminLayout.astro";
import {siteConfig} from "../../config";
import I18nKey from "@/i18n/i18nKey";
import {i18n} from "@/i18n/translation";

// i18n translations for inline script
const loginI18n = {
    loginFailed: i18n(I18nKey.adminLoginFailed),
    connectionFailed: i18n(I18nKey.adminPostLoadFailed),
};
---

<AdminLayout title={`${i18n(I18nKey.adminLogin)} - ${siteConfig.title}`} hideNav={true}>
    <div class="flex items-center justify-center min-h-screen px-6">
        <div
                class="w-full max-w-md p-10 bg-white/90 dark:bg-zinc-900/90 rounded-3xl shadow-2xl border border-white/20 dark:border-zinc-700/50 backdrop-blur-xl onload-animation"
        >
            <div class="text-center mb-10">
                <div
                        class="w-16 h-16 bg-[var(--primary)] text-white flex items-center justify-center rounded-2xl mx-auto mb-4 text-2xl font-bold shadow-lg"
                >
                    F
                </div>
                <h1
                        class="text-3xl font-bold text-zinc-900 dark:text-zinc-100 mb-2"
                >
                    {i18n(I18nKey.adminLoginTitle)}
                </h1>
                <p class="text-zinc-500 dark:text-zinc-400">
                    {i18n(I18nKey.adminLoginSubtitle)}
                </p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label
                            class="block text-sm font-bold text-zinc-700 dark:text-zinc-300 mb-2 uppercase tracking-wider"
                    >{i18n(I18nKey.adminUsername)}</label
                    >
                    <input
                            type="text"
                            id="username"
                            required
                            placeholder="用户名"
                            class="w-full px-5 py-4 border rounded-xl focus:ring-2 focus:ring-[var(--primary)] bg-zinc-50 dark:bg-zinc-800/50 border-zinc-200 dark:border-zinc-700 text-zinc-900 dark:text-zinc-100 transition-all outline-none"
                    />
                </div>
                <div>
                    <label
                            class="block text-sm font-bold text-zinc-700 dark:text-zinc-300 mb-2 uppercase tracking-wider"
                    >{i18n(I18nKey.adminPassword)}</label
                    >
                    <input
                            type="password"
                            id="password"
                            required
                            placeholder="密码"
                            class="w-full px-5 py-4 border rounded-xl focus:ring-2 focus:ring-[var(--primary)] bg-zinc-50 dark:bg-zinc-800/50 border-zinc-200 dark:border-zinc-700 text-zinc-900 dark:text-zinc-100 transition-all outline-none"
                    />
                </div>
                <button
                        type="submit"
                        id="loginBtn"
                        class="w-full py-4 bg-[var(--primary)] hover:opacity-90 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all active:scale-[0.98]"
                        data-login-text={i18n(I18nKey.adminLoginButton)}
                        data-logging-in-text={i18n(I18nKey.adminLoggingIn)}
                >
                    {i18n(I18nKey.adminLoginButton)}
                </button>
                <p
                        id="errorMsg"
                        class="text-red-500 text-sm font-medium hidden text-center animate-bounce"
                >
                </p>
            </form>
        </div>
    </div>
</AdminLayout>

<script is:inline define:vars={{loginI18n}}>
    const form = document.getElementById("loginForm");
    const errorMsg = document.getElementById("errorMsg");
    const loginBtn = document.getElementById("loginBtn");

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        // Show loading state
        if (loginBtn) {
            loginBtn.textContent = loginBtn.dataset.loggingInText;
            loginBtn.disabled = true;
        }

        const formData = new FormData();
        formData.append("username", username);
        formData.append("password", password);

        try {
            const response = await fetch("http://localhost:8000/token", {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem("adminToken", data.access_token);
                window.location.href = "/admin/";
            } else {
                if (errorMsg) {
                    errorMsg.textContent = loginI18n.loginFailed;
                    errorMsg.classList.remove("hidden");
                }
                // Reset button
                if (loginBtn) {
                    loginBtn.textContent = loginBtn.dataset.loginText;
                    loginBtn.disabled = false;
                }
            }
        } catch (err) {
            console.error(err);
            if (errorMsg) {
                errorMsg.textContent = loginI18n.connectionFailed;
                errorMsg.classList.remove("hidden");
            }
            // Reset button
            if (loginBtn) {
                loginBtn.textContent = loginBtn.dataset.loginText;
                loginBtn.disabled = false;
            }
        }
    });
</script>
