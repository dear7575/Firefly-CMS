---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();
---

<AdminLayout
    title={`安全设置 - ${siteConfig.title}`}
    activeMenu="settings"
>
    <div class="p-6 lg:p-8">
        <!-- 页面标题 -->
        <div class="mb-6">
            <div class="flex items-center gap-2 text-sm text-zinc-500 mb-2">
                <a href="/admin/settings" class="hover:text-[var(--primary)]">系统设置</a>
                <span>/</span>
                <span>安全设置</span>
            </div>
            <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">
                安全设置
            </h1>
            <p class="text-sm text-zinc-500 mt-1">
                管理账户安全和两步验证
            </p>
        </div>

        <div class="max-w-2xl space-y-6">
            <!-- 2FA 状态卡片 -->
            <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h2 class="font-bold text-zinc-900 dark:text-zinc-100">两步验证 (2FA)</h2>
                        <p class="text-xs text-zinc-500">使用验证器 App 增加账户安全性</p>
                    </div>
                    <span id="statusBadge" class="px-3 py-1 rounded-full text-sm font-medium bg-zinc-100 dark:bg-zinc-800 text-zinc-500">
                        加载中...
                    </span>
                </div>

                <div class="p-6">
                    <!-- 加载状态 -->
                    <div id="loadingSection" class="text-center py-8">
                        <div class="animate-spin w-8 h-8 border-2 border-[var(--primary)] border-t-transparent rounded-full mx-auto"></div>
                        <p class="text-sm text-zinc-500 mt-3">正在加载...</p>
                    </div>

                    <!-- 未启用状态 -->
                    <div id="setupSection" class="hidden">
                        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 mb-6">
                            <div class="flex gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600 dark:text-amber-400 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                                <div>
                                    <h3 class="font-medium text-amber-800 dark:text-amber-200">建议启用两步验证</h3>
                                    <p class="text-sm text-amber-700 dark:text-amber-300 mt-1">两步验证可以有效防止账户被未授权访问，即使密码泄露也能保护您的账户安全。</p>
                                </div>
                            </div>
                        </div>
                        <button id="setupBtn" class="w-full py-3 bg-[var(--primary)] hover:opacity-90 text-white rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-[0.98] primary-glow">
                            启用两步验证
                        </button>
                    </div>

                    <!-- 设置流程 - 第1步：扫描二维码 -->
                    <div id="qrSection" class="hidden">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center gap-2 px-3 py-1 bg-zinc-100 dark:bg-zinc-800 text-[var(--primary)] rounded-full text-sm font-medium mb-4">
                                <span class="w-5 h-5 bg-[var(--primary)] text-white rounded-full text-xs flex items-center justify-center">1</span>
                                扫描二维码
                            </div>
                            <p class="text-sm text-zinc-600 dark:text-zinc-400">
                                使用 Google Authenticator、Microsoft Authenticator 或其他验证器 App 扫描下方二维码
                            </p>
                        </div>

                        <div class="flex justify-center mb-6">
                            <div class="p-4 bg-white rounded-xl border border-zinc-200 dark:border-zinc-700 shadow-sm">
                                <img id="qrCode" class="w-48 h-48" alt="2FA QR Code" />
                            </div>
                        </div>

                        <div class="bg-zinc-50 dark:bg-zinc-800/50 rounded-xl p-4 mb-6">
                            <p class="text-xs text-zinc-500 mb-2">无法扫描？手动输入密钥：</p>
                            <div class="flex items-center gap-2">
                                <code id="manualKey" class="flex-1 bg-white dark:bg-zinc-800 px-3 py-2 rounded-lg font-mono text-sm text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-zinc-700"></code>
                                <button id="copyKeyBtn" class="px-3 py-2 text-[var(--primary)] hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors" title="复制">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
                                输入验证器 App 中的 6 位验证码
                            </label>
                            <input
                                type="text"
                                id="verifyCode"
                                maxlength="6"
                                pattern="\d{6}"
                                inputmode="numeric"
                                autocomplete="one-time-code"
                                placeholder="000000"
                                class="w-full px-4 py-3 border border-zinc-200 dark:border-zinc-700 rounded-xl bg-white dark:bg-zinc-800 text-center text-2xl tracking-[0.5em] font-mono security-input outline-none"
                            />
                        </div>

                        <div class="flex gap-3">
                            <button id="cancelSetupBtn" class="flex-1 py-3 border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-400 rounded-xl font-medium hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-all">
                                取消
                            </button>
                            <button id="confirmSetupBtn" class="flex-1 py-3 bg-[var(--primary)] hover:opacity-90 text-white rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-[0.98] primary-glow">
                                确认启用
                            </button>
                        </div>
                    </div>

                    <!-- 设置流程 - 第2步：保存恢复码 -->
                    <div id="recoverySection" class="hidden">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center gap-2 px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full text-sm font-medium mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                两步验证已启用
                            </div>
                            <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-100 mb-2">保存您的恢复码</h3>
                            <p class="text-sm text-zinc-600 dark:text-zinc-400">
                                如果您无法访问验证器 App，可以使用恢复码登录。每个恢复码只能使用一次。
                            </p>
                        </div>

                        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 mb-6">
                            <div class="flex gap-2 items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600 dark:text-amber-400 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                                <p class="text-sm text-amber-700 dark:text-amber-300">
                                    <strong>请妥善保存这些恢复码！</strong>它们只会显示一次。建议保存到安全的地方，如密码管理器。
                                </p>
                            </div>
                        </div>

                        <div id="recoveryCodes" class="grid grid-cols-2 gap-2 font-mono text-sm bg-zinc-100 dark:bg-zinc-800 p-4 rounded-xl mb-6">
                            <!-- 恢复码会通过 JS 填充 -->
                        </div>

                        <div class="flex gap-3 mb-6">
                            <button id="downloadCodesBtn" class="flex-1 py-2.5 border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-400 rounded-xl font-medium hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-all flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                下载恢复码
                            </button>
                            <button id="copyCodesBtn" class="flex-1 py-2.5 border border-zinc-200 dark:border-zinc-700 text-zinc-600 dark:text-zinc-400 rounded-xl font-medium hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-all flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                复制恢复码
                            </button>
                        </div>

                        <button id="doneBtn" class="w-full py-3 bg-[var(--primary)] hover:opacity-90 text-white rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-[0.98] primary-glow">
                            完成设置
                        </button>
                    </div>

                    <!-- 已启用状态 -->
                    <div id="enabledSection" class="hidden">
                        <div class="flex items-center gap-3 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl mb-6">
                            <div class="w-10 h-10 bg-green-100 dark:bg-green-900/40 rounded-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 dark:text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-medium text-green-800 dark:text-green-200">两步验证已启用</h3>
                                <p id="enabledAt" class="text-sm text-green-600 dark:text-green-400"></p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl">
                                <div>
                                    <h4 class="font-medium text-zinc-900 dark:text-zinc-100">剩余恢复码</h4>
                                    <p class="text-sm text-zinc-500">用于在无法使用验证器时登录</p>
                                </div>
                                <span id="recoveryCount" class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">-</span>
                            </div>

                            <button id="regenerateBtn" class="w-full py-3 border border-zinc-200 dark:border-zinc-700 text-zinc-700 dark:text-zinc-300 rounded-xl font-medium hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-all flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                重新生成恢复码
                            </button>

                            <button id="disableBtn" class="w-full py-3 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 rounded-xl font-medium hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                                禁用两步验证
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 修改密码卡片 -->
            <div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-zinc-600 dark:text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-bold text-zinc-900 dark:text-zinc-100">修改密码</h2>
                        <p class="text-xs text-zinc-500">定期更换密码可以提高账户安全性</p>
                    </div>
                </div>
                <div class="p-6">
                    <a href="/admin/settings" class="inline-flex items-center gap-2 text-[var(--primary)] hover:underline">
                        前往系统设置修改密码
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 禁用 2FA 弹窗 -->
    <div id="disableModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-zinc-200 dark:border-zinc-800">
                <h2 class="text-xl font-bold text-zinc-900 dark:text-zinc-100">禁用两步验证</h2>
                <p class="text-sm text-zinc-500 mt-1">请输入密码和验证码确认禁用</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">当前密码</label>
                    <input type="password" id="disablePassword" class="w-full px-4 py-2.5 border border-zinc-200 dark:border-zinc-700 rounded-xl bg-white dark:bg-zinc-800 security-input outline-none" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">验证码</label>
                    <input type="text" id="disableTotpCode" maxlength="6" pattern="\d{6}" inputmode="numeric" placeholder="000000" class="w-full px-4 py-2.5 border border-zinc-200 dark:border-zinc-700 rounded-xl bg-white dark:bg-zinc-800 text-center tracking-widest font-mono security-input outline-none" />
                </div>
            </div>
            <div class="p-6 border-t border-zinc-200 dark:border-zinc-800 flex justify-end gap-3">
                <button id="cancelDisableBtn" class="px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors">取消</button>
                <button id="confirmDisableBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500 transition-colors">确认禁用</button>
            </div>
        </div>
    </div>

    <!-- 重新生成恢复码弹窗 -->
    <div id="regenerateModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-zinc-200 dark:border-zinc-800">
                <h2 class="text-xl font-bold text-zinc-900 dark:text-zinc-100">重新生成恢复码</h2>
                <p class="text-sm text-zinc-500 mt-1">旧的恢复码将全部失效</p>
            </div>
            <div class="p-6">
                <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">输入验证码确认</label>
                <input type="text" id="regenerateTotpCode" maxlength="6" pattern="\d{6}" inputmode="numeric" placeholder="000000" class="w-full px-4 py-2.5 border border-zinc-200 dark:border-zinc-700 rounded-xl bg-white dark:bg-zinc-800 text-center tracking-widest font-mono security-input outline-none" />
            </div>
            <div class="p-6 border-t border-zinc-200 dark:border-zinc-800 flex justify-end gap-3">
                <button id="cancelRegenerateBtn" class="px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors">取消</button>
                <button id="confirmRegenerateBtn" class="px-6 py-2 bg-[var(--primary)] text-white rounded-lg hover:opacity-90 transition-colors primary-glow">确认生成</button>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline>
document.addEventListener("astro:page-load", () => {
    (function() {
        const API_URL = window.API_URL;
        let currentRecoveryCodes = [];

        // DOM 元素
        const statusBadge = document.getElementById("statusBadge");
        const loadingSection = document.getElementById("loadingSection");
        const setupSection = document.getElementById("setupSection");
        const qrSection = document.getElementById("qrSection");
        const recoverySection = document.getElementById("recoverySection");
        const enabledSection = document.getElementById("enabledSection");

        // 隐藏所有区域
        function hideAllSections() {
            loadingSection?.classList.add("hidden");
            setupSection?.classList.add("hidden");
            qrSection?.classList.add("hidden");
            recoverySection?.classList.add("hidden");
            enabledSection?.classList.add("hidden");
        }

        // 加载 2FA 状态
        async function loadStatus() {
            try {
                const result = await window.adminRequest(`${API_URL}/totp/status`);
                if (!result.ok) throw new Error(result.msg);

                hideAllSections();

                if (result.data.enabled && result.data.verified) {
                    // 已启用
                    statusBadge.textContent = "已启用";
                    statusBadge.className = "px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400";
                    enabledSection.classList.remove("hidden");

                    // 显示启用时间
                    const enabledAt = document.getElementById("enabledAt");
                    if (enabledAt && result.data.enabled_at) {
                        const date = new Date(result.data.enabled_at);
                        enabledAt.textContent = `启用于 ${date.toLocaleDateString("zh-CN")}`;
                    }

                    // 显示恢复码数量
                    const recoveryCount = document.getElementById("recoveryCount");
                    if (recoveryCount) {
                        recoveryCount.textContent = result.data.recovery_codes_count || 0;
                    }
                } else {
                    // 未启用
                    statusBadge.textContent = "未启用";
                    statusBadge.className = "px-3 py-1 rounded-full text-sm font-medium bg-zinc-100 dark:bg-zinc-800 text-zinc-500";
                    setupSection.classList.remove("hidden");
                }
            } catch (err) {
                console.error(err);
                window.showAdminAlert?.("加载状态失败: " + err.message, "error");
            }
        }

        // 开始设置 2FA
        async function startSetup() {
            try {
                const result = await window.adminRequest(`${API_URL}/totp/setup`, {
                    method: "POST"
                });
                if (!result.ok) throw new Error(result.msg);

                // 显示二维码
                document.getElementById("qrCode").src = result.data.qr_code;
                document.getElementById("manualKey").textContent = result.data.manual_entry_key;

                hideAllSections();
                qrSection.classList.remove("hidden");
                document.getElementById("verifyCode").focus();
            } catch (err) {
                console.error(err);
                window.showAdminAlert?.("生成二维码失败: " + err.message, "error");
            }
        }

        // 确认启用
        async function confirmSetup() {
            const code = document.getElementById("verifyCode").value;
            if (!code || code.length !== 6) {
                window.showAdminAlert?.("请输入 6 位验证码", "error");
                return;
            }

            try {
                const result = await window.adminRequest(`${API_URL}/totp/verify`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code })
                });

                if (!result.ok) throw new Error(result.msg);

                // 保存恢复码并显示
                currentRecoveryCodes = result.data.recovery_codes;
                renderRecoveryCodes(currentRecoveryCodes);

                hideAllSections();
                recoverySection.classList.remove("hidden");

                statusBadge.textContent = "已启用";
                statusBadge.className = "px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400";
            } catch (err) {
                console.error(err);
                window.showAdminAlert?.("验证失败: " + err.message, "error");
            }
        }

        // 渲染恢复码
        function renderRecoveryCodes(codes) {
            const container = document.getElementById("recoveryCodes");
            if (!container) return;
            container.innerHTML = codes.map(code =>
                `<div class="px-3 py-2 bg-white dark:bg-zinc-700 rounded-lg text-center">${code}</div>`
            ).join("");
        }

        // 下载恢复码
        function downloadCodes() {
            const content = `Firefly CMS 两步验证恢复码\n${"=".repeat(30)}\n\n${currentRecoveryCodes.join("\n")}\n\n注意：每个恢复码只能使用一次。\n请妥善保存到安全的地方。`;
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "firefly-cms-recovery-codes.txt";
            a.click();
            URL.revokeObjectURL(url);
        }

        // 复制恢复码
        function copyCodes() {
            navigator.clipboard.writeText(currentRecoveryCodes.join("\n")).then(() => {
                window.showAdminAlert?.("恢复码已复制到剪贴板", "success");
            });
        }

        // 复制密钥
        function copyKey() {
            const key = document.getElementById("manualKey").textContent;
            navigator.clipboard.writeText(key).then(() => {
                window.showAdminAlert?.("密钥已复制到剪贴板", "success");
            });
        }

        // 禁用 2FA
        async function disableTOTP() {
            const password = document.getElementById("disablePassword").value;
            const code = document.getElementById("disableTotpCode").value;

            if (!password) {
                window.showAdminAlert?.("请输入密码", "error");
                return;
            }
            if (!code || code.length !== 6) {
                window.showAdminAlert?.("请输入 6 位验证码", "error");
                return;
            }

            try {
                const result = await window.adminRequest(`${API_URL}/totp/disable`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password, code })
                });

                if (!result.ok) throw new Error(result.msg);

                hideModal("disableModal");
                window.showAdminAlert?.("两步验证已禁用", "success");
                loadStatus();
            } catch (err) {
                console.error(err);
                window.showAdminAlert?.("禁用失败: " + err.message, "error");
            }
        }

        // 重新生成恢复码
        async function regenerateCodes() {
            const code = document.getElementById("regenerateTotpCode").value;
            if (!code || code.length !== 6) {
                window.showAdminAlert?.("请输入 6 位验证码", "error");
                return;
            }

            try {
                const result = await window.adminRequest(`${API_URL}/totp/regenerate-recovery`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code })
                });

                if (!result.ok) throw new Error(result.msg);

                hideModal("regenerateModal");

                // 显示新恢复码
                currentRecoveryCodes = result.data.recovery_codes;
                renderRecoveryCodes(currentRecoveryCodes);

                hideAllSections();
                recoverySection.classList.remove("hidden");
            } catch (err) {
                console.error(err);
                window.showAdminAlert?.("生成失败: " + err.message, "error");
            }
        }

        // 显示弹窗
        function showModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove("hidden");
                modal.classList.add("flex");
            }
        }

        // 隐藏弹窗
        function hideModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add("hidden");
                modal.classList.remove("flex");
                // 清空输入
                modal.querySelectorAll("input").forEach(input => input.value = "");
            }
        }

        // 绑定事件
        document.getElementById("setupBtn")?.addEventListener("click", startSetup);
        document.getElementById("cancelSetupBtn")?.addEventListener("click", () => {
            hideAllSections();
            setupSection.classList.remove("hidden");
        });
        document.getElementById("confirmSetupBtn")?.addEventListener("click", confirmSetup);
        document.getElementById("doneBtn")?.addEventListener("click", loadStatus);
        document.getElementById("downloadCodesBtn")?.addEventListener("click", downloadCodes);
        document.getElementById("copyCodesBtn")?.addEventListener("click", copyCodes);
        document.getElementById("copyKeyBtn")?.addEventListener("click", copyKey);

        // 验证码输入自动提交
        document.getElementById("verifyCode")?.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/\D/g, "");
            if (e.target.value.length === 6) {
                confirmSetup();
            }
        });

        // 禁用弹窗
        document.getElementById("disableBtn")?.addEventListener("click", () => showModal("disableModal"));
        document.getElementById("cancelDisableBtn")?.addEventListener("click", () => hideModal("disableModal"));
        document.getElementById("confirmDisableBtn")?.addEventListener("click", disableTOTP);
        document.getElementById("disableModal")?.addEventListener("click", (e) => {
            if (e.target === e.currentTarget) hideModal("disableModal");
        });

        // 重新生成弹窗
        document.getElementById("regenerateBtn")?.addEventListener("click", () => showModal("regenerateModal"));
        document.getElementById("cancelRegenerateBtn")?.addEventListener("click", () => hideModal("regenerateModal"));
        document.getElementById("confirmRegenerateBtn")?.addEventListener("click", regenerateCodes);
        document.getElementById("regenerateModal")?.addEventListener("click", (e) => {
            if (e.target === e.currentTarget) hideModal("regenerateModal");
        });

        // 初始化
        loadStatus();
    })();
});
</script>
