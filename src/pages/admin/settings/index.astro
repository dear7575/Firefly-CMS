---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();

// 分组名称映射
    const groupLabels: Record<string, string> = {
        basic: "基本信息",
        brand: "品牌设置",
        profile: "个人资料",
        theme: "主题设置",
        footer: "页脚设置",
        feature: "功能开关",
        analytics: "统计埋点",
        backup: "备份设置",
        comment: "评论设置",
        post: "文章设置",
        general: "通用设置",
        bangumi: "番组计划",
        banner: "横幅设置",
    page: "页面开关",
    wallpaper: "壁纸设置",
    waves: "波浪动画",
    advertisement: "广告设置",
};

// 分组图标映射
    const groupIcons: Record<string, string> = {
        basic: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
        brand: "M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01",
        profile:
            "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z",
        theme: "M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01",
        footer: "M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z",
        feature:
            "M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z",
        analytics:
            "M9 12h6m-3-3v6m9 0a9 9 0 11-18 0 9 9 0 0118 0zm-9-7v4",
        backup:
            "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
        comment:
            "M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z",
    post: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z",
    general:
        "M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4",
    bangumi:
        "M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z",
    banner: "M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z",
    page: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z",
    wallpaper:
        "M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z",
    waves: "M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5",
    advertisement:
        "M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z",
};
---

<AdminLayout
    title={`${i18n(I18nKey.adminSystemManagement)} - ${siteConfig.title}`}
    activeMenu="settings"
>
    <div class="p-6 lg:p-8">
        <!-- 页面标题 -->
        <div
            class="flex items-center justify-between gap-3 mb-6"
        >
            <div class="min-w-0">
                <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">
                    {i18n(I18nKey.adminSystemManagement)}
                </h1>
                <p class="text-sm text-zinc-500 mt-1">
                    {i18n(I18nKey.adminManageSiteSettings)}
                </p>
            </div>
            <div class="flex items-center gap-3 flex-shrink-0">
                <a
                    href="/admin/backup"
                    class="bg-white dark:bg-zinc-900 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 hover:shadow-sm text-zinc-700 dark:text-zinc-300 px-4 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 border border-zinc-200 dark:border-zinc-800"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 7v10a2 2 0 002 2h12a2 2 0 002-2V7m-3-4h-6a2 2 0 00-2 2v2h10V5a2 2 0 00-2-2z"
                        ></path>
                    </svg>
                    {i18n(I18nKey.adminBackupManagement)}
                </a>
                <button
                    id="initSettingsBtn"
                    class="bg-white dark:bg-zinc-900 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 hover:shadow-sm text-zinc-700 dark:text-zinc-300 px-4 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 border border-zinc-200 dark:border-zinc-800"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        ></path>
                    </svg>
                    {i18n(I18nKey.adminInitSettings)}
                </button>
                <button
                    id="addSettingBtn"
                    class="bg-[var(--primary)] dark:bg-zinc-800 hover:opacity-90 dark:hover:bg-zinc-700 text-white dark:text-zinc-100 px-6 py-2.5 rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2 primary-glow"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                            clip-rule="evenodd"></path>
                    </svg>
                    {i18n(I18nKey.adminAdd)}
                    {i18n(I18nKey.adminSettings)}
                </button>
            </div>
        </div>

        <!-- 分组标签页 -->
        <div class="mb-6 overflow-x-auto">
            <div id="groupTabs" class="flex gap-2 min-w-max">
                <button
                    data-group="all"
                    class="group-tab active px-4 py-2 rounded-lg text-sm font-medium transition-all bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 border border-transparent primary-glow"
                >
                    {i18n(I18nKey.bangumiFilterAll)}
                </button>
            </div>
        </div>

        <!-- 设置列表 -->
        <div class="space-y-6" id="settingsContainer">
            <div class="text-center py-12 text-zinc-500">
                {i18n(I18nKey.adminLoading)}
            </div>
        </div>
    </div>

    <!-- 编辑弹窗 -->
    <div
        id="settingModal"
        class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    >
        <div
            class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto"
        >
            <div
                class="p-6 border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white dark:bg-zinc-900"
            >
                <h2
                    id="modalTitle"
                    class="text-xl font-bold text-zinc-900 dark:text-zinc-100"
                >
                    添加配置
                </h2>
            </div>
            <form id="settingForm" class="p-6 space-y-4">
                <input type="hidden" id="settingId" />
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >键名 <span class="text-red-500">*</span></label
                    >
                    <input
                        type="text"
                        id="settingKey"
                        required
                        class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none"
                        placeholder="例如: site_title"
                    />
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >值</label
                    >
                    <!-- 普通文本输入 -->
                    <textarea
                        id="settingValue"
                        rows="3"
                        class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none resize-none"
                    ></textarea>
                    <div id="settingImagePickerRow" class="hidden mt-3 flex items-center gap-2">
                        <button
                            type="button"
                            id="settingImagePickerBtn"
                            class="h-[46px] px-3 rounded-xl bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 hover:shadow-sm text-zinc-700 dark:text-zinc-300 text-sm font-medium transition-all flex items-center justify-center"
                        >
                            从媒体库
                        </button>
                        <span class="text-xs text-zinc-400">图片类配置可直接选择</span>
                    </div>
                    <div id="settingImagePreview" class="hidden mt-3 w-full rounded-xl overflow-hidden border border-zinc-200 dark:border-zinc-700 bg-zinc-100 dark:bg-zinc-800">
                        <img id="settingImagePreviewImg" src="" alt="图片预览" class="w-full max-h-48 object-cover" />
                    </div>
                    <!-- Boolean 开关 -->
                    <div id="settingBooleanContainer" class="hidden">
                        <div class="flex items-center gap-3">
                            <div id="settingBooleanSwitch" class="toggle-switch" data-value="false"></div>
                            <span id="settingBooleanLabel" class="text-sm text-zinc-600 dark:text-zinc-400">否</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                            >类型</label
                        >
                        <!-- 自定义类型选择器 -->
                        <div class="custom-select" id="typeSelector">
                            <div class="custom-select-trigger" id="typeTrigger">
                                <span class="custom-select-value" id="typeValue">字符串</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="custom-select-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                            <div class="custom-select-dropdown hidden" id="typeDropdown">
                                <div class="custom-select-options" id="typeOptions">
                                    <div class="custom-select-option selected" data-value="string">
                                        <span class="custom-select-option-name">字符串</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="custom-select-option-check" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <div class="custom-select-option" data-value="text">
                                        <span class="custom-select-option-name">长文本</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="custom-select-option-check" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <div class="custom-select-option" data-value="number">
                                        <span class="custom-select-option-name">数字</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="custom-select-option-check" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <div class="custom-select-option" data-value="boolean">
                                        <span class="custom-select-option-name">布尔值</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="custom-select-option-check" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <div class="custom-select-option" data-value="json">
                                        <span class="custom-select-option-name">JSON</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="custom-select-option-check" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="settingType" value="string" />
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                            >分组</label
                        >
                        <!-- 自定义分组选择器 -->
                        <div class="custom-select" id="groupSelector">
                            <div class="custom-select-trigger" id="groupTrigger">
                                <span class="custom-select-value" id="groupValue">基本信息</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="custom-select-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                            <div class="custom-select-dropdown hidden" id="groupDropdown">
                                <div class="custom-select-search">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                    <input type="text" id="groupSearch" placeholder="搜索分组..." />
                                </div>
                                <div class="custom-select-options" id="groupOptions">
                                    <!-- 分组选项会通过 JS 动态填充 -->
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="settingGroup" value="basic" />
                    </div>
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >显示标签</label
                    >
                    <input
                        type="text"
                        id="settingLabel"
                        class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none"
                        placeholder="用于后台显示的友好名称"
                    />
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2"
                        >描述</label
                    >
                    <input
                        type="text"
                        id="settingDescription"
                        class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none"
                        placeholder="配置项的说明文字"
                    />
                </div>
            </form>
            <div
                class="p-6 border-t border-zinc-200 dark:border-zinc-800 flex justify-end gap-3 sticky bottom-0 bg-white dark:bg-zinc-900"
            >
                <button
                    type="button"
                    id="cancelBtn"
                    class="px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors"
                    >{i18n(I18nKey.adminCancel)}</button
                >
                <button
                    type="submit"
                    form="settingForm"
                    class="px-6 py-2 bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 rounded-lg hover:opacity-90 dark:hover:bg-zinc-700 transition-colors primary-glow"
                    >{i18n(I18nKey.adminSave)}</button
                >
            </div>
        </div>
    </div>

    <!-- 媒体库选择器 -->
    <div id="mediaPickerModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-5xl border border-zinc-200 dark:border-zinc-800 shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-zinc-900 dark:text-zinc-100">选择图片</h3>
                    <p class="text-xs text-zinc-500">从媒体库选择图片地址</p>
                </div>
                <button id="mediaPickerClose" class="w-9 h-9 rounded-xl bg-zinc-100 dark:bg-zinc-800 text-zinc-500 hover:bg-zinc-200 dark:hover:bg-zinc-700 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 flex flex-col gap-3">
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                    <div class="relative w-full sm:w-72">
                        <input id="mediaPickerSearch" type="text" placeholder="搜索图片..." class="w-full px-4 h-10 pl-10 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 text-sm focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent outline-none transition-all" />
                        <svg class="w-5 h-5 text-zinc-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <div class="text-xs text-zinc-500" id="mediaPickerCount">0</div>
                </div>
                <div id="mediaPickerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 min-h-[240px]">
                    <div class="col-span-full text-center text-sm text-zinc-500 py-10">加载中...</div>
                </div>
                <div class="flex items-center justify-between text-sm text-zinc-500">
                    <button id="mediaPickerPrev" class="px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">上一页</button>
                    <span id="mediaPickerPage">1/1</span>
                    <button id="mediaPickerNext" class="px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">下一页</button>
                </div>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline define:vars={{ groupLabels, groupIcons }}>
    document.addEventListener("astro:page-load", () => {
        (function () {
            var settings = [];
            var currentGroup = "all";
            var API_URL = window.API_URL;

            // 分组名称和图标
            var GROUP_LABELS = groupLabels;
            var GROUP_ICONS = groupIcons;

            // i18n 文案
            var t = window.adminI18n || {};
            var currentSettingForPicker = null;

            setupMediaPicker();

            function getFormSettingCandidate() {
                var keyEl = document.getElementById("settingKey");
                var labelEl = document.getElementById("settingLabel");
                var typeEl = document.getElementById("settingType");
                return {
                    key: keyEl ? keyEl.value : "",
                    label: labelEl ? labelEl.value : "",
                    type: typeEl ? typeEl.value : "string",
                };
            }

            function isImageSetting(setting) {
                if (!setting) return false;
                var key = (setting.key || "").toLowerCase();
                var label = setting.label || "";
                if (
                    key.includes("type") ||
                    key.includes("mode") ||
                    key.includes("layout") ||
                    key.includes("position") ||
                    key.includes("offset") ||
                    /类型|模式|位置|偏移/.test(label)
                ) {
                    return false;
                }
                return (
                    key.includes("logo") ||
                    key.includes("favicon") ||
                    key.includes("avatar") ||
                    key.includes("image") ||
                    key.includes("cover") ||
                    key.includes("banner") ||
                    key.includes("wallpaper") ||
                    key.includes("background") ||
                    key.includes("qr") ||
                    key.includes("icon") ||
                    /图标|图片|头像|封面|壁纸|背景/.test(label)
                );
            }

            function isLikelyImageUrl(value) {
                if (!value) return false;
                if (value.startsWith("data:image/")) return true;
                if (value.startsWith("http://") || value.startsWith("https://")) return true;
                if (value.startsWith("/")) return true;
                return false;
            }

            function updateImagePreview(value) {
                var previewWrap = document.getElementById("settingImagePreview");
                var previewImg = document.getElementById("settingImagePreviewImg");
                if (!previewWrap || !previewImg) return;

                if (!value || !isLikelyImageUrl(value)) {
                    previewWrap.classList.add("hidden");
                    previewImg.src = "";
                    return;
                }

                previewWrap.classList.remove("hidden");
                previewImg.onerror = function () {
                    previewWrap.classList.add("hidden");
                };
                previewImg.src = value;
            }

            function refreshImagePickerUI() {
                var row = document.getElementById("settingImagePickerRow");
                var previewWrap = document.getElementById("settingImagePreview");
                var valueEl = document.getElementById("settingValue");
                var candidate = currentSettingForPicker || getFormSettingCandidate();
                var isImage =
                    candidate &&
                    candidate.type === "string" &&
                    isImageSetting(candidate);

                if (row) row.classList.toggle("hidden", !isImage);
                if (!isImage) {
                    previewWrap?.classList.add("hidden");
                    return;
                }
                updateImagePreview(valueEl ? valueEl.value : "");
            }

            function setupMediaPicker() {
                var modal = document.getElementById("mediaPickerModal");
                if (!modal || modal.dataset.bound === "true") {
                    return;
                }
                modal.dataset.bound = "true";

                var openBtn = document.getElementById("settingImagePickerBtn");
                var closeBtn = document.getElementById("mediaPickerClose");
                var searchInput = document.getElementById("mediaPickerSearch");
                var grid = document.getElementById("mediaPickerGrid");
                var countEl = document.getElementById("mediaPickerCount");
                var prevBtn = document.getElementById("mediaPickerPrev");
                var nextBtn = document.getElementById("mediaPickerNext");
                var pageEl = document.getElementById("mediaPickerPage");

                var currentPage = 1;
                var totalPages = 1;
                var keyword = "";
                var searchTimer = null;

                function isImageItem(item) {
                    if (item.mime_type && item.mime_type.indexOf("image/") === 0) {
                        return true;
                    }
                    var name = item.filename || "";
                    var ext = name.toLowerCase().split(".").pop();
                    return ["jpg", "jpeg", "png", "gif", "webp", "svg"].includes(ext);
                }

                function openPicker() {
                    currentPage = 1;
                    keyword = "";
                    if (searchInput) searchInput.value = "";
                    modal.classList.remove("hidden");
                    modal.classList.add("flex");
                    loadMedia();
                }

                function closePicker() {
                    modal.classList.add("hidden");
                    modal.classList.remove("flex");
                }

                async function loadMedia() {
                    if (!grid) return;
                    grid.innerHTML = '<div class="col-span-full text-center text-sm text-zinc-500 py-10">加载中...</div>';

                    try {
                        var query = "page=" + currentPage + "&page_size=40";
                        if (keyword) {
                            query += "&keyword=" + encodeURIComponent(keyword);
                        }
                        var result = await window.adminRequest(API_URL + "/upload/media?" + query, {
                            headers: {
                                "Authorization": "Bearer " + localStorage.getItem("adminToken")
                            }
                        });

                        if (!result.ok) {
                            throw new Error(result.msg || "加载失败");
                        }

                        var data = result.data || {};
                        var items = (data.items || []).filter(isImageItem);
                        var total = data.pagination ? data.pagination.total : items.length;
                        totalPages = data.pagination ? data.pagination.total_pages : 1;

                        if (countEl) {
                            countEl.textContent = "共 " + total + " 张图片";
                        }
                        if (pageEl) {
                            pageEl.textContent = currentPage + "/" + (totalPages || 1);
                        }
                        if (prevBtn) prevBtn.disabled = currentPage <= 1;
                        if (nextBtn) nextBtn.disabled = currentPage >= totalPages;

                        if (items.length === 0) {
                            grid.innerHTML = '<div class="col-span-full text-center text-sm text-zinc-500 py-10">暂无图片</div>';
                            return;
                        }

                        grid.innerHTML = items.map(function(item) {
                            var name = item.original_name || item.filename || "image";
                            return '' +
                                '<button type="button" class="group text-left rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden bg-white dark:bg-zinc-900 media-card-hover transition-all" data-url="' + item.url + '" data-name="' + name + '">' +
                                    '<div class="aspect-square bg-zinc-100 dark:bg-zinc-800 overflow-hidden">' +
                                        '<img src="' + item.url + '" alt="' + name + '" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition-transform" />' +
                                    '</div>' +
                                    '<div class="px-2 py-1.5 text-xs text-zinc-600 dark:text-zinc-300 truncate">' + name + '</div>' +
                                '</button>';
                        }).join("");

                        grid.querySelectorAll("button[data-url]").forEach(function(btn) {
                            btn.addEventListener("click", function() {
                                var url = this.dataset.url;
                                var valueEl = document.getElementById("settingValue");
                                if (valueEl) {
                                    valueEl.value = url;
                                    valueEl.dispatchEvent(new Event("input"));
                                }
                                updateImagePreview(url);
                                closePicker();
                            });
                        });
                    } catch (err) {
                        console.error("加载媒体失败:", err);
                        grid.innerHTML = '<div class="col-span-full text-center text-sm text-red-500 py-10">加载失败</div>';
                    }
                }

                openBtn?.addEventListener("click", openPicker);
                closeBtn?.addEventListener("click", closePicker);
                modal?.addEventListener("click", function(e) {
                    if (e.target === modal) {
                        closePicker();
                    }
                });

                searchInput?.addEventListener("input", function() {
                    keyword = this.value.trim();
                    clearTimeout(searchTimer);
                    searchTimer = setTimeout(function() {
                        currentPage = 1;
                        loadMedia();
                    }, 300);
                });

                prevBtn?.addEventListener("click", function() {
                    if (currentPage > 1) {
                        currentPage -= 1;
                        loadMedia();
                    }
                });

                nextBtn?.addEventListener("click", function() {
                    if (currentPage < totalPages) {
                        currentPage += 1;
                        loadMedia();
                    }
                });
            }

            async function loadSettings() {
                var container = document.getElementById("settingsContainer");
                if (!container) return;

                try {
                    var result = await window.adminRequest(`${API_URL}/settings`);
                    if (!result.ok) throw new Error(result.msg || "加载失败");
                    settings = result.data || [];

                    // 过滤掉 announcement (已有专门页面) 分组
                    settings = settings.filter(function (s) {
                        return s.group !== "announcement";
                    });

                    renderGroupTabs();
                    renderSettings();
                } catch (err) {
                    console.error(err);
                    if (container)
                        container.innerHTML =
                            '<div class="text-center py-12 text-red-500">' +
                            (t.loadFailed || "加载失败") +
                            "</div>";
                }
            }

            function renderGroupTabs() {
                var tabsContainer = document.getElementById("groupTabs");
                if (!tabsContainer) return;

                // 获取所有分组
                var groups = ["all"];
                settings.forEach(function (s) {
                    if (s.group && groups.indexOf(s.group) === -1) {
                        groups.push(s.group);
                    }
                });

                // 按预定义顺序排序
                var order = [
                    "all",
                    "basic",
                    "brand",
                    "profile",
                    "theme",
                    "footer",
                    "feature",
                    "analytics",
                    "backup",
                    "comment",
                    "post",
                    "api",
                    "general",
                    "bangumi",
                    "banner",
                    "page",
                    "wallpaper",
                    "waves",
                ];
                groups.sort(function (a, b) {
                    var ia = order.indexOf(a);
                    var ib = order.indexOf(b);
                    if (ia === -1) ia = 999;
                    if (ib === -1) ib = 999;
                    return ia - ib;
                });

                tabsContainer.innerHTML = groups
                    .map(function (group) {
                        var label =
                            group === "all"
                                ? t.all || "全部"
                                : GROUP_LABELS[group] || group;
                        var isActive = currentGroup === group;
                        var activeClass = isActive
                            ? "bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 border border-transparent primary-glow"
                            : "bg-white dark:bg-zinc-900 text-zinc-600 dark:text-zinc-400 border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-800 hover:border-zinc-300 dark:hover:border-zinc-700 hover:shadow-sm";
                        return (
                            '<button data-group="' +
                            group +
                            '" class="group-tab px-4 py-2 rounded-lg text-sm font-medium transition-all ' +
                            activeClass +
                            '">' +
                            label +
                            "</button>"
                        );
                    })
                    .join("");

                // 绑定点击事件
                tabsContainer
                    .querySelectorAll(".group-tab")
                    .forEach(function (btn) {
                        btn.addEventListener("click", function () {
                            currentGroup = btn.dataset.group;
                            renderGroupTabs();
                            renderSettings();
                        });
                    });
            }

            function renderSettings() {
                var container = document.getElementById("settingsContainer");
                if (!container) return;

                // 过滤设置
                var filtered =
                    currentGroup === "all"
                        ? settings
                        : settings.filter(function (s) {
                              return s.group === currentGroup;
                          });

                if (filtered.length === 0) {
                    container.innerHTML =
                        '<div class="text-center py-12 text-zinc-500">' +
                        (t.contentEmpty || "暂无配置项") +
                        "</div>";
                    return;
                }

                // 按分组组织
                var grouped = {};
                filtered.forEach(function (setting) {
                    var group = setting.group || "general";
                    if (!grouped[group]) grouped[group] = [];
                    grouped[group].push(setting);
                });

                // 渲染分组
                container.innerHTML = Object.keys(grouped)
                    .map(function (group) {
                        var items = grouped[group].sort(function (a, b) {
                            return b.sort_order - a.sort_order;
                        });
                        var groupLabel = GROUP_LABELS[group] || group;
                        var groupIcon =
                            GROUP_ICONS[group] || GROUP_ICONS.general;

                        var itemsHtml = items
                            .map(function (setting) {
                                var valueDisplay =
                                    setting.value ||
                                    '<span class="text-zinc-400">(' +
                                        (t.contentEmpty || "空") +
                                        ")</span>";

                                // 特殊处理 theme_hue 显示
                                if (setting.key === "theme_hue") {
                                    var hue = parseInt(setting.value || "165");
                                    var color = "oklch(0.65 0.25 " + hue + ")";
                                    valueDisplay =
                                        '<div class="flex items-center gap-3">' +
                                        '<div class="w-12 h-6 rounded border border-zinc-200 shadow-sm" style="background-color: ' +
                                        color +
                                        '"></div>' +
                                        '<span class="font-mono text-sm text-zinc-600 dark:text-zinc-400">' +
                                        hue +
                                        "</span>" +
                                        "</div>";
                                } else if (setting.type === "boolean") {
                                    var isTrue =
                                        setting.value &&
                                        setting.value.toLowerCase() === "true";
                                    valueDisplay =
                                        '<span class="px-2 py-0.5 rounded text-xs ' +
                                        (isTrue
                                            ? "bg-green-100 dark:bg-green-900/30 text-green-600"
                                            : "bg-zinc-100 dark:bg-zinc-800 text-zinc-500") +
                                        '">' +
                                        (isTrue
                                            ? t.active || "是"
                                            : t.disabled || "否") +
                                        "</span>";
                                } else if (
                                    setting.value &&
                                    setting.value.length > 50
                                ) {
                                    valueDisplay =
                                        setting.value.substring(0, 50) + "...";
                                }

                                return (
                                    '<div class="p-4 hover:bg-zinc-50 dark:hover:bg-zinc-800/30 transition-colors border-b border-zinc-100 dark:border-zinc-800 last:border-b-0">' +
                                    '<div class="flex items-start justify-between gap-4">' +
                                    '<div class="flex-1 min-w-0">' +
                                    '<div class="flex items-center gap-2 mb-1">' +
                                    '<h3 class="font-medium text-zinc-900 dark:text-zinc-100">' +
                                    (setting.label || setting.key) +
                                    "</h3>" +
                                    '<span class="px-2 py-0.5 text-[10px] rounded-full bg-zinc-100 dark:bg-zinc-800 text-zinc-500">' +
                                    setting.type +
                                    "</span>" +
                                    "</div>" +
                                    '<p class="text-xs text-zinc-400 mb-2 font-mono">' +
                                    setting.key +
                                    "</p>" +
                                    (setting.description
                                        ? '<p class="text-xs text-zinc-500 mb-2">' +
                                          setting.description +
                                          "</p>"
                                        : "") +
                                    '<div class="text-sm text-zinc-700 dark:text-zinc-300 bg-zinc-50 dark:bg-zinc-800/50 px-3 py-2 rounded-lg font-mono break-all">' +
                                    valueDisplay +
                                    "</div>" +
                                    "</div>" +
                                    '<div class="flex gap-1">' +
                                    "<button onclick=\"editSetting('" +
                                    setting.id +
                                    '\')" class="p-2 text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors" title="编辑">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>' +
                                    "</button>" +
                                    "<button onclick=\"deleteSetting('" +
                                    setting.id +
                                    "', '" +
                                    setting.key.replace(/'/g, "\\'") +
                                    '\')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors" title="删除">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>' +
                                    "</button>" +
                                    "</div>" +
                                    "</div>" +
                                    "</div>"
                                );
                            })
                            .join("");

                        return (
                            '<div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden">' +
                            '<div class="p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50 flex items-center gap-3">' +
                            '<div class="w-8 h-8 rounded-lg bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' +
                            groupIcon +
                            '" /></svg>' +
                            "</div>" +
                            "<div>" +
                            '<h2 class="font-bold text-zinc-900 dark:text-zinc-100">' +
                            groupLabel +
                            "</h2>" +
                            '<p class="text-xs text-zinc-500">' +
                            items.length +
                            " 项配置</p>" +
                            "</div>" +
                            "</div>" +
                            "<div>" +
                            itemsHtml +
                            "</div>" +
                            "</div>"
                        );
                    })
                    .join("");
            }

            function showModal(isEdit) {
                var modalTitle = document.getElementById("modalTitle");
                var settingModal = document.getElementById("settingModal");
                var settingKey = document.getElementById("settingKey");
                if (modalTitle)
                    modalTitle.textContent = isEdit
                        ? (t.edit || "编辑") +
                          " " +
                          (t.adminSystemManagement || "配置")
                        : (t.add || "添加") +
                          " " +
                          (t.adminSystemManagement || "配置");
                if (settingKey) settingKey.disabled = isEdit; // 编辑时禁止修改键名
                if (settingModal) {
                    settingModal.classList.remove("hidden");
                    settingModal.classList.add("flex");
                }
                refreshImagePickerUI();
            }

            function hideModal() {
                var settingModal = document.getElementById("settingModal");
                var settingForm = document.getElementById("settingForm");
                var settingId = document.getElementById("settingId");
                var settingKey = document.getElementById("settingKey");
                if (settingModal) {
                    settingModal.classList.add("hidden");
                    settingModal.classList.remove("flex");
                }
                if (settingForm) settingForm.reset();
                if (settingId) settingId.value = "";
                if (settingKey) settingKey.disabled = false;
                currentSettingForPicker = null;
                // 重置为文本输入模式
                updateValueInputMode("string");
            }

            // 根据类型切换值输入模式
            function updateValueInputMode(type) {
                var valueEl = document.getElementById("settingValue");
                var boolContainer = document.getElementById("settingBooleanContainer");

                if (type === "boolean") {
                    if (valueEl) valueEl.parentElement.querySelector("textarea").classList.add("hidden");
                    if (boolContainer) boolContainer.classList.remove("hidden");
                } else {
                    if (valueEl) valueEl.classList.remove("hidden");
                    if (boolContainer) boolContainer.classList.add("hidden");
                }
                refreshImagePickerUI();
            }

            // 设置开关状态
            function setBooleanSwitch(value) {
                var switchEl = document.getElementById("settingBooleanSwitch");
                var labelEl = document.getElementById("settingBooleanLabel");
                var isTrue = value && value.toLowerCase() === "true";

                if (switchEl) {
                    switchEl.dataset.value = isTrue ? "true" : "false";
                    if (isTrue) {
                        switchEl.classList.add("active");
                    } else {
                        switchEl.classList.remove("active");
                    }
                }
                if (labelEl) {
                    labelEl.textContent = isTrue ? "是" : "否";
                }
            }

            // ============== 自定义选择器逻辑 ==============
            var GROUP_OPTIONS = [
                { value: "basic", label: "基本信息" },
                { value: "brand", label: "品牌设置" },
                { value: "profile", label: "个人资料" },
                { value: "theme", label: "主题设置" },
                { value: "footer", label: "页脚设置" },
                { value: "feature", label: "功能开关" },
                { value: "post", label: "文章设置" },
                { value: "general", label: "通用设置" },
                { value: "bangumi", label: "番组计划" },
                { value: "banner", label: "横幅设置" },
                { value: "page", label: "页面开关" },
                { value: "wallpaper", label: "壁纸设置" },
                { value: "waves", label: "波浪动画" },
                { value: "advertisement", label: "广告设置" }
            ];

            var TYPE_LABELS = {
                "string": "字符串",
                "text": "长文本",
                "number": "数字",
                "boolean": "布尔值",
                "json": "JSON"
            };

            // 渲染分组选项
            function renderGroupOptions(filter) {
                var container = document.getElementById("groupOptions");
                if (!container) return;

                var filtered = filter
                    ? GROUP_OPTIONS.filter(function(g) { return g.label.includes(filter); })
                    : GROUP_OPTIONS;

                var currentValue = document.getElementById("settingGroup").value;

                if (filtered.length === 0) {
                    container.innerHTML = '<div class="custom-select-empty">未找到匹配的分组</div>';
                    return;
                }

                container.innerHTML = filtered.map(function(g) {
                    return '<div class="custom-select-option' + (g.value === currentValue ? ' selected' : '') + '" data-value="' + g.value + '">' +
                        '<span class="custom-select-option-name">' + g.label + '</span>' +
                        '<svg xmlns="http://www.w3.org/2000/svg" class="custom-select-option-check" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />' +
                        '</svg>' +
                        '</div>';
                }).join('');

                // 绑定点击事件
                container.querySelectorAll('.custom-select-option').forEach(function(opt) {
                    opt.addEventListener('click', function() {
                        selectGroup(this.dataset.value);
                    });
                });
            }

            function selectGroup(value) {
                var hiddenInput = document.getElementById("settingGroup");
                var valueDisplay = document.getElementById("groupValue");
                var selector = document.getElementById("groupSelector");
                var dropdown = document.getElementById("groupDropdown");

                if (hiddenInput) hiddenInput.value = value;
                if (valueDisplay) {
                    var opt = GROUP_OPTIONS.find(function(g) { return g.value === value; });
                    valueDisplay.textContent = opt ? opt.label : value;
                }

                // 更新选中状态
                document.querySelectorAll('#groupOptions .custom-select-option').forEach(function(opt) {
                    if (opt.dataset.value === value) {
                        opt.classList.add('selected');
                    } else {
                        opt.classList.remove('selected');
                    }
                });

                // 关闭下拉框
                if (selector) selector.classList.remove('open');
                if (dropdown) dropdown.classList.add('hidden');
            }

            function selectType(value) {
                var hiddenInput = document.getElementById("settingType");
                var valueDisplay = document.getElementById("typeValue");
                var selector = document.getElementById("typeSelector");
                var dropdown = document.getElementById("typeDropdown");

                if (hiddenInput) hiddenInput.value = value;
                if (valueDisplay) valueDisplay.textContent = TYPE_LABELS[value] || value;

                // 更新选中状态
                document.querySelectorAll('#typeOptions .custom-select-option').forEach(function(opt) {
                    if (opt.dataset.value === value) {
                        opt.classList.add('selected');
                    } else {
                        opt.classList.remove('selected');
                    }
                });

                // 关闭下拉框
                if (selector) selector.classList.remove('open');
                if (dropdown) dropdown.classList.add('hidden');

                // 触发类型变化
                updateValueInputMode(value);
                if (value === "boolean") {
                    var valueEl = document.getElementById("settingValue");
                    setBooleanSwitch(valueEl ? valueEl.value : "false");
                }
                refreshImagePickerUI();
            }

            // 初始化类型选择器
            var typeTrigger = document.getElementById("typeTrigger");
            var typeDropdown = document.getElementById("typeDropdown");
            var typeSelector = document.getElementById("typeSelector");

            if (typeTrigger) {
                typeTrigger.addEventListener("click", function(e) {
                    e.stopPropagation();
                    var isOpen = typeSelector.classList.contains("open");

                    // 关闭其他选择器
                    document.querySelectorAll('.custom-select').forEach(function(s) {
                        s.classList.remove('open');
                        s.querySelector('.custom-select-dropdown').classList.add('hidden');
                    });

                    if (!isOpen) {
                        typeSelector.classList.add("open");
                        typeDropdown.classList.remove("hidden");
                    }
                });
            }

            // 类型选项点击
            document.querySelectorAll('#typeOptions .custom-select-option').forEach(function(opt) {
                opt.addEventListener('click', function() {
                    selectType(this.dataset.value);
                });
            });

            // 初始化分组选择器
            var groupTrigger = document.getElementById("groupTrigger");
            var groupDropdown = document.getElementById("groupDropdown");
            var groupSelector = document.getElementById("groupSelector");
            var groupSearch = document.getElementById("groupSearch");

            if (groupTrigger) {
                groupTrigger.addEventListener("click", function(e) {
                    e.stopPropagation();
                    var isOpen = groupSelector.classList.contains("open");

                    // 关闭其他选择器
                    document.querySelectorAll('.custom-select').forEach(function(s) {
                        s.classList.remove('open');
                        s.querySelector('.custom-select-dropdown').classList.add('hidden');
                    });

                    if (!isOpen) {
                        groupSelector.classList.add("open");
                        groupDropdown.classList.remove("hidden");
                        renderGroupOptions('');
                        if (groupSearch) {
                            groupSearch.value = '';
                            groupSearch.focus();
                        }
                    }
                });
            }

            if (groupSearch) {
                groupSearch.addEventListener("input", function() {
                    renderGroupOptions(this.value);
                });
            }

            // 点击外部关闭下拉框
            document.addEventListener("click", function(e) {
                if (!e.target.closest('.custom-select')) {
                    document.querySelectorAll('.custom-select').forEach(function(s) {
                        s.classList.remove('open');
                        var dropdown = s.querySelector('.custom-select-dropdown');
                        if (dropdown) dropdown.classList.add('hidden');
                    });
                }
            });

            // ============== 原有逻辑 ==============

            // 开关点击事件
            var boolSwitch = document.getElementById("settingBooleanSwitch");
            if (boolSwitch) {
                boolSwitch.addEventListener("click", function() {
                    var isTrue = this.dataset.value === "true";
                    var newValue = !isTrue;
                    this.dataset.value = newValue ? "true" : "false";

                    if (newValue) {
                        this.classList.add("active");
                    } else {
                        this.classList.remove("active");
                    }

                    var labelEl = document.getElementById("settingBooleanLabel");
                    if (labelEl) labelEl.textContent = newValue ? "是" : "否";

                    // 同步到隐藏的 textarea
                    var valueEl = document.getElementById("settingValue");
                    if (valueEl) valueEl.value = newValue ? "true" : "false";
                });
            }

            var settingKeyInput = document.getElementById("settingKey");
            var settingLabelInput = document.getElementById("settingLabel");
            var settingValueInput = document.getElementById("settingValue");

            if (settingKeyInput) {
                settingKeyInput.addEventListener("input", function() {
                    currentSettingForPicker = null;
                    refreshImagePickerUI();
                });
            }

            if (settingLabelInput) {
                settingLabelInput.addEventListener("input", function() {
                    currentSettingForPicker = null;
                    refreshImagePickerUI();
                });
            }

            if (settingValueInput) {
                settingValueInput.addEventListener("input", function() {
                    var candidate = currentSettingForPicker || getFormSettingCandidate();
                    if (candidate && candidate.type === "string" && isImageSetting(candidate)) {
                        updateImagePreview(this.value);
                    }
                });
            }

            window.editSetting = function (id) {
                var setting = settings.find(function (s) {
                    return s.id === id;
                });
                if (!setting) return;

                var settingIdEl = document.getElementById("settingId");
                var settingKeyEl = document.getElementById("settingKey");
                var settingValueEl = document.getElementById("settingValue");
                var settingTypeEl = document.getElementById("settingType");
                var settingGroupEl = document.getElementById("settingGroup");
                var settingLabelEl = document.getElementById("settingLabel");
                var settingDescriptionEl =
                    document.getElementById("settingDescription");

                if (settingIdEl) settingIdEl.value = setting.id;
                if (settingKeyEl) settingKeyEl.value = setting.key;
                if (settingValueEl) settingValueEl.value = setting.value || "";
                if (settingTypeEl)
                    settingTypeEl.value = setting.type || "string";
                if (settingGroupEl)
                    settingGroupEl.value = setting.group || "general";
                if (settingLabelEl) settingLabelEl.value = setting.label || "";
                if (settingDescriptionEl)
                    settingDescriptionEl.value = setting.description || "";

                // 同步自定义选择器显示
                var typeValue = document.getElementById("typeValue");
                var groupValue = document.getElementById("groupValue");
                if (typeValue) typeValue.textContent = TYPE_LABELS[setting.type] || TYPE_LABELS["string"];
                if (groupValue) {
                    var groupOpt = GROUP_OPTIONS.find(function(g) { return g.value === setting.group; });
                    groupValue.textContent = groupOpt ? groupOpt.label : "基本信息";
                }

                // 更新类型选项选中状态
                document.querySelectorAll('#typeOptions .custom-select-option').forEach(function(opt) {
                    if (opt.dataset.value === (setting.type || "string")) {
                        opt.classList.add('selected');
                    } else {
                        opt.classList.remove('selected');
                    }
                });

                // 根据类型切换输入模式
                updateValueInputMode(setting.type || "string");
                if (setting.type === "boolean") {
                    setBooleanSwitch(setting.value);
                }

                currentSettingForPicker = {
                    key: setting.key || "",
                    label: setting.label || "",
                    type: setting.type || "string",
                };
                refreshImagePickerUI();
                showModal(true);
            };


            window.deleteSetting = async function (id, key) {
                var confirmMsg = (
                    t.confirmDelete || '确定要删除配置 "{key}" 吗？'
                ).replace("{key}", key);
                var confirmed = await window.showAdminConfirm(confirmMsg);
                if (!confirmed) return;

                try {
                    var result = await window.adminRequest(API_URL + "/settings/" + id, {
                        method: "DELETE",
                        headers: {
                            Authorization:
                                "Bearer " + localStorage.getItem("adminToken"),
                        },
                    });

                    if (result.ok) {
                        loadSettings();
                    } else {
                        window.showAdminAlert(result.msg || t.deleteFailed || "删除失败", "error");
                    }
                } catch (err) {
                    window.showAdminAlert(t.deleteFailed || "删除失败", "error");
                }
            };

            // 初始化默认配置
            var initSettingsBtn = document.getElementById("initSettingsBtn");
            if (initSettingsBtn) {
                initSettingsBtn.addEventListener("click", async function () {
                    var confirmed = await window.showAdminConfirm(
                        t.initSettingsConfirm ||
                            "确定要初始化默认配置吗？这不会覆盖已存在的配置项。",
                    );
                    if (!confirmed) return;

                    try {
                        var result = await window.adminRequest(API_URL + "/settings/init", {
                            method: "POST",
                            headers: {
                                Authorization:
                                    "Bearer " +
                                    localStorage.getItem("adminToken"),
                            },
                        });

                        if (result.ok) {
                            await window.showAdminAlert(result.msg || "初始化成功", "success");
                            loadSettings();
                        } else {
                            window.showAdminAlert(result.msg || t.saveFailed || "初始化失败", "error");
                        }
                    } catch (err) {
                        window.showAdminAlert(t.saveFailed || "初始化失败", "error");
                    }
                });
            }

            var addSettingBtn = document.getElementById("addSettingBtn");
            var cancelBtn = document.getElementById("cancelBtn");
            var settingModal = document.getElementById("settingModal");
            var settingForm = document.getElementById("settingForm");

            if (addSettingBtn)
                addSettingBtn.addEventListener("click", function () {
                    currentSettingForPicker = null;
                    showModal(false);
                });
            if (cancelBtn) cancelBtn.addEventListener("click", hideModal);
            if (settingModal) {
                settingModal.addEventListener("click", function (e) {
                    if (e.target === e.currentTarget) hideModal();
                });
            }

            if (settingForm) {
                settingForm.addEventListener("submit", async function (e) {
                    e.preventDefault();

                    var settingIdEl = document.getElementById("settingId");
                    var settingKeyEl = document.getElementById("settingKey");
                    var settingValueEl =
                        document.getElementById("settingValue");
                    var settingTypeEl = document.getElementById("settingType");
                    var settingGroupEl =
                        document.getElementById("settingGroup");
                    var settingLabelEl =
                        document.getElementById("settingLabel");
                    var settingDescriptionEl =
                        document.getElementById("settingDescription");

                    var id = settingIdEl ? settingIdEl.value : "";
                    var data = {
                        key: settingKeyEl ? settingKeyEl.value : "",
                        value: settingValueEl
                            ? settingValueEl.value || null
                            : null,
                        type: settingTypeEl
                            ? settingTypeEl.value || "string"
                            : "string",
                        group: settingGroupEl
                            ? settingGroupEl.value || "general"
                            : "general",
                        label: settingLabelEl
                            ? settingLabelEl.value || null
                            : null,
                        description: settingDescriptionEl
                            ? settingDescriptionEl.value || null
                            : null,
                    };

                    try {
                        var result = await window.adminRequest(
                            API_URL + "/settings/" + (id || ""),
                            {
                                method: id ? "PUT" : "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization:
                                        "Bearer " +
                                        localStorage.getItem("adminToken"),
                                },
                                body: JSON.stringify(data),
                            },
                        );

                        if (result.ok) {
                            hideModal();
                            loadSettings();
                        } else {
                            window.showAdminAlert(result.msg || t.saveFailed || "保存失败", "error");
                        }
                    } catch (err) {
                        window.showAdminAlert(t.saveFailed || "保存失败", "error");
                    }
                });
            }

            loadSettings();
        })();
    });
</script>

<style>
    .group-tab {
        white-space: nowrap;
    }
</style>
