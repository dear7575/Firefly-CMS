---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();

// 分组名称映射
const groupLabels: Record<string, string> = {
    security: "账户安全",
    basic: "基本信息",
    brand: "品牌设置",
    profile: "个人资料",
    theme: "主题设置",
    footer: "页脚设置",
    feature: "功能开关",
    post: "文章设置",
    api: "API设置",
    general: "通用设置",
    bangumi: "番组计划",
    banner: "横幅设置",
    page: "页面开关",
    wallpaper: "壁纸设置",
    waves: "波浪动画",
};

// 分组图标映射
const groupIcons: Record<string, string> = {
    security: "M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z",
    basic: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
    brand: "M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01",
    profile: "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z",
    theme: "M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01",
    footer: "M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z",
    feature: "M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z",
    post: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z",
    api: "M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4",
    general: "M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4",
    bangumi: "M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z",
    banner: "M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z",
    page: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z",
    wallpaper: "M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z",
    waves: "M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5",
};
---

<AdminLayout title={`${i18n(I18nKey.adminSystemManagement)} - ${siteConfig.title}`} activeMenu="settings">
    <div class="p-6 lg:p-8">
        <!-- 页面标题 -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100">{i18n(I18nKey.adminSystemManagement)}</h1>
                <p class="text-sm text-zinc-500 mt-1">{i18n(I18nKey.adminManageSiteSettings)}</p>
            </div>
            <div class="flex gap-3">
                <button
                    id="initSettingsBtn"
                    class="bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-700 dark:text-zinc-300 px-4 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 border border-zinc-200 dark:border-zinc-700"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    初始化默认配置
                </button>
                <button
                    id="addSettingBtn"
                    class="bg-[var(--primary)] dark:bg-zinc-800 hover:opacity-90 dark:hover:bg-zinc-700 text-white dark:text-zinc-100 px-6 py-2.5 rounded-xl font-medium transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    {i18n(I18nKey.adminAdd)} {i18n(I18nKey.adminSettings)}
                </button>
            </div>
        </div>

        <!-- 分组标签页 -->
        <div class="mb-6 overflow-x-auto">
            <div id="groupTabs" class="flex gap-2 min-w-max">
                <button data-group="all" class="group-tab active px-4 py-2 rounded-lg text-sm font-medium transition-all bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]">
                    {i18n(I18nKey.bangumiFilterAll)}
                </button>
            </div>
        </div>

        <!-- 设置列表 -->
        <div class="space-y-6" id="settingsContainer">
            <div class="text-center py-12 text-zinc-500">{i18n(I18nKey.adminLoading)}</div>
        </div>
    </div>

    <!-- 编辑弹窗 -->
    <div id="settingModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-zinc-200 dark:border-zinc-800 sticky top-0 bg-white dark:bg-zinc-900">
                <h2 id="modalTitle" class="text-xl font-bold text-zinc-900 dark:text-zinc-100">添加配置</h2>
            </div>
            <form id="settingForm" class="p-6 space-y-4">
                <input type="hidden" id="settingId" />
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">键名 *</label>
                    <input type="text" id="settingKey" required class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none" placeholder="例如: site_title" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">值</label>
                    <textarea id="settingValue" rows="3" class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none resize-none"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">类型</label>
                        <select id="settingType" class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none">
                            <option value="string">字符串</option>
                            <option value="text">长文本</option>
                            <option value="number">数字</option>
                            <option value="boolean">布尔值</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">分组</label>
                        <select id="settingGroup" class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none">
                            <option value="basic">基本信息</option>
                            <option value="brand">品牌设置</option>
                            <option value="profile">个人资料</option>
                            <option value="theme">主题设置</option>
                            <option value="footer">页脚设置</option>
                            <option value="feature">功能开关</option>
                            <option value="post">文章设置</option>
                            <option value="api">API设置</option>
                            <option value="general">通用设置</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">显示标签</label>
                    <input type="text" id="settingLabel" class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none" placeholder="用于后台显示的友好名称" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">描述</label>
                    <input type="text" id="settingDescription" class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none" placeholder="配置项的说明文字" />
                </div>
            </form>
            <div class="p-6 border-t border-zinc-200 dark:border-zinc-800 flex justify-end gap-3 sticky bottom-0 bg-white dark:bg-zinc-900">
                <button type="button" id="cancelBtn" class="px-4 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors">{i18n(I18nKey.adminCancel)}</button>
                <button type="submit" form="settingForm" class="px-6 py-2 bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 rounded-lg hover:opacity-90 dark:hover:bg-zinc-700 transition-colors dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]">{i18n(I18nKey.adminSave)}</button>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline define:vars={{ groupLabels, groupIcons }}>
(function() {
    var settings = [];
    var currentGroup = 'all';

    // 分组名称和图标
    var GROUP_LABELS = groupLabels;
    var GROUP_ICONS = groupIcons;

    // i18n 文案
    var t = window.adminI18n || {};

    async function loadSettings() {
        var container = document.getElementById('settingsContainer');
        if (!container) return;

        try {
            var response = await fetch(`${API_URL}/settings`);
            if (!response.ok) throw new Error('Failed to load');
            settings = await response.json();

            renderGroupTabs();
            renderSettings();
        } catch (err) {
            console.error(err);
            if (container) container.innerHTML = '<div class="text-center py-12 text-red-500">' + (t.loadFailed || '加载失败') + '</div>';
        }
    }

    function renderGroupTabs() {
        var tabsContainer = document.getElementById('groupTabs');
        if (!tabsContainer) return;

        // 获取所有分组，始终包含 security
        var groups = ['all', 'security'];
        settings.forEach(function(s) {
            if (s.group && groups.indexOf(s.group) === -1) {
                groups.push(s.group);
            }
        });

        // 按预定义顺序排序
        var order = ['all', 'security', 'basic', 'brand', 'profile', 'theme', 'footer', 'feature', 'post', 'api', 'general'];
        groups.sort(function(a, b) {
            var ia = order.indexOf(a);
            var ib = order.indexOf(b);
            if (ia === -1) ia = 999;
            if (ib === -1) ib = 999;
            return ia - ib;
        });

        tabsContainer.innerHTML = groups.map(function(group) {
            var label = group === 'all' ? (t.all || '全部') : (GROUP_LABELS[group] || group);
            var isActive = currentGroup === group;
            var activeClass = isActive ? 'bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]' : 'bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-700';
            return '<button data-group="' + group + '" class="group-tab px-4 py-2 rounded-lg text-sm font-medium transition-all ' + activeClass + '">' + label + '</button>';
        }).join('');

        // 绑定点击事件
        tabsContainer.querySelectorAll('.group-tab').forEach(function(btn) {
            btn.addEventListener('click', function() {
                currentGroup = btn.dataset.group;
                renderGroupTabs();
                renderSettings();
            });
        });
    }

    function renderSettings() {
        var container = document.getElementById('settingsContainer');
        if (!container) return;

        // 如果是账户安全标签页，显示修改密码表单
        if (currentGroup === 'security') {
            container.innerHTML = '<div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden">' +
                '<div class="p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50 flex items-center gap-3">' +
                    '<div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/40 flex items-center justify-center">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>' +
                        '</svg>' +
                    '</div>' +
                    '<div>' +
                        '<h2 class="font-bold text-zinc-900 dark:text-zinc-100">账户安全</h2>' +
                        '<p class="text-xs text-zinc-500">管理您的登录密码和安全设置</p>' +
                    '</div>' +
                '</div>' +
                '<div class="p-6">' +
                    '<form id="changePasswordForm" class="space-y-4">' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">当前密码 *</label>' +
                            '<input type="password" id="currentPassword" required class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none" placeholder="请输入当前密码" />' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">新密码 *</label>' +
                            '<input type="password" id="newPassword" required class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none" placeholder="请输入新密码（至少6位）" />' +
                        '</div>' +
                        '<div>' +
                            '<label class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">确认新密码 *</label>' +
                            '<input type="password" id="confirmPassword" required class="w-full px-4 py-2.5 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800 focus:ring-2 focus:ring-[var(--primary)] outline-none" placeholder="请再次输入新密码" />' +
                        '</div>' +
                        '<div class="flex justify-end">' +
                            '<button type="submit" class="px-6 py-2.5 bg-[var(--primary)] dark:bg-zinc-800 text-white dark:text-zinc-100 rounded-xl hover:opacity-90 dark:hover:bg-zinc-700 transition-all font-medium shadow-lg hover:shadow-xl active:scale-95 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]">' +
                                '修改密码' +
                            '</button>' +
                        '</div>' +
                    '</form>' +
                '</div>' +
            '</div>';
            
            // 重新绑定表单事件
            bindPasswordForm();
            return;
        }

        // 过滤设置
        var filtered = currentGroup === 'all' ? settings : settings.filter(function(s) {
            return s.group === currentGroup;
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div class="text-center py-12 text-zinc-500">' + (t.contentEmpty || '暂无配置项') + '</div>';
            return;
        }

        // 按分组组织
        var grouped = {};
        filtered.forEach(function(setting) {
            var group = setting.group || 'general';
            if (!grouped[group]) grouped[group] = [];
            grouped[group].push(setting);
        });

        // 渲染分组
        container.innerHTML = Object.keys(grouped).map(function(group) {
            var items = grouped[group].sort(function(a, b) { return b.sort_order - a.sort_order; });
            var groupLabel = GROUP_LABELS[group] || group;
            var groupIcon = GROUP_ICONS[group] || GROUP_ICONS.general;

            var itemsHtml = items.map(function(setting) {
                var valueDisplay = setting.value || '<span class="text-zinc-400">(' + (t.contentEmpty || '空') + ')</span>';
                if (setting.type === 'boolean') {
                    var isTrue = setting.value && setting.value.toLowerCase() === 'true';
                    valueDisplay = '<span class="px-2 py-0.5 rounded text-xs ' + (isTrue ? 'bg-green-100 dark:bg-green-900/30 text-green-600' : 'bg-zinc-100 dark:bg-zinc-800 text-zinc-500') + '">' + (isTrue ? (t.active || '是') : (t.disabled || '否')) + '</span>';
                } else if (setting.value && setting.value.length > 50) {
                    valueDisplay = setting.value.substring(0, 50) + '...';
                }

                return '<div class="p-4 hover:bg-zinc-50 dark:hover:bg-zinc-800/30 transition-colors border-b border-zinc-100 dark:border-zinc-800 last:border-b-0">' +
                    '<div class="flex items-start justify-between gap-4">' +
                        '<div class="flex-1 min-w-0">' +
                            '<div class="flex items-center gap-2 mb-1">' +
                                '<h3 class="font-medium text-zinc-900 dark:text-zinc-100">' + (setting.label || setting.key) + '</h3>' +
                                '<span class="px-2 py-0.5 text-[10px] rounded-full bg-zinc-100 dark:bg-zinc-800 text-zinc-500">' + setting.type + '</span>' +
                            '</div>' +
                            '<p class="text-xs text-zinc-400 mb-2 font-mono">' + setting.key + '</p>' +
                            (setting.description ? '<p class="text-xs text-zinc-500 mb-2">' + setting.description + '</p>' : '') +
                            '<div class="text-sm text-zinc-700 dark:text-zinc-300 bg-zinc-50 dark:bg-zinc-800/50 px-3 py-2 rounded-lg font-mono break-all">' + valueDisplay + '</div>' +
                        '</div>' +
                        '<div class="flex gap-1">' +
                            '<button onclick="editSetting(\'' + setting.id + '\')" class="p-2 text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors" title="编辑">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>' +
                            '</button>' +
                            '<button onclick="deleteSetting(\'' + setting.id + '\', \'' + setting.key.replace(/'/g, "\\'") + '\')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors" title="删除">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');

            return '<div class="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden">' +
                '<div class="p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50 flex items-center gap-3">' +
                    '<div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/40 flex items-center justify-center">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + groupIcon + '" /></svg>' +
                    '</div>' +
                    '<div>' +
                        '<h2 class="font-bold text-zinc-900 dark:text-zinc-100">' + groupLabel + '</h2>' +
                        '<p class="text-xs text-zinc-500">' + items.length + ' 项配置</p>' +
                    '</div>' +
                '</div>' +
                '<div>' + itemsHtml + '</div>' +
            '</div>';
        }).join('');
    }

    function showModal(isEdit) {
        var modalTitle = document.getElementById('modalTitle');
        var settingModal = document.getElementById('settingModal');
        var settingKey = document.getElementById('settingKey');
        if (modalTitle) modalTitle.textContent = isEdit ? (t.edit || '编辑') + ' ' + (t.adminSystemManagement || '配置') : (t.add || '添加') + ' ' + (t.adminSystemManagement || '配置');
        if (settingKey) settingKey.disabled = isEdit; // 编辑时禁止修改键名
        if (settingModal) {
            settingModal.classList.remove('hidden');
            settingModal.classList.add('flex');
        }
    }

    function hideModal() {
        var settingModal = document.getElementById('settingModal');
        var settingForm = document.getElementById('settingForm');
        var settingId = document.getElementById('settingId');
        var settingKey = document.getElementById('settingKey');
        if (settingModal) {
            settingModal.classList.add('hidden');
            settingModal.classList.remove('flex');
        }
        if (settingForm) settingForm.reset();
        if (settingId) settingId.value = '';
        if (settingKey) settingKey.disabled = false;
    }

    window.editSetting = function(id) {
        var setting = settings.find(function(s) { return s.id === id; });
        if (!setting) return;

        var settingIdEl = document.getElementById('settingId');
        var settingKeyEl = document.getElementById('settingKey');
        var settingValueEl = document.getElementById('settingValue');
        var settingTypeEl = document.getElementById('settingType');
        var settingGroupEl = document.getElementById('settingGroup');
        var settingLabelEl = document.getElementById('settingLabel');
        var settingDescriptionEl = document.getElementById('settingDescription');

        if (settingIdEl) settingIdEl.value = setting.id;
        if (settingKeyEl) settingKeyEl.value = setting.key;
        if (settingValueEl) settingValueEl.value = setting.value || '';
        if (settingTypeEl) settingTypeEl.value = setting.type || 'string';
        if (settingGroupEl) settingGroupEl.value = setting.group || 'general';
        if (settingLabelEl) settingLabelEl.value = setting.label || '';
        if (settingDescriptionEl) settingDescriptionEl.value = setting.description || '';

        showModal(true);
    };

    window.deleteSetting = async function(id, key) {
        if (!confirm((t.confirmDelete || '确定要删除配置 "{key}" 吗？').replace('{key}', key))) return;

        try {
            var response = await fetch(API_URL + '/settings/' + id, {
                method: 'DELETE',
                headers: { Authorization: 'Bearer ' + localStorage.getItem('adminToken') }
            });

            if (response.ok) {
                loadSettings();
            } else {
                var err = await response.json();
                alert(err.detail || (t.deleteFailed || '删除失败'));
            }
        } catch (err) {
            alert(t.deleteFailed || '删除失败');
        }
    };

    // 初始化默认配置
    var initSettingsBtn = document.getElementById('initSettingsBtn');
    if (initSettingsBtn) {
        initSettingsBtn.addEventListener('click', async function() {
            if (!confirm((t.confirmDelete || '确定要初始化默认配置吗？这不会覆盖已存在的配置项。'))) return;

            try {
                var response = await fetch(API_URL + '/settings/init', {
                    method: 'POST',
                    headers: { Authorization: 'Bearer ' + localStorage.getItem('adminToken') }
                });

                if (response.ok) {
                    var result = await response.json();
                    alert(result.message);
                    loadSettings();
                } else {
                    var err = await response.json();
                    alert(err.detail || (t.saveFailed || '初始化失败'));
                }
            } catch (err) {
                alert(t.saveFailed || '初始化失败');
            }
        });
    }

    var addSettingBtn = document.getElementById('addSettingBtn');
    var cancelBtn = document.getElementById('cancelBtn');
    var settingModal = document.getElementById('settingModal');
    var settingForm = document.getElementById('settingForm');

    if (addSettingBtn) addSettingBtn.addEventListener('click', function() { showModal(false); });
    if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
    if (settingModal) {
        settingModal.addEventListener('click', function(e) {
            if (e.target === e.currentTarget) hideModal();
        });
    }

    if (settingForm) {
        settingForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            var settingIdEl = document.getElementById('settingId');
            var settingKeyEl = document.getElementById('settingKey');
            var settingValueEl = document.getElementById('settingValue');
            var settingTypeEl = document.getElementById('settingType');
            var settingGroupEl = document.getElementById('settingGroup');
            var settingLabelEl = document.getElementById('settingLabel');
            var settingDescriptionEl = document.getElementById('settingDescription');

            var id = settingIdEl ? settingIdEl.value : '';
            var data = {
                key: settingKeyEl ? settingKeyEl.value : '',
                value: settingValueEl ? settingValueEl.value || null : null,
                type: settingTypeEl ? settingTypeEl.value || 'string' : 'string',
                group: settingGroupEl ? settingGroupEl.value || 'general' : 'general',
                label: settingLabelEl ? settingLabelEl.value || null : null,
                description: settingDescriptionEl ? settingDescriptionEl.value || null : null
            };

            try {
                var response = await fetch(API_URL + '/settings/' + (id || ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    hideModal();
                    loadSettings();
                } else {
                    var err = await response.json();
                    alert(err.detail || (t.saveFailed || '保存失败'));
                }
            } catch (err) {
                alert(t.saveFailed || '保存失败');
            }
        });
    }

    loadSettings();

    // 修改密码功能绑定函数
    function bindPasswordForm() {
        var changePasswordForm = document.getElementById('changePasswordForm');
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                var currentPassword = document.getElementById('currentPassword');
                var newPassword = document.getElementById('newPassword');
                var confirmPassword = document.getElementById('confirmPassword');

                if (!currentPassword || !newPassword || !confirmPassword) return;

                // 前端验证
                if (newPassword.value.length < 6) {
                    window.adminAlert('新密码长度至少6位', 'warning', '验证失败');
                    return;
                }

                if (newPassword.value !== confirmPassword.value) {
                    window.adminAlert('两次输入的新密码不一致', 'warning', '验证失败');
                    return;
                }

                try {
                    var response = await fetch(API_URL + '/auth/change-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: 'Bearer ' + localStorage.getItem('adminToken')
                        },
                        body: JSON.stringify({
                            old_password: currentPassword.value,
                            new_password: newPassword.value
                        })
                    });

                    if (response.ok) {
                        await window.adminAlert('密码修改成功！即将跳转到登录页面', 'success', '修改成功');
                        localStorage.removeItem('adminToken');
                        window.location.href = '/admin/login';
                    } else {
                        var err = await response.json();
                        window.adminAlert(err.detail || '密码修改失败，请检查当前密码是否正确', 'error', '修改失败');
                    }
                } catch (err) {
                    console.error(err);
                    window.adminAlert('网络错误，请稍后重试', 'error', '修改失败');
                }
            });
        }
    }
})();
</script>

<style>
    .group-tab {
        white-space: nowrap;
    }
</style>
