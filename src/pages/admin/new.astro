---
export const prerender = false;
import AdminLayout from "../../layouts/AdminLayout.astro";
import {siteConfig} from "../../config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import { getApiUrl } from "@/utils/api-utils";
const API_URL = getApiUrl();

const isEdit = false;

// i18n translations for inline script
const editorI18n = {
    requiredFields: i18n(I18nKey.adminRequiredFields),
    contentEmpty: i18n(I18nKey.adminContentEmpty),
    saveFailed: i18n(I18nKey.adminSaveFailed),
    publishing: i18n(I18nKey.adminPostPublishing),
    publish: i18n(I18nKey.adminPostPublish),
};
---

<AdminLayout title={`${i18n(I18nKey.adminNewPost)} - ${siteConfig.title}`}>
    <div class="h-[calc(100vh-64px)] overflow-hidden flex flex-col">
        <!-- Header -->
        <div
                class="px-8 py-4 bg-white dark:bg-zinc-900 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between shadow-sm z-10"
        >
            <div class="flex items-center gap-4">
                <a
                        href="/admin"
                        class="p-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors text-zinc-500"
                >
                    <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                    >
                        <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-xl font-bold text-zinc-900 dark:text-zinc-100">
                    {i18n(I18nKey.adminNewPost)}
                </h1>
            </div>
            <div class="flex items-center gap-3">
                <button
                        id="saveBtn"
                        class="bg-[var(--primary)] dark:bg-zinc-800 hover:opacity-90 dark:hover:bg-zinc-700 text-white dark:text-zinc-100 px-6 py-2 rounded-xl font-bold transition-all shadow-md hover:shadow-lg active:scale-95 dark:border dark:border-indigo-500/50 dark:shadow-[0_0_15px_rgba(99,102,241,0.3)]"
                        data-publish-text={i18n(I18nKey.adminPostPublish)}
                        data-publishing-text={i18n(I18nKey.adminPostPublishing)}
                >
                    {i18n(I18nKey.adminPostPublish)}
                </button>
            </div>
        </div>

        <div class="flex-1 flex overflow-hidden">
            <!-- Left Side: Editor -->
            <div
                    class="flex-1 flex flex-col p-8 overflow-y-auto custom-scrollbar bg-white dark:bg-zinc-900 border-r border-zinc-200 dark:border-zinc-800"
            >
                <input
                        type="text"
                        id="title"
                        placeholder={i18n(I18nKey.adminPostTitlePlaceholder)}
                        class="text-4xl font-bold bg-transparent border-none outline-none mb-6 placeholder:text-zinc-300 dark:placeholder:text-zinc-700 text-zinc-900 dark:text-zinc-100"
                />
                <div id="vditor" class="flex-1 border-none shadow-none"></div>
            </div>

            <!-- Right Side: Settings -->
            <div
                    class="w-80 bg-zinc-50/50 dark:bg-zinc-950/50 p-6 overflow-y-auto custom-scrollbar backdrop-blur-sm"
            >
                <div class="space-y-8">
                    <!-- Basic Info Section -->
                    <section>
                        <h3
                                class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-4 flex items-center gap-2"
                        >
                            <svg
                                    class="w-1 h-1 rounded-full bg-zinc-400"
                                    fill="currentColor"
                                    viewBox="0 0 4 4"
                            >
                                <circle cx="2" cy="2" r="2"></circle>
                            </svg
                            >
                            {i18n(I18nKey.adminSectionBasicInfo)}
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label
                                        class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                >{i18n(I18nKey.adminPostSlug)}</label
                                >
                                <input
                                        id="slug"
                                        type="text"
                                        placeholder={i18n(I18nKey.adminPostSlugPlaceholder)}
                                        class="admin-input"
                                />
                            </div>
                            <div>
                                <label
                                        class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                >{i18n(I18nKey.adminPostCategoryLabel)}</label
                                >
                                <!-- 自定义分类选择器 -->
                                <div class="category-selector" id="categorySelector">
                                    <div class="category-selector-trigger" id="categorySelectorTrigger">
                                        <span class="category-selector-value" id="categoryValue">{i18n(I18nKey.adminPostCategoryPlaceholder)}</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-zinc-400 transition-transform" id="categoryArrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                    <div class="category-selector-dropdown hidden" id="categoryDropdown">
                                        <div class="category-search-wrapper">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                            </svg>
                                            <input type="text" class="category-search-input" id="categorySearch" placeholder="搜索分类..." />
                                        </div>
                                        <div class="category-options" id="categoryOptions">
                                            <!-- 分类选项会通过 JS 动态填充 -->
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="category" value="" />
                            </div>
                            <div>
                                <label
                                        class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                >{i18n(I18nKey.adminPostTags)}</label
                                >
                                <div id="tagsContainer" class="tags-selector">
                                    <span class="text-sm text-zinc-400 italic">{i18n(I18nKey.adminLoading)}</span>
                                </div>
                                <p class="text-xs text-zinc-400 mt-2">{i18n(I18nKey.adminPostTagsHint)}</p>
                                <input type="hidden" id="selectedTags" value="" />
                            </div>
                        </div>
                    </section>

                    <!-- Media Section -->
                    <section>
                        <h3
                                class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-4 flex items-center gap-2"
                        >
                            <svg
                                    class="w-1 h-1 rounded-full bg-zinc-400"
                                    fill="currentColor"
                                    viewBox="0 0 4 4"
                            >
                                <circle cx="2" cy="2" r="2"></circle>
                            </svg
                            >
                            {i18n(I18nKey.adminSectionAppearance)}
                        </h3>
                        <div>
                            <label
                                    class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                            >{i18n(I18nKey.adminPostImage)}</label
                            >
                            <input
                                    id="image"
                                    type="text"
                                    placeholder={i18n(I18nKey.adminPostImagePlaceholder)}
                                    class="admin-input"
                            />
                            <div
                                    id="imagePreview"
                                    class="mt-2 w-full aspect-video rounded-lg overflow-hidden border border-zinc-200 dark:border-zinc-800 bg-zinc-100 dark:bg-zinc-900 hidden"
                            >
                                <img
                                        src=""
                                        alt="Preview"
                                        class="w-full h-full object-cover"
                                />
                            </div>
                        </div>
                    </section>

                    <!-- Advanced Section -->
                    <section>
                        <h3
                                class="text-xs font-bold uppercase tracking-widest text-zinc-400 mb-4 flex items-center gap-2"
                        >
                            <svg
                                    class="w-1 h-1 rounded-full bg-zinc-400"
                                    fill="currentColor"
                                    viewBox="0 0 4 4"
                            >
                                <circle cx="2" cy="2" r="2"></circle>
                            </svg
                            >
                            {i18n(I18nKey.adminSectionAdvanced)}
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label
                                        class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                >{i18n(I18nKey.adminPostPassword)}</label
                                >
                                <input
                                        id="password"
                                        type="password"
                                        placeholder={i18n(I18nKey.adminPostPasswordPlaceholder)}
                                        class="admin-input"
                                />
                            </div>
                            <!-- 置顶开关 -->
                            <div
                                    class="flex items-center gap-3 cursor-pointer group"
                                    id="pinnedToggle"
                            >
                                <div
                                        class="w-10 h-6 bg-zinc-200 dark:bg-zinc-800 rounded-full relative transition-colors duration-300"
                                        id="pinnedToggleTrack"
                                >
                                    <div
                                            class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 shadow-sm"
                                            id="pinnedToggleHandle"
                                    >
                                    </div>
                                </div>
                                <span
                                        class="text-sm font-medium text-zinc-600 dark:text-zinc-400 group-hover:text-zinc-900 dark:group-hover:text-zinc-100 transition-colors"
                                >{i18n(I18nKey.pinned)}</span
                                >
                            </div>
                            <!-- 置顶排序 -->
                            <div id="pinOrderContainer" class="hidden">
                                <label
                                    class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                                    >{i18n(I18nKey.adminPostPinOrder)}</label
                                >
                                <input
                                    id="pinOrder"
                                    type="number"
                                    min="0"
                                    value="0"
                                    placeholder={i18n(I18nKey.adminPostPinOrderPlaceholder)}
                                    class="admin-input"
                                />
                            </div>
                            <!-- 草稿开关 -->
                            <div
                                    class="flex items-center gap-3 cursor-pointer group"
                                    id="draftToggle"
                            >
                                <div
                                        class="w-10 h-6 bg-zinc-200 dark:bg-zinc-800 rounded-full relative transition-colors duration-300"
                                        id="toggleTrack"
                                >
                                    <div
                                            class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 shadow-sm"
                                            id="toggleHandle"
                                    >
                                    </div>
                                </div>
                                <span
                                        class="text-sm font-medium text-zinc-600 dark:text-zinc-400 group-hover:text-zinc-900 dark:group-hover:text-zinc-100 transition-colors"
                                >{i18n(I18nKey.adminPostDraftToggle)}</span
                                >
                            </div>
                        </div>
                    </section>

                    <section class="mb-4">
                        <label
                                class="block text-xs font-bold text-zinc-500 mb-2 uppercase tracking-tight"
                        >{i18n(I18nKey.adminPostDescription)}</label
                        >
                        <textarea
                                id="description"
                                rows="3"
                                placeholder={i18n(I18nKey.adminPostDescriptionPlaceholder)}
                                class="admin-input resize-none"></textarea>
                    </section>
                </div>
            </div>
        </div>
    </div>
</AdminLayout>

<script is:inline define:vars={{ editorI18n }}>
    window.editorI18n = editorI18n;
</script>

<script is:inline src="/assets/vendor/vditor/index.min.js"></script>

<script is:inline>
// 使用 astro:page-load 事件确保每次导航都能初始化
document.addEventListener('astro:page-load', function() {
    // 检查是否在新建文章页面
    if (!window.location.pathname.includes('/admin/new')) {
        return;
    }

    // 清理之前的实例
    if (window._newPageVditor) {
        try {
            window._newPageVditor.destroy();
        } catch (e) {}
        window._newPageVditor = null;
    }
    window._newPageVditorInitialized = false;

    // 开始初始化
    initNewPage();
});

function initNewPage() {
    // 防止重复初始化
    if (window._newPageVditorInitialized) {
        console.log("New page Vditor already initialized, skipping...");
        return;
    }
    window._newPageVditorInitialized = true;

    // Get i18n translations
    const t = window.editorI18n || {};
    const API_URL = window.API_URL;

    let vditor = null;
    let isDraft = false;
    let isPinned = false;
    let initTimer = null; // 跟踪初始化定时器
    let selectedTagIds = []; // 存储选中的标签ID
    let allTags = []; // 存储所有标签数据
    let allCategories = []; // 存储所有分类数据
    let selectedCategory = ''; // 当前选中的分类

    // 加载分类列表
    async function loadCategories() {
        const categoryOptions = document.getElementById('categoryOptions');
        if (!categoryOptions) return;

        try {
            const result = await window.adminRequest(API_URL + '/categories');
            if (result.ok) {
                allCategories = (result.data || []).filter(c => c.enabled);
                renderCategoryOptions();
                initCategorySelector();
            }
        } catch (err) {
            console.error('加载分类失败:', err);
            categoryOptions.innerHTML = '<div class="category-empty">加载分类失败</div>';
        }
    }

    // 渲染分类选项
    function renderCategoryOptions(filter = '') {
        const categoryOptions = document.getElementById('categoryOptions');
        if (!categoryOptions) return;

        const filtered = filter
            ? allCategories.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()))
            : allCategories;

        if (filtered.length === 0) {
            categoryOptions.innerHTML = '<div class="category-empty">' + (filter ? '未找到匹配的分类' : '暂无可用分类') + '</div>';
            return;
        }

        categoryOptions.innerHTML = filtered.map(function(cat) {
            const isSelected = selectedCategory === cat.name;
            const color = cat.color || '#6366f1';
            return '<div class="category-option' + (isSelected ? ' selected' : '') + '" data-value="' + cat.name + '">' +
                '<div class="category-option-color" style="background-color: ' + color + '"></div>' +
                '<span class="category-option-name">' + cat.name + '</span>' +
                '<svg class="category-option-check" fill="none" viewBox="0 0 24 24" stroke="currentColor">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />' +
                '</svg>' +
            '</div>';
        }).join('');

        // 绑定点击事件
        categoryOptions.querySelectorAll('.category-option').forEach(function(option) {
            option.addEventListener('click', function() {
                selectCategory(option.dataset.value);
            });
        });
    }

    // 选择分类
    function selectCategory(value) {
        selectedCategory = value;
        const categoryInput = document.getElementById('category');
        const categoryValue = document.getElementById('categoryValue');

        if (categoryInput) categoryInput.value = value;
        if (categoryValue) {
            categoryValue.textContent = value || '默认分类';
            categoryValue.classList.toggle('placeholder', !value);
        }

        renderCategoryOptions();
        closeCategoryDropdown();
    }

    // 初始化分类选择器交互
    function initCategorySelector() {
        const selector = document.getElementById('categorySelector');
        const trigger = document.getElementById('categorySelectorTrigger');
        const dropdown = document.getElementById('categoryDropdown');
        const searchInput = document.getElementById('categorySearch');

        if (!selector || !trigger || !dropdown) return;

        // 点击触发器切换下拉
        trigger.addEventListener('click', function(e) {
            e.stopPropagation();
            if (selector.classList.contains('open')) {
                closeCategoryDropdown();
            } else {
                openCategoryDropdown();
            }
        });

        // 搜索过滤
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                renderCategoryOptions(searchInput.value);
            });
        }

        // 点击外部关闭
        document.addEventListener('click', function(e) {
            if (!selector.contains(e.target)) {
                closeCategoryDropdown();
            }
        });
    }

    function openCategoryDropdown() {
        const selector = document.getElementById('categorySelector');
        const dropdown = document.getElementById('categoryDropdown');
        const searchInput = document.getElementById('categorySearch');

        if (selector) selector.classList.add('open');
        if (dropdown) dropdown.classList.remove('hidden');
        if (searchInput) {
            searchInput.value = '';
            searchInput.focus();
        }
        renderCategoryOptions();
    }

    function closeCategoryDropdown() {
        const selector = document.getElementById('categorySelector');
        const dropdown = document.getElementById('categoryDropdown');

        if (selector) selector.classList.remove('open');
        if (dropdown) dropdown.classList.add('hidden');
    }

    // 加载标签列表
    async function loadTags() {
        const tagsContainer = document.getElementById('tagsContainer');
        if (!tagsContainer) return;

        try {
            const result = await window.adminRequest(API_URL + '/tags');
            if (result.ok) {
                allTags = result.data || [];
                renderTags();
            } else {
                tagsContainer.innerHTML = '<span class="text-sm text-red-500">加载标签失败</span>';
            }
        } catch (err) {
            console.error('加载标签失败:', err);
            tagsContainer.innerHTML = '<span class="text-sm text-red-500">加载标签失败</span>';
        }
    }

    // 渲染标签选择器
    function renderTags() {
        const tagsContainer = document.getElementById('tagsContainer');
        if (!tagsContainer || !allTags.length) {
            if (tagsContainer) {
                tagsContainer.innerHTML = '<span class="text-sm text-zinc-400">暂无可用标签</span>';
            }
            return;
        }

        tagsContainer.innerHTML = allTags.filter(function(tag) {
            return tag.enabled;
        }).map(function(tag) {
            const isSelected = selectedTagIds.indexOf(tag.id) !== -1;
            const bgColor = isSelected ? (tag.color || '#6366f1') : 'transparent';
            const textColor = isSelected ? '#fff' : (tag.color || '#71717a');
            const borderColor = tag.color || '#d4d4d8';

            return '<button type="button" ' +
                'class="tag-btn px-3 py-1.5 text-xs font-medium rounded-full border transition-all hover:opacity-80" ' +
                'data-tag-id="' + tag.id + '" ' +
                'data-tag-name="' + tag.name + '" ' +
                'data-tag-color="' + (tag.color || '#6366f1') + '" ' +
                'style="background-color: ' + bgColor + '; color: ' + textColor + '; border-color: ' + borderColor + ';">' +
                tag.name +
            '</button>';
        }).join('');

        // 绑定点击事件
        tagsContainer.querySelectorAll('.tag-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const tagId = this.getAttribute('data-tag-id');
                const tagColor = this.getAttribute('data-tag-color');
                const idx = selectedTagIds.indexOf(tagId);

                if (idx === -1) {
                    // 选中
                    selectedTagIds.push(tagId);
                    this.style.backgroundColor = tagColor;
                    this.style.color = '#fff';
                } else {
                    // 取消选中
                    selectedTagIds.splice(idx, 1);
                    this.style.backgroundColor = 'transparent';
                    this.style.color = tagColor;
                }

                // 更新隐藏字段
                updateSelectedTagsInput();
            });
        });
    }

    // 更新隐藏的标签输入字段
    function updateSelectedTagsInput() {
        const input = document.getElementById('selectedTags');
        if (input) {
            // 获取选中标签的名称
            const selectedNames = selectedTagIds.map(function(id) {
                const tag = allTags.find(function(t) { return t.id === id; });
                return tag ? tag.name : '';
            }).filter(function(name) { return name; });
            input.value = selectedNames.join(',');
        }
    }

    // 检查 Vditor 是否可用
    function initVditor() {
        // 清除之前的定时器
        if (initTimer) {
            clearTimeout(initTimer);
            initTimer = null;
        }

        // 检查页面是否还在
        if (!window._newPageVditorInitialized) {
            console.log("Page changed, stopping Vditor init");
            return;
        }

        if (typeof Vditor === "undefined") {
            console.log("Vditor not loaded, retrying...");
            initTimer = setTimeout(initVditor, 300);
            window._newPageInitTimer = initTimer; // 保存到全局以便清理
            return;
        }

        const container = document.getElementById("vditor");
        if (!container) {
            console.log("Vditor container not found");
            return;
        }

        // 检测当前主题
        const isDark = document.documentElement.classList.contains("dark");

        // Initialize Vditor - 使用 IR 模式（即时渲染）
        // cdn 设置为本地路径，避免从网络加载
        vditor = new Vditor("vditor", {
            height: "100%",
            mode: "ir",
            placeholder: "Write your story here...",
            cdn: "/assets/vendor/vditor",
            cache: {
                enable: false,
            },
            theme: isDark ? "dark" : "classic",
            preview: {
                theme: {
                    current: isDark ? "dark" : "light",
                },
            },
            toolbarConfig: {
                pin: true,
            },
            counter: {
                enable: true,
            },
            after: function() {
                console.log("Vditor initialized successfully");
                // 强制设置 IR 模式内容区域样式
                var resetEl = document.querySelector('#vditor .vditor-ir .vditor-reset');
                if (resetEl) {
                    resetEl.style.color = isDark ? '#f4f4f5' : '#18181b';
                    resetEl.style.caretColor = isDark ? '#f4f4f5' : '#18181b';
                }
            },
        });

        // 保存到全局以便清理
        window._newPageVditor = vditor;
    }

    // Handle Title -> Slug generation
    document.getElementById("title")?.addEventListener("input", function(e) {
        const title = e.target.value;
        const slugInput = document.getElementById("slug");
        if (slugInput && !slugInput.dataset.manual) {
            slugInput.value = title
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "-")
                .replace(/(^-|-$)/g, "");
        }
    });

    document.getElementById("slug")?.addEventListener("input", function() {
        const slugEl = document.getElementById("slug");
        if (slugEl) slugEl.dataset.manual = "true";
    });

    // Handle Image Preview
    document.getElementById("image")?.addEventListener("input", function(e) {
        const url = e.target.value;
        const preview = document.getElementById("imagePreview");
        const img = preview?.querySelector("img");
        if (url && preview && img) {
            img.src = url;
            preview.classList.remove("hidden");
        } else if (preview) {
            preview.classList.add("hidden");
        }
    });

    // Handle Draft Toggle
    document.getElementById("draftToggle")?.addEventListener("click", function() {
        isDraft = !isDraft;
        const track = document.getElementById("toggleTrack");
        const handle = document.getElementById("toggleHandle");
        if (isDraft) {
            track?.classList.add("bg-green-500");
            track?.classList.remove("bg-zinc-200", "dark:bg-zinc-800");
            handle?.classList.add("translate-x-4");
        } else {
            track?.classList.remove("bg-green-500");
            track?.classList.add("bg-zinc-200", "dark:bg-zinc-800");
            handle?.classList.remove("translate-x-4");
        }
    });

    // Handle Pinned Toggle
    document.getElementById("pinnedToggle")?.addEventListener("click", function() {
        isPinned = !isPinned;
        const track = document.getElementById("pinnedToggleTrack");
        const handle = document.getElementById("pinnedToggleHandle");
        const pinOrderContainer = document.getElementById("pinOrderContainer");
        if (isPinned) {
            track?.classList.add("bg-indigo-500");
            track?.classList.remove("bg-zinc-200", "dark:bg-zinc-800");
            handle?.classList.add("translate-x-4");
            pinOrderContainer?.classList.remove("hidden");
        } else {
            track?.classList.remove("bg-indigo-500");
            track?.classList.add("bg-zinc-200", "dark:bg-zinc-800");
            handle?.classList.remove("translate-x-4");
            pinOrderContainer?.classList.add("hidden");
        }
    });

    // Handle Save
    document.getElementById("saveBtn")?.addEventListener("click", async function() {
        const titleEl = document.getElementById("title");
        const slugEl = document.getElementById("slug");
        const saveBtn = document.getElementById("saveBtn");

        const title = titleEl ? titleEl.value : '';
        const slug = slugEl ? slugEl.value : '';

        if (!title || !slug) {
            window.showAdminAlert(t.requiredFields || "Title and Slug are required", "warning");
            return;
        }

        if (!vditor) {
            window.showAdminAlert("Editor not initialized", "error");
            return;
        }

        const content = vditor.getValue();
        if (!content) {
            window.showAdminAlert(t.contentEmpty || "Content is empty", "warning");
            return;
        }

        const categoryEl = document.getElementById("category");
        const selectedTagsEl = document.getElementById("selectedTags");
        const descriptionEl = document.getElementById("description");
        const imageEl = document.getElementById("image");
        const passwordEl = document.getElementById("password");
        const pinOrderEl = document.getElementById("pinOrder");

        // 获取选中的标签名称
        const tagsValue = selectedTagsEl ? selectedTagsEl.value : '';
        const tagsArray = tagsValue ? tagsValue.split(',').map(function(t) { return t.trim(); }).filter(function(t) { return t; }) : [];

        const postData = {
            title,
            slug,
            category_name: categoryEl ? categoryEl.value || "General" : "General",
            tags: tagsArray,
            description: descriptionEl ? descriptionEl.value : "",
            content,
            image: imageEl ? imageEl.value || "" : "",
            password: passwordEl ? passwordEl.value || "" : "",
            is_draft: isDraft,
            pinned: isPinned,
            pin_order: pinOrderEl ? parseInt(pinOrderEl.value) || 0 : 0,
        };

        const token = localStorage.getItem("adminToken");
        if (!token) {
            window.location.href = "/admin/login";
            return;
        }

        try {
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML =
                    '<span class="animate-spin inline-block mr-2">◌</span> ' + (saveBtn.dataset.publishingText || 'Publishing...');
            }

            const result = await window.adminRequest(`${API_URL}/posts`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token,
                },
                body: JSON.stringify(postData),
            });

            if (result.ok) {
                window.location.href = "/admin/posts";
            } else {
                window.showAdminAlert(
                    (t.saveFailed || "Save failed") + ": " + (result.msg || "Unknown error"),
                    "error",
                );
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = saveBtn.dataset.publishText || "Publish Post";
                }
            }
        } catch (err) {
            console.error(err);
            window.showAdminAlert(t.saveFailed || "An error occurred while saving.", "error");
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = saveBtn.dataset.publishText || "Publish Post";
            }
        }
    });

    // 页面离开时清理
    window.addEventListener("beforeunload", function() {
        window._newPageVditorInitialized = false;
        if (window._newPageVditor) {
            try {
                window._newPageVditor.destroy();
            } catch (e) {
                console.log("Vditor destroy error:", e);
            }
            window._newPageVditor = null;
        }
    });

    // 启动初始化
    initVditor();
    loadCategories();
    loadTags();
}
</script>

<style is:global>
    .admin-input {
        @apply w-full px-4 py-3 bg-white dark:bg-zinc-900/80 border border-zinc-200 dark:border-zinc-700/50 rounded-xl text-sm text-zinc-900 dark:text-zinc-100 outline-none transition-all duration-300 placeholder:text-zinc-400 dark:placeholder:text-zinc-500;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
    }

    .admin-input:hover {
        @apply border-zinc-300 dark:border-zinc-600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .admin-input:focus {
        @apply border-indigo-400 dark:border-indigo-500/70 ring-4 ring-indigo-500/10 dark:ring-indigo-500/20;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    /* 暗色模式下的炫光效果 */
    .dark .admin-input:focus {
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15), 0 0 20px rgba(99, 102, 241, 0.2);
    }

    /* 输入框有内容时的样式 */
    .admin-input:not(:placeholder-shown) {
        @apply border-zinc-300 dark:border-zinc-600;
    }

    /* 密码输入框特殊样式 */
    input[type="password"].admin-input {
        letter-spacing: 0.1em;
    }

    /* 数字输入框样式 */
    input[type="number"].admin-input {
        -moz-appearance: textfield;
    }

    input[type="number"].admin-input::-webkit-outer-spin-button,
    input[type="number"].admin-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* 文本域样式增强 */
    textarea.admin-input {
        @apply resize-none;
        min-height: 80px;
    }

    textarea.admin-input:focus {
        min-height: 100px;
    }

    /* 下拉选择框样式 */
    select.admin-input {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.75rem center;
        background-repeat: no-repeat;
        background-size: 1.25em 1.25em;
        padding-right: 2.5rem;
        cursor: pointer;
    }

    select.admin-input option {
        @apply py-2 px-4 bg-white dark:bg-zinc-900;
    }

    /* 自定义分类选择器样式 */
    .category-selector {
        @apply relative;
    }

    .category-selector-trigger {
        @apply w-full px-4 py-3 bg-white dark:bg-zinc-900/80 border border-zinc-200 dark:border-zinc-700/50 rounded-xl text-sm text-zinc-900 dark:text-zinc-100 cursor-pointer transition-all duration-300 flex items-center justify-between;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
    }

    .category-selector-trigger:hover {
        @apply border-zinc-300 dark:border-zinc-600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .category-selector.open .category-selector-trigger {
        @apply border-indigo-400 dark:border-indigo-500/70 ring-4 ring-indigo-500/10 dark:ring-indigo-500/20;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    .dark .category-selector.open .category-selector-trigger {
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15), 0 0 20px rgba(99, 102, 241, 0.2);
    }

    .category-selector.open #categoryArrow {
        transform: rotate(180deg);
    }

    .category-selector-value {
        @apply truncate;
    }

    .category-selector-value.placeholder {
        @apply text-zinc-400 dark:text-zinc-500;
    }

    .category-selector-dropdown {
        @apply absolute top-full left-0 right-0 mt-2 bg-white/95 dark:bg-zinc-900/95 border border-zinc-200 dark:border-zinc-700/50 rounded-xl overflow-hidden z-50;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(12px);
        animation: dropdownFadeIn 0.2s ease-out;
    }

    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .category-search-wrapper {
        @apply flex items-center gap-2 px-4 py-3 border-b border-zinc-100 dark:border-zinc-800/50;
    }

    .category-search-input {
        @apply flex-1 bg-transparent text-sm text-zinc-900 dark:text-zinc-100 outline-none placeholder:text-zinc-400;
    }

    .category-options {
        @apply max-h-[200px] overflow-y-auto;
    }

    .category-option {
        @apply flex items-center gap-3 px-4 py-3 cursor-pointer transition-all duration-200;
    }

    .category-option:hover {
        @apply bg-zinc-50 dark:bg-zinc-800/50;
    }

    .category-option.selected {
        @apply bg-indigo-50 dark:bg-indigo-900/30;
    }

    .category-option-color {
        @apply w-3 h-3 rounded-full flex-shrink-0;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5), 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .category-option-name {
        @apply text-sm text-zinc-700 dark:text-zinc-300 flex-1;
    }

    .category-option.selected .category-option-name {
        @apply text-indigo-600 dark:text-indigo-400 font-medium;
    }

    .category-option-check {
        @apply w-4 h-4 text-indigo-500 opacity-0 transition-opacity;
    }

    .category-option.selected .category-option-check {
        @apply opacity-100;
    }

    .category-empty {
        @apply px-4 py-6 text-center text-sm text-zinc-400;
    }

    /* 标签选择器容器样式 */
    .tags-selector {
        @apply flex flex-wrap gap-2 p-4 bg-white/80 dark:bg-zinc-900/80 border border-zinc-200 dark:border-zinc-700/50 rounded-xl min-h-[60px] transition-all duration-300;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
    }

    .tags-selector:hover {
        @apply border-zinc-300 dark:border-zinc-600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .tags-selector:focus-within {
        @apply border-indigo-400 dark:border-indigo-500/70 ring-4 ring-indigo-500/10 dark:ring-indigo-500/20;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    .dark .tags-selector:focus-within {
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15), 0 0 20px rgba(99, 102, 241, 0.2);
    }

    /* 标签按钮样式 */
    .tag-btn {
        @apply px-3 py-1.5 text-xs font-medium rounded-full border-2 transition-all duration-200 cursor-pointer select-none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .tag-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .tag-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        @apply bg-transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        @apply bg-zinc-200 dark:bg-zinc-800 rounded-full;
    }
</style>

<style is:global>
    /* 修复 Vditor 编辑器样式问题 */

    #vditor.vditor {
        border: none !important;
        background-color: #fff !important;
    }

    .dark #vditor.vditor {
        background-color: #18181b !important;
    }

    #vditor .vditor-reset {
        color: #18181b !important;
    }

    .dark #vditor .vditor-reset {
        color: #f4f4f5 !important;
    }

    /* 光标颜色 */
    #vditor.vditor--ir .vditor-reset,
    #vditor.vditor--wysiwyg .vditor-reset,
    #vditor.vditor--sv .vditor-reset {
        caret-color: #18181b !important;
    }

    .dark #vditor.vditor--ir .vditor-reset,
    .dark #vditor.vditor--wysiwyg .vditor-reset,
    .dark #vditor.vditor--sv .vditor-reset {
        caret-color: #f4f4f5 !important;
    }

    /* 确保空行时光标可见 - 设置最小行高和光标样式 */
    #vditor .vditor-ir .vditor-reset {
        min-height: 1.5em !important;
        line-height: 1.75 !important;
        caret-color: #18181b !important;
        caret-shape: bar !important;
    }

    .dark #vditor .vditor-ir .vditor-reset {
        caret-color: #f4f4f5 !important;
    }

    /* 空段落样式 */
    #vditor .vditor-ir .vditor-reset p:empty::before,
    #vditor .vditor-ir .vditor-reset > br {
        content: '';
        display: inline-block;
        min-height: 1.5em;
    }

    /* 工具栏样式 */
    #vditor .vditor-toolbar {
        background-color: #fafafa !important;
        border-bottom: 1px solid #e4e4e7 !important;
    }

    .dark #vditor .vditor-toolbar {
        background-color: #27272a !important;
        border-bottom: 1px solid #3f3f46 !important;
    }

    #vditor .vditor-toolbar__item svg {
        color: #71717a !important;
    }

    .dark #vditor .vditor-toolbar__item svg {
        color: #a1a1aa !important;
    }

    #vditor .vditor-toolbar__item:hover svg {
        color: #18181b !important;
    }

    .dark #vditor .vditor-toolbar__item:hover svg {
        color: #f4f4f5 !important;
    }

    /* 内容区域 */
    #vditor .vditor-content {
        background-color: #fff !important;
    }

    .dark #vditor .vditor-content {
        background-color: #18181b !important;
    }

    /* IR 模式下的代码块 */
    #vditor .vditor-ir pre.vditor-reset {
        background-color: #f4f4f5 !important;
    }

    .dark #vditor .vditor-ir pre.vditor-reset {
        background-color: #27272a !important;
    }

    /* 行号 */
    #vditor .vditor-linenumber {
        color: #a1a1aa !important;
    }

    .dark #vditor .vditor-linenumber {
        color: #71717a !important;
    }

    /* 计数器 */
    #vditor .vditor-counter {
        color: #71717a !important;
        background-color: transparent !important;
    }

    .dark #vditor .vditor-counter {
        color: #a1a1aa !important;
    }

    /* placeholder */
    #vditor .vditor-reset::before {
        color: #a1a1aa !important;
    }

    .dark #vditor .vditor-reset::before {
        color: #71717a !important;
    }

    /* 确保 IR 模式下内容可见 */
    #vditor .vditor-ir__node {
        color: inherit !important;
    }

    #vditor .vditor-ir__marker {
        color: #a1a1aa !important;
    }

    .dark #vditor .vditor-ir__marker {
        color: #71717a !important;
    }
</style>

<style is:global>
    /* WYSIWYG 模式样式 */
    #vditor .vditor-wysiwyg {
        color: #18181b !important;
        caret-color: #18181b !important;
        background-color: #fff !important;
    }

    .dark #vditor .vditor-wysiwyg {
        color: #f4f4f5 !important;
        caret-color: #f4f4f5 !important;
        background-color: #18181b !important;
    }

    #vditor .vditor-wysiwyg p,
    #vditor .vditor-wysiwyg h1,
    #vditor .vditor-wysiwyg h2,
    #vditor .vditor-wysiwyg h3,
    #vditor .vditor-wysiwyg h4,
    #vditor .vditor-wysiwyg h5,
    #vditor .vditor-wysiwyg h6,
    #vditor .vditor-wysiwyg li,
    #vditor .vditor-wysiwyg blockquote {
        color: inherit !important;
    }

    .dark #vditor .vditor-wysiwyg p,
    .dark #vditor .vditor-wysiwyg h1,
    .dark #vditor .vditor-wysiwyg h2,
    .dark #vditor .vditor-wysiwyg h3,
    .dark #vditor .vditor-wysiwyg h4,
    .dark #vditor .vditor-wysiwyg h5,
    .dark #vditor .vditor-wysiwyg h6,
    .dark #vditor .vditor-wysiwyg li,
    .dark #vditor .vditor-wysiwyg blockquote {
        color: #f4f4f5 !important;
    }
</style>

<style is:global>
    /* 强制光标可见 - 使用主题色 */
    #vditor .vditor-ir .vditor-reset,
    #vditor .vditor-ir .vditor-reset * {
        caret-color: var(--primary) !important;
    }

    .dark #vditor .vditor-ir .vditor-reset,
    .dark #vditor .vditor-ir .vditor-reset * {
        caret-color: var(--primary) !important;
    }

    /* 确保 contenteditable 元素光标可见 */
    #vditor [contenteditable="true"] {
        caret-color: var(--primary) !important;
    }

    .dark #vditor [contenteditable="true"] {
        caret-color: var(--primary) !important;
    }
</style>
