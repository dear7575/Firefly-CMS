---
import { render } from "astro:content";
import * as path from "node:path";
import Comment from "@components/comment/index.astro";
import License from "@components/misc/License.astro";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPosts } from "@utils/content-utils";
import {
  getFileDirFromPath,
  getPostUrlBySlug,
  removeFileExtension,
} from "@utils/url-utils";
import { Icon } from "astro-icon/components";
import PostMetadata from "@/components/content/PostMeta.astro";
import RandomCoverImage from "@/components/misc/RandomCoverImage.astro";
import SharePoster from "@/components/misc/SharePoster.svelte";
import { coverImageConfig } from "@/config/coverImageConfig";
import { licenseConfig } from "@/config/licenseConfig";
import { profileConfig } from "@/config/profileConfig";
import { siteConfig } from "@/config/siteConfig";
import { sponsorConfig } from "@/config/sponsorConfig";
import { formatDateToYYYYMMDD } from "@/utils/date-utils";
import { processCoverImageSync } from "@/utils/image-utils";
import { url } from "@/utils/url-utils";
import { fetchSiteSettings } from "@/services/siteSettings";
import { marked, Renderer } from "marked";
import hljs from "highlight.js";
import { getApiUrl } from "@/utils/api-utils";

const API_URL = getApiUrl();

export const prerender = false;

// 获取动态配置
let dynamicSettings: Record<string, any> = {};
try {
  dynamicSettings = await fetchSiteSettings();
} catch (error) {
  console.warn("无法获取动态配置，使用静态配置");
}

// 获取作者信息（动态配置优先）
const authorName = dynamicSettings.profile_name || profileConfig.name;
const authorAvatar = dynamicSettings.profile_avatar || profileConfig.avatar;
const dynamicSiteTitle = dynamicSettings.site_title || siteConfig.title;

// 文章详情页配置（动态配置优先）
const showLastModified =
  dynamicSettings.post_show_last_modified ??
  siteConfig.showLastModified ??
  true;
const outdatedThreshold =
  dynamicSettings.post_outdated_threshold ?? siteConfig.outdatedThreshold ?? 30;
const showToc = dynamicSettings.post_show_toc ?? true;
const showUpdated = dynamicSettings.post_show_updated ?? true;

// 配置 marked 为标题添加 id 属性
const slugCount: Record<string, number> = {};

function generateSlug(text: string): string {
  let slug = text
    .toLowerCase()
    .replace(/[^\w\u4e00-\u9fa5\s-]/g, "") // 保留中文、字母、数字、空格、连字符
    .replace(/\s+/g, "-") // 空格转连字符
    .replace(/-+/g, "-"); // 多个连字符合并

  // 处理重复的 slug
  if (slugCount[slug]) {
    slugCount[slug]++;
    slug = `${slug}-${slugCount[slug] - 1}`;
  } else {
    slugCount[slug] = 1;
  }

  return slug;
}

const renderer = new Renderer();
renderer.heading = function ({ tokens, depth }) {
  const text = this.parser.parseInline(tokens);
  // 提取纯文本用于生成 slug
  const plainText = text.replace(/<[^>]*>/g, "");
  const slug = generateSlug(plainText);
  return `<h${depth} id="${slug}">${text}</h${depth}>\n`;
};

// 自定义代码块渲染 - 添加语法高亮
renderer.code = function({ text, lang }) {
  const language = lang && hljs.getLanguage(lang) ? lang : 'plaintext';
  const highlighted = hljs.highlight(text, { language }).value;
  const langLabel = lang || 'text';

  // 复制图标 SVG - 与静态页面结���一致
  const copyIcon = `<svg viewBox="0 -960 960 960" xmlns="http://www.w3.org/2000/svg" class="copy-btn-icon copy-icon"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"/></svg>`;
  const successIcon = `<svg viewBox="0 -960 960 960" xmlns="http://www.w3.org/2000/svg" class="copy-btn-icon success-icon"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"/></svg>`;

  return `<figure class="expressive-code-dynamic">
    <figcaption class="header">
      <span class="title">${langLabel}</span>
    </figcaption>
    <pre><code class="hljs language-${language}">${highlighted}</code></pre>
    <button type="button" class="copy-btn" aria-label="复制代码"><div class="copy-btn-icon-wrapper">${copyIcon}${successIcon}</div></button>
  </figure>`;
};

marked.use({ renderer });

const { slug } = Astro.params;
const blogEntries = await getSortedPosts();
// 匹配逻辑：支持静态文章（移除 .md 扩展名）和动态文章（移除 dynamic- 前缀）
const entry = blogEntries.find((e) => {
  const cleanId = removeFileExtension(e.id).replace(/^dynamic-/, "");
  return cleanId === slug;
});

if (!entry) {
  return new Response(null, {
    status: 404,
    statusText: "Not Found",
  });
}

// Check if post is password protected
const hasPassword = entry.data.has_password || false;
const postId =
  (entry.data as any).dbId ||
  (entry.id.startsWith("dynamic-") ? entry.id.replace("dynamic-", "") : null);

let Content: any;
let isDynamic = false;
let headings: any[] = [];
let remarkPluginFrontmatter: any = { words: 0, minutes: 0 };

if (entry.id.startsWith("dynamic-")) {
  // For dynamic posts from DB
  isDynamic = true;

  // 先从 Markdown 内容中提取标题生成目录
  const content = entry.data.content || "";
  const headingRegex = /^(#{1,6})\s+(.+)$/gm;
  let match;

  // 重置 slug 计数器
  Object.keys(slugCount).forEach((key) => delete slugCount[key]);

  while ((match = headingRegex.exec(content)) !== null) {
    const depth = match[1].length;
    const text = match[2].trim();
    const slug = generateSlug(text);

    headings.push({
      depth,
      slug,
      text,
    });
  }

  // 重置 slug 计数器，让 marked 渲染时生成相同的 slug
  Object.keys(slugCount).forEach((key) => delete slugCount[key]);

  // 渲染 Markdown
  Content = await marked.parse(content);

  // Simple estimation for dynamic posts
  const words = content.split(/\s+/).length;
  remarkPluginFrontmatter = {
    words,
    minutes: Math.ceil(words / 200),
  };
} else {
  // For static posts from collection
  const rendered = await render(entry);
  Content = rendered.Content;
  headings = rendered.headings;
  remarkPluginFrontmatter = rendered.remarkPluginFrontmatter;
}

// 处理随机图：如果image为"api"，则从配置的API获取随机图
const processedImage = processCoverImageSync(entry.data.image, entry.id);

let posterCoverUrl = processedImage;
if (processedImage) {
  const isLocal = !(
    processedImage.startsWith("/") ||
    processedImage.startsWith("http") ||
    processedImage.startsWith("https") ||
    processedImage.startsWith("data:")
  );
  if (isLocal) {
    const basePath = getFileDirFromPath(entry.filePath || "");
    const files = import.meta.glob<ImageMetadata>("../../**", {
      import: "default",
    });
    let normalizedPath = path
      .normalize(path.join("../../", basePath, processedImage))
      .replace(/\\/g, "/");
    const file = files[normalizedPath];
    if (file) {
      const img = await file();
      posterCoverUrl = img.src;
    }
  }
}

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: entry.data.title,
  description: entry.data.description || entry.data.title,
  keywords: entry.data.tags,
  author: {
    "@type": "Person",
    name: authorName,
    url: Astro.site,
  },
  datePublished: formatDateToYYYYMMDD(entry.data.published),
  inLanguage: entry.data.lang
    ? entry.data.lang.replace("_", "-")
    : siteConfig.lang.replace("_", "-"),
  // TODO include cover image here
};
---

<MainGridLayout
  banner={processedImage}
  title={entry.data.title}
  description={entry.data.description}
  lang={entry.data.lang}
  setOGTypeArticle={true}
  postSlug={entry.id}
  headings={headings}
>
  <script
    is:inline
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify(jsonLd)}
  />
  <div
    class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4"
  >
    <!-- Password Protection Overlay -->
    {
      hasPassword && postId && (
        <div
          id="password-overlay"
          data-post-id={postId}
          class="absolute inset-0 z-50 bg-white/95 dark:bg-black/95 backdrop-blur-md flex items-center justify-center"
        >
          <div class="card-base p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-[var(--primary)]/10 mb-4">
                <svg
                  class="w-8 h-8 text-[var(--primary)]"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <h2 class="text-2xl font-bold text-black/90 dark:text-white/90 mb-2">
                受保护的帖子
              </h2>
              <p class="text-sm text-black/60 dark:text-white/60">
                请输入密码才能查看此内容
              </p>
            </div>
            <form id="password-form" class="space-y-4">
              <div>
                <input
                  type="password"
                  id="post-password"
                  placeholder="Password"
                  class="w-full px-4 py-3 rounded-lg border border-black/10 dark:border-white/10 bg-white dark:bg-black/50 text-black/90 dark:text-white/90 focus:outline-none focus:ring-2 focus:ring-[var(--primary)] transition-all"
                  autocomplete="off"
                />
              </div>
              <div id="password-error" class="text-sm text-red-500 hidden" />
              <button
                type="submit"
                class="w-full px-6 py-3 bg-[var(--primary)] text-white dark:text-black/70 rounded-lg font-medium hover:opacity-90 active:scale-95 transition-all"
              >
                解锁
              </button>
            </form>
          </div>
        </div>
      )
    }

    <div
      id="post-container"
      class:list={[
        "card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full ",
        { "blur-sm pointer-events-none": hasPassword },
      ]}
    >
      <!-- word count and reading time -->
      <div
        class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation"
      >
        <div class="flex flex-row items-center">
          <div
            class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
          >
            <Icon name="material-symbols:notes-rounded" />
          </div>
          <div class="text-sm">
            {remarkPluginFrontmatter.words}
            {" " + i18n(I18nKey.wordsCount)}
          </div>
        </div>
        <div class="flex flex-row items-center">
          <div
            class="transition h-6 w-6 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center mr-2"
          >
            <Icon name="material-symbols:schedule-outline-rounded" />
          </div>
          <div class="text-sm">
            {remarkPluginFrontmatter.minutes}
            {
              " " +
                i18n(
                  remarkPluginFrontmatter.minutes === 1
                    ? I18nKey.minuteCount
                    : I18nKey.minutesCount,
                )
            }
          </div>
        </div>
      </div>

      <!-- title -->
      <div class="relative onload-animation">
        <h1
          data-pagefind-body
          data-pagefind-weight="10"
          data-pagefind-meta="title"
          class="transition w-full block font-bold mb-3
                    text-3xl md:text-[2.25rem]/[2.75rem]
                    text-black/90 dark:text-white/90
                    md:before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
                    before:absolute before:top-[0.75rem] before:left-[-1.125rem]"
        >
          {entry.data.title}
        </h1>
      </div>

      <!-- metadata -->
      <div class="onload-animation">
        <PostMetadata
          className="mb-5"
          published={entry.data.published}
          updated={entry.data.updated}
          tags={entry.data.tags}
          category={entry.data.category || undefined}
          id={entry.id}
        />
        {
          !processedImage && (
            <div class="border-[var(--line-divider)] border-dashed border-b-[1px] mt-3 mb-5" />
          )
        }
      </div>

      <!-- always show cover as long as it has one -->

      {
        processedImage && coverImageConfig.enableInPost && (
          <div style="margin-top:1rem;">
            <RandomCoverImage
              id="post-cover"
              src={processedImage}
              basePath={getFileDirFromPath(entry.filePath || "")}
              class="mb-8 rounded-xl banner-container onload-animation"
              seed={entry.id}
              preview={false}
            />
          </div>
        )
      }

      <Markdown class="mb-6 markdown-content onload-animation">
        {isDynamic ? <Fragment set:html={Content} /> : <Content />}
      </Markdown>

      {/* 赞助按钮 & 分享按钮 */}
      <div class="mb-6 rounded-xl onload-animation">
        <div class="p-6 bg-[var(--license-block-bg)] rounded-xl">
          <div
            class="flex flex-col sm:flex-row items-center justify-between gap-4"
          >
            <div class="flex items-center gap-3 flex-1">
              <div
                class="h-12 w-12 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70 flex-shrink-0"
              >
                <Icon
                  name={sponsorConfig.showButtonInPost &&
                  siteConfig.pages.sponsor
                    ? "material-symbols:favorite"
                    : "material-symbols:share"}
                  class="text-2xl"
                />
              </div>
              <div>
                <h3
                  class="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-1"
                >
                  {
                    sponsorConfig.showButtonInPost && siteConfig.pages.sponsor
                      ? i18n(I18nKey.sponsorButton)
                      : i18n(I18nKey.shareOnSocial)
                  }
                </h3>
                <p class="text-sm text-neutral-600 dark:text-neutral-400">
                  {
                    sponsorConfig.showButtonInPost && siteConfig.pages.sponsor
                      ? i18n(I18nKey.sponsorButtonText)
                      : i18n(I18nKey.shareOnSocialDescription)
                  }
                </p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <SharePoster
                client:load
                title={entry.data.title}
                author={authorName}
                description={entry.data.description || entry.data.title}
                pubDate={formatDateToYYYYMMDD(entry.data.published)}
                coverImage={posterCoverUrl}
                url={Astro.url.href}
                siteTitle={dynamicSiteTitle}
                avatar={authorAvatar}
              />
              {
                sponsorConfig.showButtonInPost && siteConfig.pages.sponsor && (
                  <a
                    href={url("/sponsor/")}
                    class="inline-flex items-center gap-2 px-6 py-3 bg-[var(--primary)] text-white dark:text-black/70 rounded-lg font-medium hover:bg-[var(--primary)]/80 hover:scale-105 active:scale-95 transition-all whitespace-nowrap"
                  >
                    <span>{i18n(I18nKey.sponsor)}</span>
                    <Icon name="fa6-solid:arrow-right" class="text-sm" />
                  </a>
                )
              }
            </div>
          </div>
        </div>
      </div>

      {
        licenseConfig.enable && (
          <License
            title={entry.data.title}
            id={entry.id}
            pubDate={entry.data.published}
            author={entry.data.author || authorName}
            sourceLink={entry.data.sourceLink}
            licenseName={entry.data.licenseName}
            licenseUrl={entry.data.licenseUrl}
            class="mb-6 rounded-xl license-container onload-animation"
          />
        )
      }
    </div>
  </div>

  <!-- 上次编辑时间 -->
  {
    showLastModified &&
      (() => {
        const lastModifiedDate = new Date(entry.data.updated || entry.data.published);
        const now = new Date();
        const daysDiff = Math.floor((now.getTime() - lastModifiedDate.getTime()) / (1000 * 60 * 60 * 24));
        // 使用动态配置的阈值
        const shouldShowOutdatedCard = daysDiff >= outdatedThreshold;

        return shouldShowOutdatedCard ? (
          <div class="card-base p-6 mb-4">
            <div class="flex items-center gap-2">
              <div class="transition h-9 w-9 rounded-lg overflow-hidden relative flex items-center justify-center mr-0">
                <Icon
                  name="material-symbols:history-rounded"
                  class="text-4xl text-[var(--primary)] transition-transform group-hover:translate-x-0.5 bg-[var(--enter-btn-bg)] p-2 rounded-md"
                />
              </div>

              {(() => {
                const dateStr = lastModifiedDate.toISOString().split('T')[0];
                const isOutdated = daysDiff >= 1;

                return (
                  <div class="flex flex-col gap-0.1">
                    <div class="text-[1.0rem] leading-tight text-black/75 dark:text-white/75">
                      {`${i18n(I18nKey.lastModifiedPrefix)}${dateStr}${
                        isOutdated
                          ? `，${i18n(I18nKey.lastModifiedDaysAgo).replace("{days}", daysDiff.toString())}`
                          : ""
                      }`}
                    </div>
                    {isOutdated && (
                      <p class="text-[0.8rem] leading-tight text-black/75 dark:text-white/75">
                        {i18n(I18nKey.lastModifiedOutdated)}
                      </p>
                    )}
                  </div>
                );
              })()}
            </div>
          </div>
        ) : null;
      })()
  }

  <div
    class="flex flex-col md:flex-row justify-between mb-4 gap-4 overflow-hidden w-full"
  >
    <a
      href={entry.data.nextSlug ? getPostUrlBySlug(entry.data.nextSlug) : "#"}
      class:list={[
        "w-full font-bold overflow-hidden active:scale-95",
        { "pointer-events-none": !entry.data.nextSlug },
      ]}
    >
      {
        entry.data.nextSlug && (
          <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-start gap-4">
            <Icon
              name="material-symbols:chevron-left-rounded"
              class="text-[2rem] text-[var(--primary)]"
            />
            <div class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
              {entry.data.nextTitle}
            </div>
          </div>
        )
      }
    </a>

    <a
      href={entry.data.prevSlug ? getPostUrlBySlug(entry.data.prevSlug) : "#"}
      class:list={[
        "w-full font-bold overflow-hidden active:scale-95",
        { "pointer-events-none": !entry.data.prevSlug },
      ]}
    >
      {
        entry.data.prevSlug && (
          <div class="btn-card rounded-2xl w-full h-[3.75rem] max-w-full px-4 flex items-center !justify-end gap-4">
            <div class="overflow-hidden transition overflow-ellipsis whitespace-nowrap max-w-[calc(100%_-_3rem)] text-black/75 dark:text-white/75">
              {entry.data.prevTitle}
            </div>
            <Icon
              name="material-symbols:chevron-right-rounded"
              class="text-[2rem] text-[var(--primary)]"
            />
          </div>
        )
      }
    </a>
  </div>

  <!-- 评论 -->
  <Comment post={entry} />
</MainGridLayout>

<script>
  const overlay = document.getElementById("password-overlay");
  const form = document.getElementById("password-form");
  const postContainer = document.getElementById("post-container");
  const errorDiv = document.getElementById("password-error");

  if (overlay && form) {
    const postId = overlay.dataset.postId;
    const storageKey = `post-password-${postId}`;

    // Check if password is already stored
    const storedPassword = sessionStorage.getItem(storageKey);
    if (storedPassword && postId) {
      // Validate stored password
      validatePassword(postId, storedPassword, true);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const passwordInput = document.getElementById(
        "post-password",
      ) as HTMLInputElement;
      const password = passwordInput.value;

      if (!password) {
        showError("Please enter a password");
        return;
      }

      if (postId) {
        await validatePassword(postId, password, false);
      }
    });

    async function validatePassword(
      postId: string,
      password: string,
      silent: boolean,
    ) {
      try {
        const response = await fetch(
          `${(window as any).API_URL}/posts/${postId}/verify-password`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password }),
          },
        );

        if (!response.ok) {
          if (!silent) showError("Failed to verify password");
          return;
        }

        const payload = await response.json();
        const data = payload && payload.data !== undefined ? payload.data : payload;

        if (data.valid) {
          // Password correct - store and reveal content
          sessionStorage.setItem(storageKey, password);
          overlay?.classList.add("opacity-0", "pointer-events-none");
          postContainer?.classList.remove("blur-sm", "pointer-events-none");
          setTimeout(() => overlay?.remove(), 300);
        } else {
          if (!silent) {
            showError("Incorrect password");
            sessionStorage.removeItem(storageKey);
          }
        }
      } catch (err) {
        console.error("Password validation error:", err);
        if (!silent) showError("An error occurred");
      }
    }

    function showError(message: string) {
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove("hidden");
        setTimeout(() => errorDiv.classList.add("hidden"), 3000);
      }
    }
  }
</script>

<style>
  #password-overlay {
    transition: opacity 0.3s ease;
  }
</style>

<script>
  // 动态代码块复制按钮事件
  function initDynamicCodeCopy() {
    document.querySelectorAll('.expressive-code-dynamic .copy-btn').forEach(btn => {
      // 避免重复绑定
      if (btn.dataset.copyBound) return;
      btn.dataset.copyBound = 'true';

      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();

        const figure = this.closest('.expressive-code-dynamic');
        const codeEl = figure?.querySelector('code');

        if (codeEl) {
          const code = codeEl.textContent || '';

          try {
            // 优先使用 clipboard API
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(code);
            } else {
              // fallback: 使用 textarea
              const textarea = document.createElement('textarea');
              textarea.value = code;
              textarea.style.position = 'fixed';
              textarea.style.left = '-9999px';
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
            }

            // 切换图标 - 使用 success 类（与静态页面一致）
            this.classList.add('success');

            setTimeout(() => {
              this.classList.remove('success');
            }, 2000);
          } catch (err) {
            console.error('复制失败:', err);
            // 最后的 fallback
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand('copy');
              this.classList.add('success');
              setTimeout(() => {
                this.classList.remove('success');
              }, 2000);
            } catch (e2) {
              console.error('execCommand 复制也失败:', e2);
            }
            document.body.removeChild(textarea);
          }
        }
      });
    });
  }

  // 页面加载时初始化
  document.addEventListener('astro:page-load', initDynamicCodeCopy);
  // 首次加载也执行
  if (document.readyState === 'complete') {
    initDynamicCodeCopy();
  } else {
    document.addEventListener('DOMContentLoaded', initDynamicCodeCopy);
  }
</script>
